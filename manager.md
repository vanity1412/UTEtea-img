# ğŸ“š MANAGER MODULE - TÃ€I LIá»†U Há»ŒC Táº¬P CHI TIáº¾T

## ğŸ“‹ Má»¤C Lá»¤C

1. [Tá»•ng Quan Chá»©c NÄƒng Manager](#1-tá»•ng-quan-chá»©c-nÄƒng-manager)
2. [Kiáº¿n TrÃºc Há»‡ Thá»‘ng](#2-kiáº¿n-trÃºc-há»‡-thá»‘ng)
3. [Quáº£n LÃ½ ÄÆ¡n HÃ ng](#3-quáº£n-lÃ½-Ä‘Æ¡n-hÃ ng)
4. [Quáº£n LÃ½ NgÆ°á»i DÃ¹ng](#4-quáº£n-lÃ½-ngÆ°á»i-dÃ¹ng)
5. [Quáº£n LÃ½ Cá»­a HÃ ng](#5-quáº£n-lÃ½-cá»­a-hÃ ng)
6. [Dashboard & Thá»‘ng KÃª](#6-dashboard--thá»‘ng-kÃª)
7. [Dá»± BÃ¡o & PhÃ¢n TÃ­ch](#7-dá»±-bÃ¡o--phÃ¢n-tÃ­ch)
8. [Whitelist IP - Báº£o Máº­t NÃ¢ng Cao](#8-whitelist-ip---báº£o-máº­t-nÃ¢ng-cao)
9. [Há»‡ Thá»‘ng GiÃ¡m SÃ¡t (Monitoring)](#9-há»‡-thá»‘ng-giÃ¡m-sÃ¡t-monitoring)
10. [Luá»“ng Logic Chi Tiáº¿t](#10-luá»“ng-logic-chi-tiáº¿t)
11. [Giáº£i ThÃ­ch Code](#11-giáº£i-thÃ­ch-code)
12. [API Reference](#12-api-reference)
13. [CÃ¢u Há»i Phá»ng Váº¥n](#13-cÃ¢u-há»i-phá»ng-váº¥n)

---

## 1. Tá»”NG QUAN CHá»¨C NÄ‚NG MANAGER

### 1.1 Vai TrÃ² Trong Há»‡ Thá»‘ng
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Há»† THá»NG UTE TEA                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ADMIN (Quáº£n trá»‹ viÃªn)                                      â”‚
â”‚  â”œâ”€â”€ Quáº£n lÃ½ Táº¤T Cáº¢ cá»­a hÃ ng                               â”‚
â”‚  â”œâ”€â”€ Quáº£n lÃ½ Táº¤T Cáº¢ ngÆ°á»i dÃ¹ng (bao gá»“m Manager)           â”‚
â”‚  â”œâ”€â”€ PhÃ¢n quyá»n: NÃ¢ng/Háº¡ cáº¥p User â†” Manager                â”‚
â”‚  â”œâ”€â”€ GÃ¡n cá»­a hÃ ng cho Manager                               â”‚
â”‚  â”œâ”€â”€ Quáº£n lÃ½ Whitelist IP                                   â”‚
â”‚  â””â”€â”€ Xem doanh thu backup (user Ä‘Ã£ xÃ³a)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  MANAGER (Quáº£n lÃ½ cá»­a hÃ ng)                                 â”‚
â”‚  â”œâ”€â”€ Quáº£n lÃ½ Ä‘Æ¡n hÃ ng cá»§a Cá»¬A HÃ€NG ÄÆ¯á»¢C GÃN                â”‚
â”‚  â”œâ”€â”€ Quáº£n lÃ½ ngÆ°á»i dÃ¹ng (chá»‰ USER, khÃ´ng Ä‘Æ°á»£c khÃ³a Manager)â”‚
â”‚  â”œâ”€â”€ Quáº£n lÃ½ voucher/khuyáº¿n mÃ£i                             â”‚
â”‚  â”œâ”€â”€ Xem dashboard & thá»‘ng kÃª                               â”‚
â”‚  â”œâ”€â”€ Dá»± bÃ¡o doanh thu, nhÃ¢n sá»±                              â”‚
â”‚  â””â”€â”€ Live Chat vá»›i khÃ¡ch hÃ ng                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  USER (NgÆ°á»i dÃ¹ng)                                          â”‚
â”‚  â””â”€â”€ Äáº·t hÃ ng, thanh toÃ¡n, Ä‘Ã¡nh giÃ¡...                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 PhÃ¢n Quyá»n Chi Tiáº¿t
| Chá»©c nÄƒng | USER | MANAGER | ADMIN |
|-----------|------|---------|-------|
| Xem Ä‘Æ¡n hÃ ng | Cá»§a mÃ¬nh | Cá»§a store Ä‘Æ°á»£c gÃ¡n | Táº¥t cáº£ |
| Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n | âŒ | âœ… (store Ä‘Æ°á»£c gÃ¡n) | âœ… |
| KhÃ³a/Má»Ÿ khÃ³a User | âŒ | âœ… (chá»‰ USER) | âœ… |
| KhÃ³a/Má»Ÿ khÃ³a Manager | âŒ | âŒ | âœ… |
| NÃ¢ng cáº¥p User â†’ Manager | âŒ | âŒ | âœ… |
| GÃ¡n store cho Manager | âŒ | âŒ | âœ… |
| Quáº£n lÃ½ Whitelist IP | âŒ | âŒ | âœ… |
| Xem doanh thu backup | âŒ | âŒ | âœ… |
| Quáº£n lÃ½ voucher/khuyáº¿n mÃ£i | âŒ | âœ… | âœ… |
| Xem dashboard thá»‘ng kÃª | âŒ | âœ… (store Ä‘Æ°á»£c gÃ¡n) | âœ… (táº¥t cáº£) |
| Dá»± bÃ¡o doanh thu | âŒ | âœ… | âœ… |
| Live Chat há»— trá»£ | âŒ | âœ… | âœ… |
| Monitoring & Risk Score | âŒ | âŒ | âœ… |

### 1.3 Luá»“ng Hoáº¡t Äá»™ng ChÃ­nh
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LUá»’NG HOáº T Äá»˜NG MANAGER                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 1. ÄÄ‚NG NHáº¬P â”‚
    â”‚ Manager App  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ JWT Authentication + Whitelist IP Check
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 2. KIá»‚M TRA QUYá»€N & STORE                                    â”‚
    â”‚ - XÃ¡c thá»±c role = MANAGER hoáº·c ADMIN                         â”‚
    â”‚ - Láº¥y danh sÃ¡ch stores Ä‘Æ°á»£c gÃ¡n (náº¿u lÃ  Manager)             â”‚
    â”‚ - ADMIN: quáº£n lÃ½ táº¥t cáº£ stores                               â”‚
    â”‚ - MANAGER: chá»‰ quáº£n lÃ½ stores Ä‘Æ°á»£c gÃ¡n                       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 3. DASHBOARD & THá»NG KÃŠ                                      â”‚
    â”‚ - Xem tá»•ng quan doanh thu, Ä‘Æ¡n hÃ ng                          â”‚
    â”‚ - Top sáº£n pháº©m bÃ¡n cháº¡y                                      â”‚
    â”‚ - Thá»‘ng kÃª theo store (Manager) hoáº·c táº¥t cáº£ (Admin)          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 4. QUáº¢N LÃ ÄÆ N HÃ€NG                                          â”‚
    â”‚ - Xem danh sÃ¡ch Ä‘Æ¡n hÃ ng (filter theo store)                â”‚
    â”‚ - Cáº­p nháº­t tráº¡ng thÃ¡i: PENDING â†’ MAKING â†’ SHIPPING â†’ DONE   â”‚
    â”‚ - Gá»­i notification realtime cho khÃ¡ch hÃ ng                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 5. QUáº¢N LÃ NGÆ¯á»œI DÃ™NG                                        â”‚
    â”‚ - Xem danh sÃ¡ch users                                        â”‚
    â”‚ - KhÃ³a/Má»Ÿ khÃ³a tÃ i khoáº£n USER                                â”‚
    â”‚ - NÃ¢ng cáº¥p User â†’ Manager (chá»‰ Admin)                        â”‚
    â”‚ - GÃ¡n store cho Manager (chá»‰ Admin)                          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 6. TÃNH NÄ‚NG NÃ‚NG CAO                                        â”‚
    â”‚ - Dá»± bÃ¡o doanh thu, giá» cao Ä‘iá»ƒm                             â”‚
    â”‚ - Quáº£n lÃ½ voucher/khuyáº¿n mÃ£i                                 â”‚
    â”‚ - Live Chat há»— trá»£ khÃ¡ch hÃ ng                                â”‚
    â”‚ - Monitoring & Risk Score (chá»‰ Admin)                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 TÃ­nh NÄƒng Ná»•i Báº­t
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TÃNH NÄ‚NG Ná»”I Báº¬T MANAGER MODULE                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    ğŸª QUáº¢N LÃ THEO STORE
    â”œâ”€â”€ Manager chá»‰ quáº£n lÃ½ stores Ä‘Æ°á»£c Admin gÃ¡n
    â”œâ”€â”€ Admin quáº£n lÃ½ táº¥t cáº£ stores
    â”œâ”€â”€ PhÃ¢n quyá»n cháº·t cháº½ theo store
    â””â”€â”€ Dashboard riÃªng biá»‡t theo store

    ğŸ“Š DASHBOARD THÃ”NG MINH
    â”œâ”€â”€ Realtime revenue tracking
    â”œâ”€â”€ Top selling products
    â”œâ”€â”€ Peak hours analysis
    â”œâ”€â”€ Staff recommendations
    â””â”€â”€ Overload warnings

    ğŸ”® Dá»° BÃO & PHÃ‚N TÃCH
    â”œâ”€â”€ Revenue forecasting (7 ngÃ y, 30 ngÃ y)
    â”œâ”€â”€ Peak hours prediction
    â”œâ”€â”€ Low stock warnings
    â”œâ”€â”€ Staffing recommendations
    â””â”€â”€ Growth trend analysis

    ğŸ›¡ï¸ Báº¢O Máº¬T NÃ‚NG CAO
    â”œâ”€â”€ Whitelist IP cho Admin/Manager
    â”œâ”€â”€ Blocked IP tá»± Ä‘á»™ng
    â”œâ”€â”€ Risk scoring system
    â”œâ”€â”€ Brute force detection
    â””â”€â”€ Activity monitoring

    ğŸ’¬ LIVE CHAT Há»– TRá»¢
    â”œâ”€â”€ Chat realtime vá»›i khÃ¡ch hÃ ng
    â”œâ”€â”€ WebSocket connection
    â”œâ”€â”€ Queue management
    â”œâ”€â”€ Chat history
    â””â”€â”€ Transfer between managers

    ğŸ“± REALTIME NOTIFICATIONS
    â”œâ”€â”€ WebSocket cho Ä‘Æ¡n hÃ ng má»›i
    â”œâ”€â”€ Push notifications
    â”œâ”€â”€ Email notifications
    â”œâ”€â”€ Alert system
    â””â”€â”€ Status updates
```

### 1.5 Kiáº¿n TrÃºc PhÃ¢n Quyá»n
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    KIáº¾N TRÃšC PHÃ‚N QUYá»€N                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                         ADMIN                                   â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ â€¢ Quáº£n lÃ½ Táº¤T Cáº¢ stores (khÃ´ng cáº§n gÃ¡n)                 â”‚   â”‚
    â”‚  â”‚ â€¢ getManagedStoreIds() â†’ return null (xem táº¥t cáº£)       â”‚   â”‚
    â”‚  â”‚ â€¢ CÃ³ thá»ƒ nÃ¢ng/háº¡ cáº¥p User â†” Manager                     â”‚   â”‚
    â”‚  â”‚ â€¢ GÃ¡n/bá» gÃ¡n store cho Manager                          â”‚   â”‚
    â”‚  â”‚ â€¢ Quáº£n lÃ½ Whitelist IP                                  â”‚   â”‚
    â”‚  â”‚ â€¢ Xem Monitoring & Risk Score                           â”‚   â”‚
    â”‚  â”‚ â€¢ Xem doanh thu backup (user Ä‘Ã£ xÃ³a)                    â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                        MANAGER                                  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ â€¢ Chá»‰ quáº£n lÃ½ stores Ä‘Æ°á»£c Admin gÃ¡n                     â”‚   â”‚
    â”‚  â”‚ â€¢ getManagedStoreIds() â†’ return [1, 2, 3]              â”‚   â”‚
    â”‚  â”‚ â€¢ CÃ³ thá»ƒ khÃ³a/má»Ÿ USER (khÃ´ng khÃ³a Manager khÃ¡c)         â”‚   â”‚
    â”‚  â”‚ â€¢ Xem dashboard chá»‰ cá»§a stores Ä‘Æ°á»£c gÃ¡n                 â”‚   â”‚
    â”‚  â”‚ â€¢ Quáº£n lÃ½ Ä‘Æ¡n hÃ ng chá»‰ cá»§a stores Ä‘Æ°á»£c gÃ¡n              â”‚   â”‚
    â”‚  â”‚ â€¢ Táº¡o/quáº£n lÃ½ voucher                                   â”‚   â”‚
    â”‚  â”‚ â€¢ Live Chat vá»›i khÃ¡ch hÃ ng                              â”‚   â”‚
    â”‚  â”‚ â€¢ KHÃ”NG xem Monitoring (chá»‰ Admin)                      â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                         USER                                    â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ â€¢ Chá»‰ xem/quáº£n lÃ½ dá»¯ liá»‡u cá»§a chÃ­nh mÃ¬nh                â”‚   â”‚
    â”‚  â”‚ â€¢ Äáº·t hÃ ng, thanh toÃ¡n, Ä‘Ã¡nh giÃ¡                        â”‚   â”‚
    â”‚  â”‚ â€¢ KhÃ´ng cÃ³ quyá»n quáº£n lÃ½                                â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. KIáº¾N TRÃšC Há»† THá»NG

### 2.1 SÆ¡ Äá»“ Kiáº¿n TrÃºc Backend
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ANDROID APP (Kotlin)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ManagerActivity  â”‚  â”‚ManagerSettings  â”‚  â”‚ ManageOrders    â”‚     â”‚
â”‚  â”‚                 â”‚  â”‚ Fragment        â”‚  â”‚ Fragment        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚           â”‚                    â”‚                    â”‚               â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                â”‚                                    â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                    â”‚    RetrofitClient     â”‚                        â”‚
â”‚                    â”‚    (ApiService)       â”‚                        â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ HTTP/HTTPS
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SPRING BOOT BACKEND                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    SECURITY FILTERS                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚BlockedIPFilterâ”‚â†’â”‚JwtAuthFilter â”‚â†’â”‚WhitelistIPFilter â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      CONTROLLERS                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ManagerControllerâ”‚  â”‚WhitelistedIP  â”‚  â”‚ ForecastControllerâ”‚ â”‚ â”‚
â”‚  â”‚  â”‚                â”‚  â”‚ Controller     â”‚  â”‚                 â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚             â”‚                   â”‚                   â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                       SERVICES                                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ ManagerService â”‚  â”‚WhitelistedIP   â”‚  â”‚ ForecastService â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                â”‚  â”‚ Service        â”‚  â”‚                 â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚             â”‚                   â”‚                   â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                     REPOSITORIES                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚OrderRepository â”‚  â”‚WhitelistedIP   â”‚  â”‚ UserRepository  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                â”‚  â”‚ Repository     â”‚  â”‚                 â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚             â”‚                   â”‚                   â”‚               â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                 â–¼                                   â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                    â”‚      MySQL 8.0        â”‚                        â”‚
â”‚                    â”‚   (Database Server)   â”‚                        â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Cáº¥u TrÃºc File Backend
```
Backend_APP/src/main/java/com/utetea/backend/
â”œâ”€â”€ controller/
â”‚   â”œâ”€â”€ ManagerController.java      # API quáº£n lÃ½ cho Manager
â”‚   â””â”€â”€ WhitelistedIPController.java # API quáº£n lÃ½ Whitelist IP
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ ManagerService.java         # Business logic Manager
â”‚   â”œâ”€â”€ WhitelistedIPService.java   # Logic Whitelist IP
â”‚   â””â”€â”€ ForecastService.java        # Dá»± bÃ¡o doanh thu, nhÃ¢n sá»±
â”œâ”€â”€ filter/
â”‚   â”œâ”€â”€ JwtAuthenticationFilter.java # XÃ¡c thá»±c JWT
â”‚   â”œâ”€â”€ BlockedIPFilter.java        # Cháº·n IP bá»‹ block
â”‚   â””â”€â”€ WhitelistIPFilter.java      # Kiá»ƒm tra Whitelist IP
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ User.java                   # Entity User
â”‚   â”œâ”€â”€ Order.java                  # Entity Order
â”‚   â””â”€â”€ WhitelistedIP.java          # Entity Whitelist IP
â””â”€â”€ repository/
    â”œâ”€â”€ UserRepository.java
    â”œâ”€â”€ OrderRepository.java
    â””â”€â”€ WhitelistedIPRepository.java
```

---

## 3. QUáº¢N LÃ ÄÆ N HÃ€NG

### 3.1 Luá»“ng Cáº­p Nháº­t Tráº¡ng ThÃ¡i ÄÆ¡n HÃ ng
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FLOW: Cáº¬P NHáº¬T TRáº NG THÃI ÄÆ N HÃ€NG                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Manager App  â”‚
    â”‚ (Android)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 1. PUT /api/manager/orders/{id}/status?status=MAKING
           â”‚    Header: Authorization: Bearer <JWT>
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    SECURITY FILTERS                          â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
    â”‚  â”‚ BlockedIPFilterâ”‚ â†’ Kiá»ƒm tra IP cÃ³ bá»‹ block khÃ´ng          â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
    â”‚          â”‚ âœ… IP khÃ´ng bá»‹ block                              â”‚
    â”‚          â–¼                                                   â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
    â”‚  â”‚JwtAuthFilter   â”‚ â†’ XÃ¡c thá»±c JWT token                     â”‚
    â”‚  â”‚                â”‚ â†’ Extract username, role tá»« token        â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
    â”‚          â”‚ âœ… Token há»£p lá»‡, role = MANAGER                   â”‚
    â”‚          â–¼                                                   â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
    â”‚  â”‚WhitelistFilter â”‚ â†’ Kiá»ƒm tra IP cÃ³ trong whitelist         â”‚
    â”‚  â”‚                â”‚   (Chá»‰ Ã¡p dá»¥ng cho ADMIN/MANAGER)        â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
    â”‚          â”‚ âœ… IP trong whitelist (hoáº·c tÃ­nh nÄƒng táº¯t)        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   ManagerController                          â”‚
    â”‚  @PutMapping("/orders/{orderId}/status")                     â”‚
    â”‚  @PreAuthorize("hasAnyRole('MANAGER', 'ADMIN')")             â”‚
    â”‚                                                              â”‚
    â”‚  2. Validate status parameter (PENDING, MAKING, DONE...)     â”‚
    â”‚  3. Gá»i managerService.updateOrderStatus(orderId, newStatus) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    ManagerService                            â”‚
    â”‚                                                              â”‚
    â”‚  4. getCurrentManager() â†’ Láº¥y user tá»« SecurityContext        â”‚
    â”‚  5. getManagedStoreIds(manager) â†’ Láº¥y danh sÃ¡ch store IDs    â”‚
    â”‚     - ADMIN: return null (quáº£n lÃ½ táº¥t cáº£)                    â”‚
    â”‚     - MANAGER: return list store IDs Ä‘Æ°á»£c gÃ¡n                â”‚
    â”‚                                                              â”‚
    â”‚  6. orderRepository.findById(orderId) â†’ Láº¥y order            â”‚
    â”‚                                                              â”‚
    â”‚  7. validateStoreAccess(manager, order.store.id)             â”‚
    â”‚     - ADMIN: bá» qua kiá»ƒm tra                                 â”‚
    â”‚     - MANAGER: kiá»ƒm tra order.store.id cÃ³ trong storeIds     â”‚
    â”‚       â†’ Náº¿u khÃ´ng cÃ³ quyá»n: throw BusinessException          â”‚
    â”‚                                                              â”‚
    â”‚  8. orderService.updateOrderStatus(orderId, newStatus)       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     OrderService                             â”‚
    â”‚                                                              â”‚
    â”‚  9. Validate transition há»£p lá»‡:                              â”‚
    â”‚     PENDING â†’ MAKING â†’ SHIPPING â†’ READY â†’ DONE               â”‚
    â”‚     Báº¥t ká»³ â†’ CANCELED                                        â”‚
    â”‚                                                              â”‚
    â”‚  10. order.setStatus(newStatus)                              â”‚
    â”‚  11. orderRepository.save(order)                             â”‚
    â”‚                                                              â”‚
    â”‚  12. Gá»­i thÃ´ng bÃ¡o:                                          â”‚
    â”‚      - WebSocket: notifyOrderStatusChange(order)             â”‚
    â”‚      - Push: oneSignalService.sendToUser(...)                â”‚
    â”‚      - Email: emailService.sendOrderStatusEmail(...)         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                      RESPONSE                                â”‚
    â”‚  {                                                           â”‚
    â”‚    "success": true,                                          â”‚
    â”‚    "message": "Order status updated",                        â”‚
    â”‚    "data": { ...order details... }                           â”‚
    â”‚  }                                                           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Tráº¡ng ThÃ¡i ÄÆ¡n HÃ ng (OrderStatus)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VÃ’NG Äá»œI ÄÆ N HÃ€NG                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ PENDING  â”‚â”€â”€â”€â”€â–¶â”‚  MAKING  â”‚â”€â”€â”€â”€â–¶â”‚ SHIPPING â”‚â”€â”€â”€â”€â–¶â”‚  READY   â”‚
    â”‚ (Chá» xá»­  â”‚     â”‚ (Äang    â”‚     â”‚ (Äang    â”‚     â”‚ (Sáºµn     â”‚
    â”‚  lÃ½)     â”‚     â”‚  pha cháº¿)â”‚     â”‚  giao)   â”‚     â”‚  sÃ ng)   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚                â”‚                â”‚
         â”‚                â”‚                â”‚                â–¼
         â”‚                â”‚                â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   DONE   â”‚
         â”‚                â”‚                            â”‚ (HoÃ n    â”‚
         â”‚                â”‚                            â”‚  thÃ nh)  â”‚
         â”‚                â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚
         â–¼                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       CANCELED           â”‚
    â”‚   (ÄÃ£ há»§y - cÃ³ thá»ƒ      â”‚
    â”‚    há»§y tá»« báº¥t ká»³        â”‚
    â”‚    tráº¡ng thÃ¡i nÃ o)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. QUáº¢N LÃ NGÆ¯á»œI DÃ™NG

### 4.1 Luá»“ng KhÃ³a/Má»Ÿ KhÃ³a TÃ i Khoáº£n
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FLOW: KHÃ“A/Má» KHÃ“A TÃ€I KHOáº¢N                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Manager App  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ PUT /api/manager/users/{userId}/block?blocked=true
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   ManagerController                          â”‚
    â”‚  @PreAuthorize("hasAnyRole('MANAGER', 'ADMIN')")             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    ManagerService                            â”‚
    â”‚                                                              â”‚
    â”‚  1. getCurrentManager() â†’ Láº¥y current user                   â”‚
    â”‚                                                              â”‚
    â”‚  2. userRepository.findById(userId) â†’ Láº¥y target user        â”‚
    â”‚                                                              â”‚
    â”‚  3. KIá»‚M TRA QUYá»€N:                                          â”‚
    â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚     â”‚ if (targetUser.role == ADMIN)                       â”‚  â”‚
    â”‚     â”‚   â†’ throw "KhÃ´ng thá»ƒ khÃ³a tÃ i khoáº£n Admin"          â”‚  â”‚
    â”‚     â”‚                                                     â”‚  â”‚
    â”‚     â”‚ if (currentUser.role == MANAGER &&                  â”‚  â”‚
    â”‚     â”‚     targetUser.role == MANAGER)                     â”‚  â”‚
    â”‚     â”‚   â†’ throw "Manager khÃ´ng cÃ³ quyá»n khÃ³a Manager khÃ¡c"â”‚  â”‚
    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                              â”‚
    â”‚  4. user.setIsBlocked(blocked)                               â”‚
    â”‚     user.setActive(!blocked)                                 â”‚
    â”‚                                                              â”‚
    â”‚  5. userRepository.save(user)                                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Luá»“ng NÃ¢ng Cáº¥p User â†’ Manager (CHá»ˆ ADMIN)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FLOW: NÃ‚NG Cáº¤P USER â†’ MANAGER                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Admin App   â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ PUT /api/manager/users/{userId}/promote
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    ManagerService                            â”‚
    â”‚                                                              â”‚
    â”‚  1. requireAdminRole() â†’ Kiá»ƒm tra current user lÃ  ADMIN      â”‚
    â”‚     â†’ Náº¿u khÃ´ng pháº£i ADMIN: throw BusinessException          â”‚
    â”‚                                                              â”‚
    â”‚  2. userRepository.findById(userId) â†’ Láº¥y target user        â”‚
    â”‚                                                              â”‚
    â”‚  3. KIá»‚M TRA:                                                â”‚
    â”‚     - Náº¿u Ä‘Ã£ lÃ  MANAGER â†’ throw "ÄÃ£ lÃ  Manager"              â”‚
    â”‚     - Náº¿u lÃ  ADMIN â†’ throw "KhÃ´ng thá»ƒ thay Ä‘á»•i role Admin"   â”‚
    â”‚     - Náº¿u bá»‹ khÃ³a â†’ throw "KhÃ´ng thá»ƒ nÃ¢ng cáº¥p tÃ i khoáº£n bá»‹   â”‚
    â”‚                            khÃ³a"                             â”‚
    â”‚                                                              â”‚
    â”‚  4. user.setRole(UserRole.MANAGER)                           â”‚
    â”‚                                                              â”‚
    â”‚  5. userRepository.save(user)                                â”‚
    â”‚                                                              â”‚
    â”‚  âš ï¸ LÆ¯U Ã: Sau khi nÃ¢ng cáº¥p, Admin cáº§n GÃN STORE cho        â”‚
    â”‚     Manager má»›i Ä‘á»ƒ há» cÃ³ thá»ƒ quáº£n lÃ½ Ä‘Æ¡n hÃ ng                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 Luá»“ng GÃ¡n Store Cho Manager (CHá»ˆ ADMIN)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FLOW: GÃN STORE CHO MANAGER                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Admin App   â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ POST /api/manager/users/{userId}/stores/{storeId}
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    ManagerService                            â”‚
    â”‚                                                              â”‚
    â”‚  1. requireAdminRole() â†’ Chá»‰ ADMIN má»›i cÃ³ quyá»n              â”‚
    â”‚                                                              â”‚
    â”‚  2. userRepository.findByIdWithManagedStores(managerId)      â”‚
    â”‚     â†’ Láº¥y Manager vá»›i danh sÃ¡ch stores Ä‘Ã£ gÃ¡n                â”‚
    â”‚                                                              â”‚
    â”‚  3. KIá»‚M TRA:                                                â”‚
    â”‚     - Náº¿u khÃ´ng pháº£i MANAGER â†’ throw "KhÃ´ng pháº£i Manager"    â”‚
    â”‚     - Náº¿u Ä‘Ã£ gÃ¡n store nÃ y â†’ throw "ÄÃ£ Ä‘Æ°á»£c gÃ¡n"             â”‚
    â”‚                                                              â”‚
    â”‚  4. storeRepository.findById(storeId) â†’ Láº¥y store            â”‚
    â”‚                                                              â”‚
    â”‚  5. manager.getManagedStores().add(store)                    â”‚
    â”‚                                                              â”‚
    â”‚  6. userRepository.save(manager)                             â”‚
    â”‚                                                              â”‚
    â”‚  âœ… Sau khi gÃ¡n, Manager cÃ³ thá»ƒ:                             â”‚
    â”‚     - Xem Ä‘Æ¡n hÃ ng cá»§a store                                 â”‚
    â”‚     - Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng                           â”‚
    â”‚     - Xem thá»‘ng kÃª doanh thu cá»§a store                       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. QUáº¢N LÃ Cá»¬A HÃ€NG

### 5.1 Má»‘i Quan Há»‡ Manager - Store
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    QUAN Há»† MANAGER - STORE                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                         ADMIN                                   â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ Quáº£n lÃ½ Táº¤T Cáº¢ stores (khÃ´ng cáº§n gÃ¡n)                   â”‚   â”‚
    â”‚  â”‚ getManagedStoreIds() â†’ return null (xem táº¥t cáº£)         â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                        MANAGER A                                â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ managedStores = [Store 1, Store 2]                      â”‚   â”‚
    â”‚  â”‚ getManagedStoreIds() â†’ return [1, 2]                    â”‚   â”‚
    â”‚  â”‚                                                         â”‚   â”‚
    â”‚  â”‚ âœ… CÃ³ thá»ƒ xem/cáº­p nháº­t Ä‘Æ¡n hÃ ng cá»§a Store 1, Store 2    â”‚   â”‚
    â”‚  â”‚ âŒ KhÃ´ng thá»ƒ xem Ä‘Æ¡n hÃ ng cá»§a Store 3                   â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                        MANAGER B                                â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ managedStores = [] (chÆ°a Ä‘Æ°á»£c gÃ¡n)                      â”‚   â”‚
    â”‚  â”‚ getManagedStoreIds() â†’ return [] (empty list)           â”‚   â”‚
    â”‚  â”‚                                                         â”‚   â”‚
    â”‚  â”‚ âš ï¸ KhÃ´ng thá»ƒ xem báº¥t ká»³ Ä‘Æ¡n hÃ ng nÃ o                    â”‚   â”‚
    â”‚  â”‚ âš ï¸ Dashboard hiá»ƒn thá»‹ empty                             â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Database Schema - manager_stores
```sql
-- Báº£ng trung gian Many-to-Many giá»¯a User (Manager) vÃ  Store
CREATE TABLE manager_stores (
  user_id BIGINT NOT NULL,      -- ID cá»§a Manager
  store_id BIGINT NOT NULL,     -- ID cá»§a Store
  PRIMARY KEY (user_id, store_id),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (store_id) REFERENCES stores(id) ON DELETE CASCADE
);

-- VÃ­ dá»¥ dá»¯ liá»‡u:
-- | user_id | store_id |
-- |---------|----------|
-- |    5    |    1     |  -- Manager 5 quáº£n lÃ½ Store 1
-- |    5    |    2     |  -- Manager 5 quáº£n lÃ½ Store 2
-- |    7    |    3     |  -- Manager 7 quáº£n lÃ½ Store 3
```

---

## 6. DASHBOARD & THá»NG KÃŠ

### 6.1 Luá»“ng Láº¥y Dashboard Summary
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FLOW: GET DASHBOARD SUMMARY                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Manager App  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ GET /api/manager/summary
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    ManagerService                            â”‚
    â”‚                                                              â”‚
    â”‚  1. getCurrentManager() â†’ Láº¥y current user                   â”‚
    â”‚  2. getManagedStoreIds(manager) â†’ Láº¥y store IDs              â”‚
    â”‚                                                              â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ TRÆ¯á»œNG Há»¢P 1: ADMIN (storeIds = null)                   â”‚ â”‚
    â”‚  â”‚ - Äáº¿m táº¥t cáº£ Ä‘Æ¡n hÃ ng                                   â”‚ â”‚
    â”‚  â”‚ - TÃ­nh tá»•ng doanh thu Táº¤T Cáº¢ stores                     â”‚ â”‚
    â”‚  â”‚ - Cá»˜NG THÃŠM doanh thu backup (user Ä‘Ã£ xÃ³a)              â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                                                              â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ TRÆ¯á»œNG Há»¢P 2: MANAGER cÃ³ stores (storeIds = [1,2])      â”‚ â”‚
    â”‚  â”‚ - Äáº¿m Ä‘Æ¡n hÃ ng WHERE store_id IN (1,2)                  â”‚ â”‚
    â”‚  â”‚ - TÃ­nh doanh thu CHá»ˆ cá»§a stores Ä‘Æ°á»£c gÃ¡n                â”‚ â”‚
    â”‚  â”‚ - KHÃ”NG cá»™ng doanh thu backup                           â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                                                              â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ TRÆ¯á»œNG Há»¢P 3: MANAGER khÃ´ng cÃ³ stores (storeIds = [])   â”‚ â”‚
    â”‚  â”‚ - Tráº£ vá» empty dashboard                                â”‚ â”‚
    â”‚  â”‚ - totalRevenue = 0, totalOrders = 0                     â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                                                              â”‚
    â”‚  3. Query top selling drinks (theo stores)                   â”‚
    â”‚  4. Query top rated drinks                                   â”‚
    â”‚  5. Build DashboardSummaryDto vÃ  return                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 DashboardSummaryDto Structure
```java
public class DashboardSummaryDto {
    private BigDecimal totalRevenue;      // Tá»•ng doanh thu
    private Long totalOrders;             // Tá»•ng sá»‘ Ä‘Æ¡n
    private Long pendingOrders;           // ÄÆ¡n chá» xá»­ lÃ½
    private Long completedOrders;         // ÄÆ¡n hoÃ n thÃ nh
    private Long canceledOrders;          // ÄÆ¡n Ä‘Ã£ há»§y
    private Boolean isAdmin;              // CÃ³ pháº£i Admin khÃ´ng
    
    // Top sáº£n pháº©m bÃ¡n cháº¡y
    private List<TopSellingDrinkDto> topSellingDrinks;
    
    // Top sáº£n pháº©m Ä‘Æ°á»£c Ä‘Ã¡nh giÃ¡ cao
    private List<TopRatedDrinkDto> topRatedDrinks;
    
    // Danh sÃ¡ch stores Ä‘Æ°á»£c quáº£n lÃ½ (cho Manager)
    private List<ManagedStoreInfo> managedStores;
}
```

---

## 7. Dá»° BÃO & PHÃ‚N TÃCH

### 7.1 CÃ¡c Loáº¡i Dá»± BÃ¡o
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Há»† THá»NG Dá»° BÃO (ForecastService)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 1. REVENUE FORECAST (Dá»± bÃ¡o doanh thu)                          â”‚
    â”‚    - Dá»± bÃ¡o hÃ´m nay (Ä‘iá»u chá»‰nh theo tiáº¿n Ä‘á»™)                   â”‚
    â”‚    - Dá»± bÃ¡o ngÃ y mai vÃ  7 ngÃ y tá»›i                              â”‚
    â”‚    - Dá»± bÃ¡o thÃ¡ng (30 ngÃ y)                                     â”‚
    â”‚    - Tá»· lá»‡ tÄƒng trÆ°á»Ÿng so vá»›i tuáº§n trÆ°á»›c                        â”‚
    â”‚    - Xu hÆ°á»›ng: GROWTH / DECLINE / STABLE                        â”‚
    â”‚                                                                 â”‚
    â”‚    CÃ´ng thá»©c:                                                   â”‚
    â”‚    dailyAvg = sum(last7Days) / 7                                â”‚
    â”‚    growthRate = (lastWeek - prevWeek) / prevWeek                â”‚
    â”‚    forecastNextDay = dailyAvg Ã— (1 + growthRate)                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 2. PEAK HOURS ANALYSIS (PhÃ¢n tÃ­ch giá» cao Ä‘iá»ƒm)                 â”‚
    â”‚    - Thá»‘ng kÃª Ä‘Æ¡n hÃ ng theo tá»«ng giá» (8h-22h)                   â”‚
    â”‚    - Doanh thu trung bÃ¬nh theo giá»                              â”‚
    â”‚    - Má»©c Ä‘á»™ cao Ä‘iá»ƒm: LOW / MEDIUM / HIGH / VERY_HIGH           â”‚
    â”‚    - Äá» xuáº¥t sá»‘ nhÃ¢n viÃªn cho má»—i khung giá»                     â”‚
    â”‚                                                                 â”‚
    â”‚    VÃ­ dá»¥ output:                                                â”‚
    â”‚    | Giá» | ÄÆ¡n TB | Doanh thu TB | Má»©c Ä‘á»™    | NhÃ¢n viÃªn |      â”‚
    â”‚    |-----|--------|--------------|-----------|-----------|      â”‚
    â”‚    | 8h  |   5    |   200,000    | LOW       |     2     |      â”‚
    â”‚    | 12h |  25    | 1,000,000    | HIGH      |     5     |      â”‚
    â”‚    | 18h |  30    | 1,200,000    | VERY_HIGH |     6     |      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 3. LOW STOCK WARNINGS (Cáº£nh bÃ¡o mÃ³n sáº¯p háº¿t)                    â”‚
    â”‚    - PhÃ¡t hiá»‡n mÃ³n bÃ¡n nhanh hÆ¡n bÃ¬nh thÆ°á»ng                    â”‚
    â”‚    - Tá»‘c Ä‘á»™ bÃ¡n (Ä‘Æ¡n/giá») so vá»›i trung bÃ¬nh                     â”‚
    â”‚    - Má»©c cáº£nh bÃ¡o: WARNING / CRITICAL                           â”‚
    â”‚    - Dá»± kiáº¿n háº¿t hÃ ng trong X giá»                               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 4. STAFFING RECOMMENDATIONS (Äá» xuáº¥t nhÃ¢n sá»±)                   â”‚
    â”‚    - Dá»± bÃ¡o 7 ngÃ y tá»›i                                          â”‚
    â”‚    - Sá»‘ nhÃ¢n viÃªn Ä‘á» xuáº¥t cho má»—i ngÃ y                          â”‚
    â”‚    - Chi tiáº¿t theo tá»«ng khung giá»                               â”‚
    â”‚    - Highlight ngÃ y cuá»‘i tuáº§n (lÆ°á»£ng Ä‘Æ¡n cao)                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 5. OVERLOAD WARNINGS (Cáº£nh bÃ¡o quÃ¡ táº£i)                         â”‚
    â”‚    - PhÃ¡t hiá»‡n khung giá» vÆ°á»£t cÃ´ng suáº¥t                         â”‚
    â”‚    - % vÆ°á»£t cÃ´ng suáº¥t tá»‘i Ä‘a (50 Ä‘Æ¡n/giá»)                       â”‚
    â”‚    - Má»©c Ä‘á»™: WARNING / CRITICAL                                 â”‚
    â”‚    - Äá» xuáº¥t xá»­ lÃ½: tÄƒng nhÃ¢n viÃªn + nguyÃªn liá»‡u                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 API Endpoints Dá»± BÃ¡o
```
GET /api/manager/forecast              â†’ Full forecast (táº¥t cáº£)
GET /api/manager/forecast/revenue      â†’ Dá»± bÃ¡o doanh thu
GET /api/manager/forecast/peak-hours   â†’ PhÃ¢n tÃ­ch giá» cao Ä‘iá»ƒm
GET /api/manager/forecast/low-stock    â†’ Cáº£nh bÃ¡o mÃ³n sáº¯p háº¿t
GET /api/manager/forecast/staffing     â†’ Äá» xuáº¥t nhÃ¢n sá»±
GET /api/manager/forecast/overload     â†’ Cáº£nh bÃ¡o quÃ¡ táº£i
```

---

## 8. WHITELIST IP - Báº¢O Máº¬T NÃ‚NG CAO

### 8.1 Tá»•ng Quan Whitelist IP
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WHITELIST IP SYSTEM                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Má»¤C ÄÃCH:                                                       â”‚
    â”‚ - Báº£o vá»‡ quyá»n truy cáº­p Admin/Manager                           â”‚
    â”‚ - Chá»‰ cho phÃ©p IP trong whitelist truy cáº­p vá»›i quyá»n cao        â”‚
    â”‚ - User thÆ°á»ng KHÃ”NG bá»‹ áº£nh hÆ°á»Ÿng                                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ SO SÃNH BLOCKED IP vs WHITELIST IP:                             â”‚
    â”‚                                                                 â”‚
    â”‚ BLOCKED IP:                                                     â”‚
    â”‚ - Cháº·n IP khÃ´ng cho truy cáº­p Há»† THá»NG                           â”‚
    â”‚ - Ãp dá»¥ng cho Táº¤T Cáº¢ ngÆ°á»i dÃ¹ng                                 â”‚
    â”‚ - Blacklist approach                                            â”‚
    â”‚                                                                 â”‚
    â”‚ WHITELIST IP:                                                   â”‚
    â”‚ - Chá»‰ cho phÃ©p IP trong danh sÃ¡ch truy cáº­p vá»›i QUYá»€N CAO        â”‚
    â”‚ - CHá»ˆ Ã¡p dá»¥ng cho ADMIN/MANAGER                                 â”‚
    â”‚ - User thÆ°á»ng váº«n truy cáº­p bÃ¬nh thÆ°á»ng                          â”‚
    â”‚ - Whitelist approach                                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 Luá»“ng Kiá»ƒm Tra Whitelist IP
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FLOW: WHITELIST IP FILTER                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Request    â”‚
    â”‚ (Manager/    â”‚
    â”‚  Admin)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                  WhitelistIPFilter                           â”‚
    â”‚                                                              â”‚
    â”‚  1. Kiá»ƒm tra whitelist.check.enabled                         â”‚
    â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚     â”‚ if (!whitelistCheckEnabled) {                       â”‚  â”‚
    â”‚     â”‚   filterChain.doFilter(request, response);          â”‚  â”‚
    â”‚     â”‚   return; // Bá» qua kiá»ƒm tra                         â”‚  â”‚
    â”‚     â”‚ }                                                    â”‚  â”‚
    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                              â”‚
    â”‚  2. Láº¥y Authentication tá»« SecurityContext                    â”‚
    â”‚                                                              â”‚
    â”‚  3. Kiá»ƒm tra cÃ³ pháº£i Admin/Manager khÃ´ng                     â”‚
    â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚     â”‚ if (!isAdminOrManager(authentication)) {            â”‚  â”‚
    â”‚     â”‚   filterChain.doFilter(request, response);          â”‚  â”‚
    â”‚     â”‚   return; // User thÆ°á»ng - cho qua                   â”‚  â”‚
    â”‚     â”‚ }                                                    â”‚  â”‚
    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                              â”‚
    â”‚  4. Láº¥y IP cá»§a client                                        â”‚
    â”‚     - Kiá»ƒm tra headers: X-Forwarded-For, X-Real-IP...        â”‚
    â”‚     - Normalize IP (::1 â†’ 127.0.0.1)                         â”‚
    â”‚                                                              â”‚
    â”‚  5. Kiá»ƒm tra IP cÃ³ trong whitelist khÃ´ng                     â”‚
    â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚     â”‚ if (!whitelistedIPService.isIPWhitelisted(ip)) {    â”‚  â”‚
    â”‚     â”‚   response.setStatus(403);                          â”‚  â”‚
    â”‚     â”‚   response.write({                                  â”‚  â”‚
    â”‚     â”‚     "error": "IP_NOT_WHITELISTED",                  â”‚  â”‚
    â”‚     â”‚     "message": "IP chÆ°a Ä‘Æ°á»£c cáº¥p quyá»n...",         â”‚  â”‚
    â”‚     â”‚     "yourIP": clientIP                              â”‚  â”‚
    â”‚     â”‚   });                                                â”‚  â”‚
    â”‚     â”‚   return; // CHáº¶N                                    â”‚  â”‚
    â”‚     â”‚ }                                                    â”‚  â”‚
    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                              â”‚
    â”‚  6. IP há»£p lá»‡ â†’ cho qua                                      â”‚
    â”‚     filterChain.doFilter(request, response);                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 Luá»“ng ThÃªm IP VÃ o Whitelist
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FLOW: THÃŠM IP VÃ€O WHITELIST                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Admin App   â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ POST /api/whitelist-ips/add
           â”‚ Body: { "ipAddress": "123.21.109.117", 
           â”‚         "description": "IP vÄƒn phÃ²ng" }
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                WhitelistedIPController                       â”‚
    â”‚  @PreAuthorize("hasRole('ADMIN')")  â† CHá»ˆ ADMIN              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 WhitelistedIPService                         â”‚
    â”‚                                                              â”‚
    â”‚  1. Validate IP khÃ´ng rá»—ng                                   â”‚
    â”‚                                                              â”‚
    â”‚  2. Normalize IP (::1 â†’ 127.0.0.1)                           â”‚
    â”‚                                                              â”‚
    â”‚  3. Kiá»ƒm tra Ä‘Ã£ tá»“n táº¡i chÆ°a                                 â”‚
    â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚     â”‚ if (existsByIpAddress(normalizedIP)) {              â”‚  â”‚
    â”‚     â”‚   // Náº¿u Ä‘Ã£ tá»“n táº¡i vÃ  active â†’ throw error         â”‚  â”‚
    â”‚     â”‚   // Náº¿u Ä‘Ã£ tá»“n táº¡i nhÆ°ng inactive â†’ kÃ­ch hoáº¡t láº¡i  â”‚  â”‚
    â”‚     â”‚ }                                                    â”‚  â”‚
    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                              â”‚
    â”‚  4. Táº¡o WhitelistedIP entity                                 â”‚
    â”‚     WhitelistedIP.builder()                                  â”‚
    â”‚       .ipAddress(normalizedIP)                               â”‚
    â”‚       .description(description)                              â”‚
    â”‚       .addedById(currentUserId)                              â”‚
    â”‚       .isActive(true)                                        â”‚
    â”‚       .build();                                              â”‚
    â”‚                                                              â”‚
    â”‚  5. whitelistedIPRepository.save(whitelistedIP)              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.4 Database Schema - whitelisted_ips
```sql
CREATE TABLE whitelisted_ips (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  ip_address VARCHAR(50) NOT NULL,        -- Äá»‹a chá»‰ IP
  description VARCHAR(500),               -- MÃ´ táº£ (VD: "IP vÄƒn phÃ²ng")
  added_by_id BIGINT,                     -- ID Admin Ä‘Ã£ thÃªm
  is_active BOOLEAN DEFAULT TRUE,         -- Tráº¡ng thÃ¡i active
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (added_by_id) REFERENCES users(id),
  INDEX idx_ip_address (ip_address),
  INDEX idx_is_active (is_active)
);

-- VÃ­ dá»¥ dá»¯ liá»‡u:
-- | id | ip_address      | description        | added_by_id | is_active |
-- |----|-----------------|--------------------| ------------|-----------|
-- | 1  | 127.0.0.1       | Localhost - Dev    | NULL        | true      |
-- | 2  | 123.21.109.117  | IP vÄƒn phÃ²ng chÃ­nh | 1           | true      |
-- | 3  | 192.168.1.100   | IP nhÃ  quáº£n lÃ½     | 1           | true      |
```

### 8.5 Cáº¥u HÃ¬nh Whitelist
```properties
# application.properties

# ============================================
# WHITELIST IP FOR ADMIN/MANAGER (DATABASE)
# ============================================
# Báº­t/táº¯t kiá»ƒm tra whitelist IP cho Admin/Manager
# Khi báº­t: Admin/Manager chá»‰ truy cáº­p Ä‘Æ°á»£c tá»« IP trong whitelist (database)
# User thÆ°á»ng KHÃ”NG bá»‹ áº£nh hÆ°á»Ÿng
whitelist.check.enabled=${WHITELIST_CHECK_ENABLED:true}
```

### 8.6 API Endpoints Whitelist IP
```
POST /api/whitelist-ips/add              â†’ ThÃªm IP vÃ o whitelist (ADMIN)
POST /api/whitelist-ips/{id}/remove      â†’ XÃ³a IP khá»i whitelist (ADMIN)
GET  /api/whitelist-ips                  â†’ Láº¥y danh sÃ¡ch IP active (ADMIN)
GET  /api/whitelist-ips/all              â†’ Láº¥y táº¥t cáº£ IP (cÃ³ phÃ¢n trang)
GET  /api/whitelist-ips/check?ip=...     â†’ Kiá»ƒm tra IP cÃ³ trong whitelist
```

---

## 9. LUá»’NG LOGIC CHI TIáº¾T

### 9.1 Sequence Diagram - Cáº­p Nháº­t Tráº¡ng ThÃ¡i ÄÆ¡n HÃ ng
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Manager â”‚     â”‚ Controller   â”‚     â”‚   Service    â”‚     â”‚ Repository   â”‚     â”‚ Database â”‚
â”‚   App   â”‚     â”‚              â”‚     â”‚              â”‚     â”‚              â”‚     â”‚          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                 â”‚                    â”‚                    â”‚                  â”‚
     â”‚ PUT /orders/1/  â”‚                    â”‚                    â”‚                  â”‚
     â”‚ status?status=  â”‚                    â”‚                    â”‚                  â”‚
     â”‚ MAKING          â”‚                    â”‚                    â”‚                  â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚                    â”‚                  â”‚
     â”‚                 â”‚                    â”‚                    â”‚                  â”‚
     â”‚                 â”‚ updateOrderStatus  â”‚                    â”‚                  â”‚
     â”‚                 â”‚ (1, MAKING)        â”‚                    â”‚                  â”‚
     â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚                  â”‚
     â”‚                 â”‚                    â”‚                    â”‚                  â”‚
     â”‚                 â”‚                    â”‚ getCurrentManager()â”‚                  â”‚
     â”‚                 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚
     â”‚                 â”‚                    â”‚                    â”‚ SELECT * FROM    â”‚
     â”‚                 â”‚                    â”‚                    â”‚ users WHERE...   â”‚
     â”‚                 â”‚                    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                 â”‚                    â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                 â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚
     â”‚                 â”‚                    â”‚                    â”‚                  â”‚
     â”‚                 â”‚                    â”‚ getManagedStoreIds â”‚                  â”‚
     â”‚                 â”‚                    â”‚ (manager)          â”‚                  â”‚
     â”‚                 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚
     â”‚                 â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ [1, 2]           â”‚
     â”‚                 â”‚                    â”‚                    â”‚                  â”‚
     â”‚                 â”‚                    â”‚ findById(1)        â”‚                  â”‚
     â”‚                 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚
     â”‚                 â”‚                    â”‚                    â”‚ SELECT * FROM    â”‚
     â”‚                 â”‚                    â”‚                    â”‚ orders WHERE...  â”‚
     â”‚                 â”‚                    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                 â”‚                    â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                 â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Order            â”‚
     â”‚                 â”‚                    â”‚                    â”‚                  â”‚
     â”‚                 â”‚                    â”‚ validateStoreAccessâ”‚                  â”‚
     â”‚                 â”‚                    â”‚ (manager, storeId) â”‚                  â”‚
     â”‚                 â”‚                    â”‚ âœ… OK              â”‚                  â”‚
     â”‚                 â”‚                    â”‚                    â”‚                  â”‚
     â”‚                 â”‚                    â”‚ order.setStatus    â”‚                  â”‚
     â”‚                 â”‚                    â”‚ (MAKING)           â”‚                  â”‚
     â”‚                 â”‚                    â”‚                    â”‚                  â”‚
     â”‚                 â”‚                    â”‚ save(order)        â”‚                  â”‚
     â”‚                 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚
     â”‚                 â”‚                    â”‚                    â”‚ UPDATE orders    â”‚
     â”‚                 â”‚                    â”‚                    â”‚ SET status=...   â”‚
     â”‚                 â”‚                    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                 â”‚                    â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                 â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚
     â”‚                 â”‚                    â”‚                    â”‚                  â”‚
     â”‚                 â”‚                    â”‚ notifyOrderStatus  â”‚                  â”‚
     â”‚                 â”‚                    â”‚ (WebSocket + Push) â”‚                  â”‚
     â”‚                 â”‚                    â”‚                    â”‚                  â”‚
     â”‚                 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ OrderDto           â”‚                  â”‚
     â”‚                 â”‚                    â”‚                    â”‚                  â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Response           â”‚                    â”‚                  â”‚
     â”‚                 â”‚ {success: true,    â”‚                    â”‚                  â”‚
     â”‚                 â”‚  data: OrderDto}   â”‚                    â”‚                  â”‚
     â”‚                 â”‚                    â”‚                    â”‚                  â”‚
```

---

## 11. GIáº¢I THÃCH CODE

### 11.1 ManagerService - CÃ¡c Method Quan Trá»ng

#### getCurrentManager() - Láº¥y Manager Hiá»‡n Táº¡i
```java
/**
 * Láº¥y current user tá»« Security Context
 * SecurityContext chá»©a thÃ´ng tin user Ä‘Ã£ authenticate qua JWT
 */
private User getCurrentManager() {
    // Láº¥y username tá»« JWT token Ä‘Ã£ Ä‘Æ°á»£c parse bá»Ÿi JwtAuthenticationFilter
    String username = SecurityContextHolder.getContext()
        .getAuthentication().getName();
    
    // Query user vá»›i managed stores (JOIN FETCH Ä‘á»ƒ trÃ¡nh N+1)
    return userRepository.findByUsernameWithManagedStores(username)
        .orElseThrow(() -> new ResourceNotFoundException(
            "Manager not found: " + username));
}
```

#### getManagedStoreIds() - Láº¥y Danh SÃ¡ch Store IDs
```java
/**
 * Láº¥y danh sÃ¡ch store IDs mÃ  manager Ä‘Æ°á»£c phÃ©p quáº£n lÃ½
 * 
 * @return null náº¿u ADMIN (quáº£n lÃ½ táº¥t cáº£)
 * @return empty list náº¿u MANAGER chÆ°a Ä‘Æ°á»£c gÃ¡n store
 * @return list store IDs náº¿u MANAGER cÃ³ stores
 */
private List<Long> getManagedStoreIds(User manager) {
    // ADMIN luÃ´n quáº£n lÃ½ táº¥t cáº£ - return null Ä‘á»ƒ query khÃ´ng filter
    if (manager.getRole() == UserRole.ADMIN) {
        return null;
    }
    
    // MANAGER pháº£i cÃ³ stores Ä‘Æ°á»£c gÃ¡n
    Set<Store> managedStores = manager.getManagedStores();
    if (managedStores == null || managedStores.isEmpty()) {
        log.warn("Manager {} has no assigned stores", manager.getUsername());
        return new ArrayList<>(); // Empty list - khÃ´ng xem Ä‘Æ°á»£c gÃ¬
    }
    
    // Extract store IDs
    return managedStores.stream()
        .map(Store::getId)
        .collect(Collectors.toList());
}
```

#### validateStoreAccess() - Kiá»ƒm Tra Quyá»n Truy Cáº­p Store
```java
/**
 * Kiá»ƒm tra manager cÃ³ quyá»n truy cáº­p store khÃ´ng
 * ADMIN bá» qua kiá»ƒm tra
 * MANAGER pháº£i cÃ³ store trong danh sÃ¡ch Ä‘Æ°á»£c gÃ¡n
 */
private void validateStoreAccess(User manager, Long storeId) {
    // ADMIN cÃ³ quyá»n truy cáº­p táº¥t cáº£
    if (manager.getRole() == UserRole.ADMIN) {
        return;
    }
    
    // MANAGER pháº£i cÃ³ store trong danh sÃ¡ch
    if (!manager.canManageStore(storeId)) {
        log.error("Manager {} cannot access store {}. Managed stores: {}", 
            manager.getUsername(), storeId, 
            manager.getManagedStores().stream()
                .map(Store::getId)
                .collect(Collectors.toList()));
        
        throw new BusinessException(
            "Báº¡n khÃ´ng cÃ³ quyá»n quáº£n lÃ½ Ä‘Æ¡n hÃ ng cá»§a chi nhÃ¡nh nÃ y. " +
            "Vui lÃ²ng liÃªn há»‡ Admin Ä‘á»ƒ Ä‘Æ°á»£c gÃ¡n chi nhÃ¡nh.");
    }
}
```

### 11.2 WhitelistIPFilter - Giáº£i ThÃ­ch Chi Tiáº¿t

```java
@Component
@Order(Ordered.LOWEST_PRECEDENCE - 10) // Cháº¡y SAU JwtAuthFilter
@Slf4j
public class WhitelistIPFilter extends OncePerRequestFilter {

    private final WhitelistedIPService whitelistedIPService;

    // Äá»c tá»« application.properties
    @Value("${whitelist.check.enabled:false}")
    private boolean whitelistCheckEnabled;

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain) 
            throws ServletException, IOException {

        // BÆ¯á»šC 1: Kiá»ƒm tra tÃ­nh nÄƒng cÃ³ báº­t khÃ´ng
        if (!whitelistCheckEnabled) {
            filterChain.doFilter(request, response);
            return;
        }

        // BÆ¯á»šC 2: Láº¥y Authentication tá»« SecurityContext
        // (Ä‘Ã£ Ä‘Æ°á»£c set bá»Ÿi JwtAuthenticationFilter)
        Authentication authentication = SecurityContextHolder
            .getContext().getAuthentication();

        // BÆ¯á»šC 3: Náº¿u chÆ°a authenticate hoáº·c khÃ´ng pháº£i Admin/Manager
        // â†’ cho qua (User thoáº£i mÃ¡i)
        if (authentication == null || !isAdminOrManager(authentication)) {
            filterChain.doFilter(request, response);
            return;
        }

        // BÆ¯á»šC 4: Láº¥y IP cá»§a client
        String clientIP = getClientIP(request);
        String normalizedIP = normalizeIP(clientIP);

        // BÆ¯á»šC 5: Kiá»ƒm tra IP cÃ³ trong whitelist khÃ´ng
        if (!whitelistedIPService.isIPWhitelisted(normalizedIP)) {
            log.warn("ğŸš« WHITELIST CHECK FAILED | User: {} | IP: {}",
                    authentication.getName(), clientIP);

            // Tráº£ vá» 403 Forbidden
            response.setStatus(HttpStatus.FORBIDDEN.value());
            response.setContentType("application/json;charset=UTF-8");
            response.getWriter().write(
                "{\"success\":false," +
                "\"error\":\"IP_NOT_WHITELISTED\"," +
                "\"message\":\"IP cá»§a báº¡n chÆ°a Ä‘Æ°á»£c cáº¥p quyá»n...\"," +
                "\"yourIP\":\"" + clientIP + "\"}"
            );
            return; // CHáº¶N - khÃ´ng cho Ä‘i tiáº¿p
        }

        // BÆ¯á»šC 6: IP há»£p lá»‡ â†’ cho qua
        log.info("âœ… WHITELIST CHECK PASSED | User: {} | IP: {}",
                authentication.getName(), clientIP);
        filterChain.doFilter(request, response);
    }

    /**
     * Kiá»ƒm tra user cÃ³ pháº£i Admin hoáº·c Manager khÃ´ng
     */
    private boolean isAdminOrManager(Authentication authentication) {
        return authentication.getAuthorities().stream()
            .map(GrantedAuthority::getAuthority)
            .anyMatch(role -> 
                role.equals("ROLE_ADMIN") || role.equals("ROLE_MANAGER"));
    }

    /**
     * Láº¥y IP thá»±c cá»§a client (xá»­ lÃ½ proxy/load balancer)
     */
    private String getClientIP(HttpServletRequest request) {
        String[] headers = {
            "X-Forwarded-For",  // Proxy header phá»• biáº¿n
            "X-Real-IP",        // Nginx
            "Proxy-Client-IP",  // Apache
            "WL-Proxy-Client-IP"
        };

        for (String header : headers) {
            String ip = request.getHeader(header);
            if (ip != null && !ip.isEmpty() && !"unknown".equalsIgnoreCase(ip)) {
                return ip.split(",")[0].trim(); // Láº¥y IP Ä‘áº§u tiÃªn
            }
        }

        return request.getRemoteAddr();
    }

    /**
     * Normalize IP address (IPv6 localhost â†’ IPv4)
     */
    private String normalizeIP(String ip) {
        if ("0:0:0:0:0:0:0:1".equals(ip) || "::1".equals(ip)) {
            return "127.0.0.1";
        }
        return ip;
    }

    /**
     * CÃ¡c endpoint khÃ´ng cáº§n kiá»ƒm tra whitelist
     */
    @Override
    protected boolean shouldNotFilter(HttpServletRequest request) {
        String path = request.getRequestURI();
        return path.startsWith("/swagger") ||
               path.startsWith("/api/auth/") ||  // Login, register...
               path.equals("/actuator/health");
    }
}
```

---

## 12. API REFERENCE

### 12.1 Manager APIs

#### Dashboard & Statistics
| Method | Endpoint | MÃ´ táº£ | Role |
|--------|----------|-------|------|
| GET | `/api/manager/summary` | Dashboard tá»•ng quan | MANAGER, ADMIN |
| GET | `/api/manager/statistics/revenue` | Thá»‘ng kÃª doanh thu | MANAGER, ADMIN |

#### Order Management
| Method | Endpoint | MÃ´ táº£ | Role |
|--------|----------|-------|------|
| GET | `/api/manager/orders` | Danh sÃ¡ch Ä‘Æ¡n hÃ ng | MANAGER, ADMIN |
| PUT | `/api/manager/orders/{id}/status` | Cáº­p nháº­t tráº¡ng thÃ¡i | MANAGER, ADMIN |

#### User Management
| Method | Endpoint | MÃ´ táº£ | Role |
|--------|----------|-------|------|
| GET | `/api/manager/users` | Danh sÃ¡ch ngÆ°á»i dÃ¹ng | MANAGER, ADMIN |
| GET | `/api/manager/users/{id}` | Chi tiáº¿t ngÆ°á»i dÃ¹ng | MANAGER, ADMIN |
| PUT | `/api/manager/users/{id}/block` | KhÃ³a/Má»Ÿ khÃ³a | MANAGER, ADMIN |
| PUT | `/api/manager/users/{id}/promote` | NÃ¢ng cáº¥p â†’ Manager | ADMIN |
| PUT | `/api/manager/users/{id}/demote` | Háº¡ cáº¥p â†’ User | ADMIN |
| DELETE | `/api/manager/users/{id}` | XÃ³a ngÆ°á»i dÃ¹ng | MANAGER, ADMIN |

#### Store Assignment
| Method | Endpoint | MÃ´ táº£ | Role |
|--------|----------|-------|------|
| GET | `/api/manager/my-stores` | Stores cá»§a tÃ´i | MANAGER, ADMIN |
| GET | `/api/manager/users/{id}/stores` | Stores cá»§a Manager | MANAGER, ADMIN |
| POST | `/api/manager/users/{id}/stores/{storeId}` | GÃ¡n store | ADMIN |
| PUT | `/api/manager/users/{id}/stores` | GÃ¡n nhiá»u stores | ADMIN |
| DELETE | `/api/manager/users/{id}/stores/{storeId}` | Bá» gÃ¡n store | ADMIN |

#### Forecast & Analytics
| Method | Endpoint | MÃ´ táº£ | Role |
|--------|----------|-------|------|
| GET | `/api/manager/forecast` | Full forecast | MANAGER, ADMIN |
| GET | `/api/manager/forecast/revenue` | Dá»± bÃ¡o doanh thu | MANAGER, ADMIN |
| GET | `/api/manager/forecast/peak-hours` | Giá» cao Ä‘iá»ƒm | MANAGER, ADMIN |
| GET | `/api/manager/forecast/low-stock` | Cáº£nh bÃ¡o háº¿t hÃ ng | MANAGER, ADMIN |
| GET | `/api/manager/forecast/staffing` | Äá» xuáº¥t nhÃ¢n sá»± | MANAGER, ADMIN |
| GET | `/api/manager/forecast/overload` | Cáº£nh bÃ¡o quÃ¡ táº£i | MANAGER, ADMIN |

### 12.2 Whitelist IP APIs

| Method | Endpoint | MÃ´ táº£ | Role |
|--------|----------|-------|------|
| POST | `/api/whitelist-ips/add` | ThÃªm IP vÃ o whitelist | ADMIN |
| POST | `/api/whitelist-ips/{id}/remove` | XÃ³a IP khá»i whitelist | ADMIN |
| GET | `/api/whitelist-ips` | Danh sÃ¡ch IP active | ADMIN |
| GET | `/api/whitelist-ips/all` | Táº¥t cáº£ IP (phÃ¢n trang) | ADMIN |
| GET | `/api/whitelist-ips/check?ip=...` | Kiá»ƒm tra IP | ADMIN |

### 12.3 Monitoring APIs

#### Dashboard & Overview
| Method | Endpoint | MÃ´ táº£ | Role |
|--------|----------|-------|------|
| GET | `/api/monitoring/dashboard` | Dashboard tá»•ng quan giÃ¡m sÃ¡t | ADMIN |

#### Activity Logs
| Method | Endpoint | MÃ´ táº£ | Role |
|--------|----------|-------|------|
| GET | `/api/monitoring/activities` | Danh sÃ¡ch log hoáº¡t Ä‘á»™ng | ADMIN |
| GET | `/api/monitoring/activities/user/{userId}` | Log cá»§a user cá»¥ thá»ƒ | ADMIN |

#### Alerts Management
| Method | Endpoint | MÃ´ táº£ | Role |
|--------|----------|-------|------|
| GET | `/api/monitoring/alerts` | Danh sÃ¡ch cáº£nh bÃ¡o | ADMIN |
| GET | `/api/monitoring/alerts/pending` | Cáº£nh bÃ¡o chá» xá»­ lÃ½ | ADMIN |
| PUT | `/api/monitoring/alerts/{id}/handle` | Xá»­ lÃ½ cáº£nh bÃ¡o | ADMIN |

#### Risk Scores
| Method | Endpoint | MÃ´ táº£ | Role |
|--------|----------|-------|------|
| GET | `/api/monitoring/risk-scores` | Danh sÃ¡ch Ä‘iá»ƒm rá»§i ro | ADMIN |
| GET | `/api/monitoring/risk-scores/user/{userId}` | Äiá»ƒm rá»§i ro cá»§a user | ADMIN |
| POST | `/api/monitoring/risk-scores/user/{userId}/note` | ThÃªm ghi chÃº admin | ADMIN |
| POST | `/api/monitoring/risk-scores/user/{userId}/reset` | Reset Ä‘iá»ƒm rá»§i ro | ADMIN |

#### User Actions
| Method | Endpoint | MÃ´ táº£ | Role |
|--------|----------|-------|------|
| POST | `/api/monitoring/users/{userId}/unblock` | Má»Ÿ khÃ³a user | ADMIN |

### 12.4 Request/Response Examples

#### ThÃªm IP vÃ o Whitelist
```http
POST /api/whitelist-ips/add
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json

{
  "ipAddress": "123.21.109.117",
  "description": "IP vÄƒn phÃ²ng chÃ­nh"
}
```

Response:
```json
{
  "success": true,
  "message": "IP Ä‘Ã£ Ä‘Æ°á»£c thÃªm vÃ o whitelist",
  "data": {
    "id": 2,
    "ipAddress": "123.21.109.117",
    "description": "IP vÄƒn phÃ²ng chÃ­nh",
    "addedById": 1,
    "isActive": true,
    "createdAt": "2024-01-15T10:00:00"
  }
}
```

#### Cáº­p Nháº­t Tráº¡ng ThÃ¡i ÄÆ¡n HÃ ng
```http
PUT /api/manager/orders/123/status?status=MAKING
Authorization: Bearer <JWT_TOKEN>
```

Response:
```json
{
  "success": true,
  "message": "Order status updated",
  "data": {
    "id": 123,
    "status": "MAKING",
    "userId": 5,
    "storeId": 1,
    "totalPrice": 150000,
    "updatedAt": "2024-01-15T10:30:00"
  }
}
```

#### Láº¥y Dashboard Monitoring
```http
GET /api/monitoring/dashboard
Authorization: Bearer <JWT_TOKEN>
```

Response:
```json
{
  "success": true,
  "data": {
    "totalPendingAlerts": 15,
    "criticalAlerts": 3,
    "highAlerts": 5,
    "mediumAlerts": 4,
    "lowAlerts": 3,
    "normalUsers": 1200,
    "warningUsers": 45,
    "suspiciousUsers": 12,
    "criticalUsers": 3,
    "activityStats": {
      "LOGIN_SUCCESS": 450,
      "LOGIN_FAILED": 23,
      "ORDER_CREATE": 89,
      "PAYMENT_SUCCESS": 76,
      "BRUTE_FORCE_ATTEMPT": 2
    },
    "alertTypeStats": {
      "LOGIN_ANOMALY": 5,
      "BRUTE_FORCE": 2,
      "HIGH_RISK_SCORE": 8
    }
  }
}
```

#### Xá»­ LÃ½ Cáº£nh BÃ¡o
```http
PUT /api/monitoring/alerts/15/handle
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json

{
  "status": "RESOLVED",
  "actionTaken": "TEMP_BLOCKED",
  "note": "ÄÃ£ khÃ³a tÃ i khoáº£n táº¡m thá»i 24h do brute force"
}
```

Response:
```json
{
  "success": true,
  "message": "Alert handled",
  "data": {
    "id": 15,
    "alertType": "BRUTE_FORCE",
    "severity": "CRITICAL",
    "status": "RESOLVED",
    "actionTaken": "TEMP_BLOCKED",
    "handlerNote": "ÄÃ£ khÃ³a tÃ i khoáº£n táº¡m thá»i 24h do brute force",
    "handledAt": "2024-01-15T11:00:00"
  }
}
```

#### Láº¥y Risk Score cá»§a User
```http
GET /api/monitoring/risk-scores/user/123
Authorization: Bearer <JWT_TOKEN>
```

Response:
```json
{
  "success": true,
  "data": {
    "userId": 123,
    "username": "user123",
    "totalScore": 65,
    "riskLevel": "SUSPICIOUS",
    "loginFailedCount": 3,
    "orderCancelCount": 2,
    "paymentFailedCount": 1,
    "rateLimitHitCount": 0,
    "promotionAbuseCount": 0,
    "spamRequestCount": 0,
    "autoBlocked": false,
    "adminNote": "User cÃ³ hÃ nh vi Ä‘Ã¡ng ngá», cáº§n theo dÃµi",
    "lastActivity": "2024-01-15T10:45:00"
  }
}
```

---

## 13. CÃ‚U Há»I PHá»NG Váº¤N

### 13.1 CÃ¢u Há»i CÆ¡ Báº£n

**Q1: MÃ´ táº£ flow khi Manager cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n tá»« PENDING â†’ MAKING?**
```
A: Controller nháº­n request â†’ validate JWT + role â†’ Service láº¥y current manager 
â†’ láº¥y danh sÃ¡ch store IDs Ä‘Æ°á»£c gÃ¡n â†’ query order â†’ validate quyá»n truy cáº­p store 
â†’ validate transition há»£p lá»‡ â†’ update status â†’ save â†’ gá»­i notification 
(WebSocket + Push + Email) â†’ return response
```

**Q2: LÃ m sao trÃ¡nh 2 manager cáº­p nháº­t trÃ¹ng 1 order (race condition)?**
```
A: Sá»­ dá»¥ng optimistic locking vá»›i @Version field trong entity Order.
Khi update, JPA sáº½ check version. Náº¿u version khÃ´ng khá»›p (Ä‘Ã£ bá»‹ update bá»Ÿi 
ngÆ°á»i khÃ¡c), throw OptimisticLockException â†’ tráº£ vá» 409 Conflict.
```

**Q3: Whitelist IP khÃ¡c gÃ¬ vá»›i Blocked IP?**
```
A: 
- Blocked IP: Cháº·n IP khÃ´ng cho truy cáº­p Há»† THá»NG (blacklist approach)
- Whitelist IP: Chá»‰ cho phÃ©p IP trong danh sÃ¡ch truy cáº­p vá»›i QUYá»€N CAO 
  (Admin/Manager). User thÆ°á»ng khÃ´ng bá»‹ áº£nh hÆ°á»Ÿng (whitelist approach)
```

### 13.2 CÃ¢u Há»i NÃ¢ng Cao

**Q4: Táº¡i sao WhitelistIPFilter pháº£i cháº¡y SAU JwtAuthenticationFilter?**
```
A: VÃ¬ WhitelistIPFilter cáº§n biáº¿t user Ä‘Ã£ authenticate lÃ  ai vÃ  cÃ³ role gÃ¬ 
Ä‘á»ƒ quyáº¿t Ä‘á»‹nh cÃ³ cáº§n kiá»ƒm tra whitelist khÃ´ng. JwtAuthenticationFilter 
parse JWT token vÃ  set Authentication vÃ o SecurityContext. Náº¿u cháº¡y trÆ°á»›c, 
SecurityContext sáº½ rá»—ng vÃ  khÃ´ng thá»ƒ kiá»ƒm tra role.
```

**Q5: LÃ m sao Manager chá»‰ xem Ä‘Æ°á»£c Ä‘Æ¡n hÃ ng cá»§a store Ä‘Æ°á»£c gÃ¡n?**
```
A: 
1. Khi query, láº¥y danh sÃ¡ch store IDs tá»« manager.getManagedStores()
2. ThÃªm Ä‘iá»u kiá»‡n WHERE store_id IN (:storeIds) vÃ o query
3. ADMIN return null â†’ khÃ´ng filter (xem táº¥t cáº£)
4. MANAGER khÃ´ng cÃ³ store â†’ return empty list â†’ khÃ´ng xem Ä‘Æ°á»£c gÃ¬
```

**Q6: Giáº£i thÃ­ch cÃ¡ch tÃ­nh doanh thu trong Dashboard?**
```
A:
- ADMIN: Tá»•ng doanh thu Táº¤T Cáº¢ stores + doanh thu backup (user Ä‘Ã£ xÃ³a)
- MANAGER: Chá»‰ tÃ­nh doanh thu cá»§a stores Ä‘Æ°á»£c gÃ¡n, KHÃ”NG cá»™ng backup

Query:
SELECT COALESCE(SUM(o.finalPrice), 0) 
FROM Order o 
WHERE o.status = 'DONE' 
  AND o.store.id IN :storeIds  -- Chá»‰ cho MANAGER
```

**Q7: Giáº£i thÃ­ch há»‡ thá»‘ng Risk Scoring trong Monitoring?**
```
A: Há»‡ thá»‘ng tÃ­nh Ä‘iá»ƒm rá»§i ro dá»±a trÃªn hÃ nh vi:
- Má»—i hÃ nh vi báº¥t thÆ°á»ng cá»™ng Ä‘iá»ƒm (login fail +5, brute force +40...)
- PhÃ¢n loáº¡i: NORMAL (0-29) â†’ WARNING (30-59) â†’ SUSPICIOUS (60-79) â†’ CRITICAL (80+)
- Tá»± Ä‘á»™ng khÃ³a tÃ i khoáº£n khi >= 80 Ä‘iá»ƒm
- Gá»­i cáº£nh bÃ¡o realtime cho Admin qua WebSocket + Push notification
```

**Q8: LÃ m sao phÃ¡t hiá»‡n Brute Force Attack?**
```
A: 
1. Äáº¿m sá»‘ láº§n login failed trong 15 phÃºt
2. Náº¿u >= 5 láº§n â†’ log BRUTE_FORCE_ATTEMPT vá»›i CRITICAL level
3. Cá»™ng 40 Ä‘iá»ƒm vÃ o Risk Score
4. Táº¡o Alert vá»›i severity CRITICAL
5. Náº¿u tá»•ng Ä‘iá»ƒm >= 80 â†’ tá»± Ä‘á»™ng khÃ³a tÃ i khoáº£n
6. Gá»­i notification cho Admin
```

### 13.3 CÃ¢u Há»i Vá» Monitoring

**Q9: Monitoring System ghi log nhá»¯ng hoáº¡t Ä‘á»™ng nÃ o?**
```
A: Ghi log táº¥t cáº£ hoáº¡t Ä‘á»™ng quan trá»ng:
- Authentication: login success/failed, logout, password change
- Order: create, cancel, status update
- Payment: success/failed
- Cart: add/remove items
- Profile: update info, avatar change
- Security: rate limit hit, spam request, brute force
- Group Order: create, join, leave
- Live Chat: start conversation, send message
```

**Q10: Khi nÃ o há»‡ thá»‘ng tá»± Ä‘á»™ng khÃ³a tÃ i khoáº£n?**
```
A: Tá»± Ä‘á»™ng khÃ³a khi Risk Score >= 80 Ä‘iá»ƒm:
1. TÃ­nh tá»•ng Ä‘iá»ƒm tá»« cÃ¡c hÃ nh vi báº¥t thÆ°á»ng
2. Náº¿u >= 80 â†’ user.setIsBlocked(true)
3. Táº¡o Alert AUTO_BLOCKED vá»›i severity CRITICAL
4. Gá»­i WebSocket notification Ä‘áº·c biá»‡t
5. Gá»­i push notification cho Admin
6. Log activity ACCOUNT_BLOCKED
```

**Q11: LÃ m sao Admin xá»­ lÃ½ má»™t Alert?**
```
A: Flow xá»­ lÃ½ Alert:
1. Admin xem Alert trong dashboard
2. PUT /api/monitoring/alerts/{id}/handle
3. Chá»n status (RESOLVED/DISMISSED) vÃ  action (TEMP_BLOCKED/WARNING_SENT...)
4. ThÃªm handler note giáº£i thÃ­ch
5. Náº¿u action = TEMP_BLOCKED â†’ tá»± Ä‘á»™ng khÃ³a user
6. Update alert.handledBy = currentAdmin
7. Gá»­i notification cho user (náº¿u cáº§n)
```

### 13.4 Quick Checklist TrÆ°á»›c Phá»ng Váº¥n

âœ… Náº¯m 3 endpoints chÃ­nh: GET orders, PUT order status, GET dashboard

âœ… MÃ´ táº£ sequence flow khi update tráº¡ng thÃ¡i (controller â†’ service â†’ repo â†’ event â†’ ws â†’ push)

âœ… NÃªu 3 security checks: role check, store scope, whitelist IP

âœ… Giáº£i thÃ­ch optimistic locking vs SELECT FOR UPDATE

âœ… PhÃ¢n biá»‡t Blocked IP vs Whitelist IP

âœ… Hiá»ƒu cÃ¡ch phÃ¢n quyá»n ADMIN vs MANAGER

âœ… Biáº¿t cÃ¡ch gÃ¡n store cho Manager

âœ… Hiá»ƒu há»‡ thá»‘ng Risk Scoring vÃ  Auto-block

âœ… Biáº¿t cÃ¡ch phÃ¡t hiá»‡n Brute Force Attack

âœ… Hiá»ƒu cÃ¡c loáº¡i Activity Type vÃ  Alert Type

âœ… Biáº¿t cÃ¡ch xá»­ lÃ½ Alert vÃ  unblock user

---

## ğŸ“š TÃ€I LIá»†U THAM KHáº¢O

- `UTE_TEA_API_DOCUMENTATION.md` - API chi tiáº¿t
- `UTE_TEA_DATABASE_SCHEMA.md` - Cáº¥u trÃºc database
- `UTE_TEA_FEATURES_DOCUMENTATION.md` - Danh sÃ¡ch chá»©c nÄƒng
- `Manager_Admin_CheatSheet.md` - Cheat sheet nhanh

---

*TÃ i liá»‡u Ä‘Æ°á»£c táº¡o Ä‘á»ƒ há»c táº­p vÃ  Ã´n thi. Cáº­p nháº­t: 2024*


---

## 13. QUáº¢N LÃ Sáº¢N PHáº¨M (DRINKS & CATEGORIES)

### 13.1 Tá»•ng Quan Quáº£n LÃ½ Sáº£n Pháº©m
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    QUáº¢N LÃ Sáº¢N PHáº¨M                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ DRINK (MÃ³n nÆ°á»›c)                                                â”‚
    â”‚ â”œâ”€â”€ id, name, description, imageUrl                             â”‚
    â”‚ â”œâ”€â”€ basePrice (giÃ¡ gá»‘c)                                         â”‚
    â”‚ â”œâ”€â”€ categoryId (danh má»¥c)                                       â”‚
    â”‚ â”œâ”€â”€ isActive (cÃ²n bÃ¡n/ngá»«ng bÃ¡n)                                â”‚
    â”‚ â”‚                                                               â”‚
    â”‚ â”œâ”€â”€ SIZES (KÃ­ch cá»¡)                                             â”‚
    â”‚ â”‚   â”œâ”€â”€ M: extraPrice = 0                                       â”‚
    â”‚ â”‚   â”œâ”€â”€ L: extraPrice = 5,000                                   â”‚
    â”‚ â”‚   â””â”€â”€ Jumbo: extraPrice = 10,000                              â”‚
    â”‚ â”‚                                                               â”‚
    â”‚ â””â”€â”€ TOPPINGS (Topping)                                          â”‚
    â”‚     â”œâ”€â”€ TrÃ¢n chÃ¢u Ä‘en: 10,000                                   â”‚
    â”‚     â”œâ”€â”€ Tháº¡ch dá»«a: 8,000                                        â”‚
    â”‚     â””â”€â”€ Pudding: 12,000                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ CATEGORY (Danh má»¥c)                                             â”‚
    â”‚ â”œâ”€â”€ id, name, description, imageUrl                             â”‚
    â”‚ â”œâ”€â”€ displayOrder (thá»© tá»± hiá»ƒn thá»‹)                              â”‚
    â”‚ â””â”€â”€ isActive                                                    â”‚
    â”‚                                                                 â”‚
    â”‚ VÃ­ dá»¥: TrÃ  sá»¯a, CÃ  phÃª, TrÃ  trÃ¡i cÃ¢y, ÄÃ¡ xay...                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 13.2 Luá»“ng Táº¡o/Cáº­p Nháº­t Sáº£n Pháº©m
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FLOW: Táº O Sáº¢N PHáº¨M Má»šI                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Manager App  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ POST /api/admin/drinks
           â”‚ Body: { name, description, basePrice, categoryId, imageUrl }
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 AdminDrinkController                         â”‚
    â”‚  @PreAuthorize("hasRole('ADMIN')")                           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     DrinkService                             â”‚
    â”‚                                                              â”‚
    â”‚  1. Táº¡o Drink entity má»›i                                     â”‚
    â”‚     drink.setName(dto.getName())                             â”‚
    â”‚     drink.setDescription(dto.getDescription())               â”‚
    â”‚     drink.setBasePrice(dto.getBasePrice())                   â”‚
    â”‚     drink.setIsActive(true)                                  â”‚
    â”‚                                                              â”‚
    â”‚  2. drinkRepository.save(drink)                              â”‚
    â”‚                                                              â”‚
    â”‚  3. @CacheEvict(value = DRINKS_CACHE, allEntries = true)     â”‚
    â”‚     â†’ XÃ³a cache Ä‘á»ƒ cáº­p nháº­t danh sÃ¡ch má»›i                    â”‚
    â”‚                                                              â”‚
    â”‚  4. Return DrinkDto                                          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 13.3 Giáº£i ThÃ­ch Code DrinkService
```java
@Service
@RequiredArgsConstructor
@Slf4j
public class DrinkService {
    
    private final DrinkRepository drinkRepository;
    private final DrinkSizeRepository drinkSizeRepository;
    private final DrinkToppingRepository drinkToppingRepository;
    
    /**
     * FIX N+1 QUERY: Load táº¥t cáº£ drinks vá»›i sizes trong 1 query,
     * sau Ä‘Ã³ batch load toppings
     */
    @Transactional(readOnly = true)
    @Cacheable(value = DRINKS_CACHE, key = "'all-active'")
    public List<DrinkDto> getAllActiveDrinks() {
        // Query 1: Load drinks vá»›i sizes vÃ  category (JOIN FETCH)
        List<Drink> drinks = drinkRepository
            .findByIsActiveTrueWithSizesAndCategory();
        
        if (drinks.isEmpty()) {
            return List.of();
        }
        
        // Query 2: Batch load toppings cho táº¥t cáº£ drinks
        List<Long> drinkIds = drinks.stream()
            .map(Drink::getId)
            .collect(Collectors.toList());
        Map<Long, List<DrinkTopping>> toppingsMap = 
            loadToppingsForDrinks(drinkIds);
        
        // Query 3: Load global toppings (drink_id = NULL)
        List<DrinkTopping> globalToppings = drinkToppingRepository
            .findByDrinkIdIsNullAndIsActiveTrue();
        
        return drinks.stream()
            .map(drink -> mapToDtoOptimized(drink, 
                toppingsMap.get(drink.getId()), globalToppings))
            .collect(Collectors.toList());
    }
    
    /**
     * TÃ¬m kiáº¿m sáº£n pháº©m vá»›i input sanitization
     */
    @Transactional(readOnly = true)
    public List<DrinkDto> searchDrinks(String keyword) {
        // Input sanitization: validate and clean keyword
        if (keyword == null || keyword.trim().isEmpty()) {
            return List.of();
        }
        
        // Sanitize: remove special characters, keep Vietnamese
        String sanitized = keyword.replaceAll(
            "[^a-zA-Z0-9\\sÃ Ã¡áº¡áº£Ã£...Ä‘Ä]", "");
        if (sanitized.length() > 100) {
            sanitized = sanitized.substring(0, 100);
        }
        
        List<Drink> drinks = drinkRepository
            .searchByNameWithSizesAndCategory(sanitized);
        // ... batch load toppings vÃ  map to DTO
    }
    
    /**
     * XÃ³a sáº£n pháº©m (soft delete)
     */
    @Transactional
    @CacheEvict(value = DRINKS_CACHE, allEntries = true)
    public void deleteDrink(Long id) {
        Drink drink = drinkRepository.findById(id)
            .orElseThrow(() -> new ResourceNotFoundException("Drink", "id", id));
        drink.setIsActive(false);  // Soft delete - khÃ´ng xÃ³a tháº­t
        drinkRepository.save(drink);
    }
}
```

### 13.4 API Endpoints Quáº£n LÃ½ Sáº£n Pháº©m
| Method | Endpoint | MÃ´ táº£ | Role |
|--------|----------|-------|------|
| GET | `/api/drinks` | Danh sÃ¡ch sáº£n pháº©m | PUBLIC |
| GET | `/api/drinks/{id}` | Chi tiáº¿t sáº£n pháº©m | PUBLIC |
| GET | `/api/drinks/search?keyword=...` | TÃ¬m kiáº¿m | PUBLIC |
| POST | `/api/admin/drinks` | Táº¡o sáº£n pháº©m má»›i | ADMIN |
| PUT | `/api/admin/drinks/{id}` | Cáº­p nháº­t sáº£n pháº©m | ADMIN |
| DELETE | `/api/admin/drinks/{id}` | XÃ³a sáº£n pháº©m | ADMIN |
| GET | `/api/categories` | Danh sÃ¡ch danh má»¥c | PUBLIC |
| POST | `/api/manager/categories` | Táº¡o danh má»¥c | MANAGER, ADMIN |
| PUT | `/api/manager/categories/{id}` | Cáº­p nháº­t danh má»¥c | MANAGER, ADMIN |
| DELETE | `/api/manager/categories/{id}` | XÃ³a danh má»¥c | MANAGER, ADMIN |
### 1.2 PhÃ¢n Quyá»n Chi Tiáº¿t

#### ğŸ” ADMIN Permissions
- **Quáº£n lÃ½ há»‡ thá»‘ng**: Táº¡o/sá»­a/xÃ³a Manager, Store, Category
- **Báº£o máº­t nÃ¢ng cao**: Whitelist IP, Blocked IP, Risk Management
- **GiÃ¡m sÃ¡t toÃ n diá»‡n**: User Monitoring, Activity Logs, Alerts
- **BÃ¡o cÃ¡o tá»•ng há»£p**: Cross-store analytics, Revenue forecasting
- **Cáº¥u hÃ¬nh há»‡ thá»‘ng**: Payment methods, Shipping, Notifications

#### ğŸ‘¨â€ğŸ’¼ MANAGER Permissions  
- **Quáº£n lÃ½ Ä‘Æ¡n hÃ ng**: Xem, cáº­p nháº­t tráº¡ng thÃ¡i, xá»­ lÃ½ hoÃ n tiá»n
- **Quáº£n lÃ½ sáº£n pháº©m**: CRUD drinks, toppings, categories trong store
- **Live Chat**: TÆ° váº¥n khÃ¡ch hÃ ng, há»— trá»£ Ä‘áº·t hÃ ng realtime
- **Voucher Management**: Táº¡o mÃ£ giáº£m giÃ¡, theo dÃµi usage
- **Analytics**: Dashboard store, doanh thu, top products
- **Staff Management**: Quáº£n lÃ½ nhÃ¢n viÃªn trong cá»­a hÃ ng

### 1.3 Luá»“ng Hoáº¡t Äá»™ng ChÃ­nh

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MANAGER WORKFLOW                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ğŸŒ… BUá»”I SÃNG:                                             â”‚
â”‚  â”œâ”€â”€ ğŸ“Š Kiá»ƒm tra Dashboard - Doanh thu hÃ´m qua            â”‚
â”‚  â”œâ”€â”€ ğŸ“¦ Xem Ä‘Æ¡n hÃ ng má»›i - Cáº­p nháº­t tráº¡ng thÃ¡i            â”‚
â”‚  â”œâ”€â”€ ğŸ’¬ Äá»c tin nháº¯n Live Chat - Pháº£n há»“i khÃ¡ch hÃ ng      â”‚
â”‚  â”œâ”€â”€ ğŸ« Kiá»ƒm tra voucher - Táº¡o khuyáº¿n mÃ£i má»›i             â”‚
â”‚  â””â”€â”€ ğŸµ Cáº­p nháº­t menu - ThÃªm/sá»­a sáº£n pháº©m                 â”‚
â”‚                                                             â”‚
â”‚  ğŸŒ TRONG NGÃ€Y:                                            â”‚
â”‚  â”œâ”€â”€ ğŸ“± Nháº­n notification Ä‘Æ¡n hÃ ng má»›i                     â”‚
â”‚  â”œâ”€â”€ ğŸ’¬ Chat realtime vá»›i khÃ¡ch hÃ ng                       â”‚
â”‚  â”œâ”€â”€ ğŸ“¦ Xá»­ lÃ½ Ä‘Æ¡n hÃ ng: PENDING â†’ CONFIRMED â†’ DELIVERED   â”‚
â”‚  â”œâ”€â”€ ğŸ›¡ï¸ Theo dÃµi alerts tá»« há»‡ thá»‘ng monitoring            â”‚
â”‚  â””â”€â”€ ğŸ“ˆ Xem realtime analytics                            â”‚
â”‚                                                             â”‚
â”‚  ğŸŒ™ BUá»”I Tá»I:                                              â”‚
â”‚  â”œâ”€â”€ ğŸ“Š Xem bÃ¡o cÃ¡o doanh thu ngÃ y                         â”‚
â”‚  â”œâ”€â”€ ğŸ“ˆ PhÃ¢n tÃ­ch xu hÆ°á»›ng bÃ¡n hÃ ng                        â”‚
â”‚  â”œâ”€â”€ ğŸ¯ LÃªn káº¿ hoáº¡ch khuyáº¿n mÃ£i ngÃ y mai                   â”‚
â”‚  â”œâ”€â”€ ğŸ‘¥ ÄÃ¡nh giÃ¡ hiá»‡u suáº¥t nhÃ¢n viÃªn                       â”‚
â”‚  â””â”€â”€ ğŸ’¡ Dá»± bÃ¡o nhu cáº§u sáº£n pháº©m                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```### 1
.4 TÃ­nh NÄƒng Ná»•i Báº­t

#### ğŸš€ Real-time Features
- **Live Chat**: WebSocket-based chat vá»›i khÃ¡ch hÃ ng
- **Order Notifications**: Push notifications cho Ä‘Æ¡n hÃ ng má»›i
- **Dashboard Updates**: Cáº­p nháº­t metrics realtime
- **Monitoring Alerts**: Cáº£nh bÃ¡o báº£o máº­t tá»©c thá»i

#### ğŸ¤– AI & Automation
- **Smart Forecasting**: Dá»± bÃ¡o doanh thu dá»±a trÃªn lá»‹ch sá»­
- **Auto Voucher**: Tá»± Ä‘á»™ng táº¡o voucher theo rules
- **Risk Detection**: PhÃ¡t hiá»‡n hÃ nh vi báº¥t thÆ°á»ng
- **Peak Hours Analysis**: PhÃ¢n tÃ­ch giá» cao Ä‘iá»ƒm

#### ğŸ›¡ï¸ Security & Monitoring
- **IP Whitelist**: Chá»‰ cho phÃ©p IP tin cáº­y truy cáº­p
- **Blocked IP**: Tá»± Ä‘á»™ng cháº·n IP Ä‘á»™c háº¡i
- **User Monitoring**: Theo dÃµi hÃ nh vi ngÆ°á»i dÃ¹ng
- **Activity Logs**: Ghi log táº¥t cáº£ hoáº¡t Ä‘á»™ng

#### ğŸ“Š Advanced Analytics
- **Multi-dimensional Reports**: BÃ¡o cÃ¡o Ä‘a chiá»u
- **Cohort Analysis**: PhÃ¢n tÃ­ch nhÃ³m khÃ¡ch hÃ ng
- **A/B Testing**: Test hiá»‡u quáº£ khuyáº¿n mÃ£i
- **Predictive Analytics**: Dá»± Ä‘oÃ¡n xu hÆ°á»›ng

---

## 2. KIáº¾N TRÃšC Há»† THá»NG

### 2.1 SÆ¡ Äá»“ Kiáº¿n TrÃºc Backend
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ANDROID APP (Kotlin)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ManagerActivity  â”‚  â”‚ManagerSettings  â”‚  â”‚ ManageOrders    â”‚     â”‚
â”‚  â”‚                 â”‚  â”‚ Fragment        â”‚  â”‚ Fragment        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚           â”‚                    â”‚                    â”‚               â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                â”‚                                    â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                    â”‚    RetrofitClient     â”‚                        â”‚
â”‚                    â”‚    (ApiService)       â”‚                        â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ HTTP/HTTPS
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SPRING BOOT BACKEND                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    SECURITY FILTERS                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚BlockedIPFilterâ”‚â†’â”‚JwtAuthFilter â”‚â†’â”‚WhitelistIPFilter â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      CONTROLLERS                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ManagerControllerâ”‚  â”‚WhitelistedIP  â”‚  â”‚ ForecastControllerâ”‚ â”‚ â”‚
â”‚  â”‚  â”‚                â”‚  â”‚ Controller     â”‚  â”‚                 â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚             â”‚                   â”‚                   â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                       SERVICES                                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ ManagerService â”‚  â”‚WhitelistedIP   â”‚  â”‚ ForecastService â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                â”‚  â”‚ Service        â”‚  â”‚                 â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚             â”‚                   â”‚                   â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                     REPOSITORIES                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚OrderRepository â”‚  â”‚WhitelistedIP   â”‚  â”‚ UserRepository  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                â”‚  â”‚ Repository     â”‚  â”‚                 â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚             â”‚                   â”‚                   â”‚               â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                 â–¼                                   â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                    â”‚      MySQL 8.0        â”‚                        â”‚
â”‚                    â”‚   (Database Server)   â”‚                        â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```##
# 2.2 Cáº¥u TrÃºc File Backend
```
Backend_APP/src/main/java/com/utetea/backend/
â”œâ”€â”€ controller/
â”‚   â”œâ”€â”€ ManagerController.java      # API quáº£n lÃ½ cho Manager
â”‚   â”œâ”€â”€ WhitelistedIPController.java # API quáº£n lÃ½ Whitelist IP
â”‚   â”œâ”€â”€ BlockedIPController.java    # API quáº£n lÃ½ Blocked IP
â”‚   â”œâ”€â”€ DrinkController.java        # API quáº£n lÃ½ sáº£n pháº©m
â”‚   â””â”€â”€ PromotionController.java    # API quáº£n lÃ½ voucher
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ ManagerService.java         # Business logic Manager
â”‚   â”œâ”€â”€ WhitelistedIPService.java   # Logic Whitelist IP
â”‚   â”œâ”€â”€ BlockedIPService.java       # Logic Blocked IP
â”‚   â”œâ”€â”€ DrinkService.java           # Logic quáº£n lÃ½ sáº£n pháº©m
â”‚   â”œâ”€â”€ PromotionService.java       # Logic voucher/khuyáº¿n mÃ£i
â”‚   â””â”€â”€ ForecastService.java        # Dá»± bÃ¡o doanh thu, nhÃ¢n sá»±
â”œâ”€â”€ filter/
â”‚   â”œâ”€â”€ JwtAuthenticationFilter.java # XÃ¡c thá»±c JWT
â”‚   â”œâ”€â”€ BlockedIPFilter.java        # Cháº·n IP bá»‹ block
â”‚   â””â”€â”€ WhitelistIPFilter.java      # Kiá»ƒm tra Whitelist IP
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ User.java                   # Entity User
â”‚   â”œâ”€â”€ Order.java                  # Entity Order
â”‚   â”œâ”€â”€ WhitelistedIP.java          # Entity Whitelist IP
â”‚   â”œâ”€â”€ BlockedIP.java              # Entity Blocked IP
â”‚   â”œâ”€â”€ Drink.java                  # Entity Sáº£n pháº©m
â”‚   â””â”€â”€ Promotion.java              # Entity Voucher
â””â”€â”€ repository/
    â”œâ”€â”€ UserRepository.java
    â”œâ”€â”€ OrderRepository.java
    â”œâ”€â”€ WhitelistedIPRepository.java
    â”œâ”€â”€ BlockedIPRepository.java
    â”œâ”€â”€ DrinkRepository.java
    â””â”€â”€ PromotionRepository.java
```

---

## 3. QUáº¢N LÃ ÄÆ N HÃ€NG

### 3.1 Luá»“ng Cáº­p Nháº­t Tráº¡ng ThÃ¡i ÄÆ¡n HÃ ng
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FLOW: Cáº¬P NHáº¬T TRáº NG THÃI ÄÆ N HÃ€NG                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Manager App  â”‚
    â”‚ (Android)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 1. PUT /api/manager/orders/{id}/status?status=MAKING
           â”‚    Header: Authorization: Bearer <JWT>
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    SECURITY FILTERS                          â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
    â”‚  â”‚ BlockedIPFilterâ”‚ â†’ Kiá»ƒm tra IP cÃ³ bá»‹ block khÃ´ng          â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
    â”‚          â”‚ âœ… IP khÃ´ng bá»‹ block                              â”‚
    â”‚          â–¼                                                   â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
    â”‚  â”‚JwtAuthFilter   â”‚ â†’ XÃ¡c thá»±c JWT token                     â”‚
    â”‚  â”‚                â”‚ â†’ Extract username, role tá»« token        â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
    â”‚          â”‚ âœ… Token há»£p lá»‡, role = MANAGER                   â”‚
    â”‚          â–¼                                                   â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
    â”‚  â”‚WhitelistFilter â”‚ â†’ Kiá»ƒm tra IP cÃ³ trong whitelist         â”‚
    â”‚  â”‚                â”‚   (Chá»‰ Ã¡p dá»¥ng cho ADMIN/MANAGER)        â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
    â”‚          â”‚ âœ… IP trong whitelist (hoáº·c tÃ­nh nÄƒng táº¯t)        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   ManagerController                          â”‚
    â”‚  @PutMapping("/orders/{orderId}/status")                     â”‚
    â”‚  @PreAuthorize("hasAnyRole('MANAGER', 'ADMIN')")             â”‚
    â”‚                                                              â”‚
    â”‚  2. Validate status parameter (PENDING, MAKING, DONE...)     â”‚
    â”‚  3. Gá»i managerService.updateOrderStatus(orderId, newStatus) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    ManagerService                            â”‚
    â”‚                                                              â”‚
    â”‚  4. getCurrentManager() â†’ Láº¥y user tá»« SecurityContext        â”‚
    â”‚  5. getManagedStoreIds(manager) â†’ Láº¥y danh sÃ¡ch store IDs    â”‚
    â”‚     - ADMIN: return null (quáº£n lÃ½ táº¥t cáº£)                    â”‚
    â”‚     - MANAGER: return list store IDs Ä‘Æ°á»£c gÃ¡n                â”‚
    â”‚                                                              â”‚
    â”‚  6. orderRepository.findById(orderId) â†’ Láº¥y order            â”‚
    â”‚                                                              â”‚
    â”‚  7. validateStoreAccess(manager, order.store.id)             â”‚
    â”‚     - ADMIN: bá» qua kiá»ƒm tra                                 â”‚
    â”‚     - MANAGER: kiá»ƒm tra order.store.id cÃ³ trong storeIds     â”‚
    â”‚       â†’ Náº¿u khÃ´ng cÃ³ quyá»n: throw BusinessException          â”‚
    â”‚                                                              â”‚
    â”‚  8. orderService.updateOrderStatus(orderId, newStatus)       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     OrderService                             â”‚
    â”‚                                                              â”‚
    â”‚  9. Validate transition há»£p lá»‡:                              â”‚
    â”‚     PENDING â†’ MAKING â†’ SHIPPING â†’ READY â†’ DONE               â”‚
    â”‚     Báº¥t ká»³ â†’ CANCELED                                        â”‚
    â”‚                                                              â”‚
    â”‚  10. order.setStatus(newStatus)                              â”‚
    â”‚  11. orderRepository.save(order)                             â”‚
    â”‚                                                              â”‚
    â”‚  12. Gá»­i thÃ´ng bÃ¡o:                                          â”‚
    â”‚      - WebSocket: notifyOrderStatusChange(order)             â”‚
    â”‚      - Push: oneSignalService.sendToUser(...)                â”‚
    â”‚      - Email: emailService.sendOrderStatusEmail(...)         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                      RESPONSE                                â”‚
    â”‚  {                                                           â”‚
    â”‚    "success": true,                                          â”‚
    â”‚    "message": "Order status updated",                        â”‚
    â”‚    "data": { ...order details... }                           â”‚
    â”‚  }                                                           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```### 3.2
 Tráº¡ng ThÃ¡i ÄÆ¡n HÃ ng (OrderStatus)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VÃ’NG Äá»œI ÄÆ N HÃ€NG                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ PENDING  â”‚â”€â”€â”€â”€â–¶â”‚  MAKING  â”‚â”€â”€â”€â”€â–¶â”‚ SHIPPING â”‚â”€â”€â”€â”€â–¶â”‚  READY   â”‚
    â”‚ (Chá» xá»­  â”‚     â”‚ (Äang    â”‚     â”‚ (Äang    â”‚     â”‚ (Sáºµn     â”‚
    â”‚  lÃ½)     â”‚     â”‚  pha cháº¿)â”‚     â”‚  giao)   â”‚     â”‚  sÃ ng)   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚                â”‚                â”‚
         â”‚                â”‚                â”‚                â–¼
         â”‚                â”‚                â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   DONE   â”‚
         â”‚                â”‚                            â”‚ (HoÃ n    â”‚
         â”‚                â”‚                            â”‚  thÃ nh)  â”‚
         â”‚                â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚
         â–¼                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       CANCELED           â”‚
    â”‚   (ÄÃ£ há»§y - cÃ³ thá»ƒ      â”‚
    â”‚    há»§y tá»« báº¥t ká»³        â”‚
    â”‚    tráº¡ng thÃ¡i nÃ o)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. QUáº¢N LÃ NGÆ¯á»œI DÃ™NG

### 4.1 Luá»“ng KhÃ³a/Má»Ÿ KhÃ³a TÃ i Khoáº£n
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FLOW: KHÃ“A/Má» KHÃ“A TÃ€I KHOáº¢N                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Manager App  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ PUT /api/manager/users/{userId}/block?blocked=true
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   ManagerController                          â”‚
    â”‚  @PreAuthorize("hasAnyRole('MANAGER', 'ADMIN')")             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    ManagerService                            â”‚
    â”‚                                                              â”‚
    â”‚  1. getCurrentManager() â†’ Láº¥y current user                   â”‚
    â”‚                                                              â”‚
    â”‚  2. userRepository.findById(userId) â†’ Láº¥y target user        â”‚
    â”‚                                                              â”‚
    â”‚  3. KIá»‚M TRA QUYá»€N:                                          â”‚
    â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚     â”‚ if (targetUser.role == ADMIN)                       â”‚  â”‚
    â”‚     â”‚   â†’ throw "KhÃ´ng thá»ƒ khÃ³a tÃ i khoáº£n Admin"          â”‚  â”‚
    â”‚     â”‚                                                     â”‚  â”‚
    â”‚     â”‚ if (currentUser.role == MANAGER &&                  â”‚  â”‚
    â”‚     â”‚     targetUser.role == MANAGER)                     â”‚  â”‚
    â”‚     â”‚   â†’ throw "Manager khÃ´ng cÃ³ quyá»n khÃ³a Manager khÃ¡c"â”‚  â”‚
    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                              â”‚
    â”‚  4. user.setIsBlocked(blocked)                               â”‚
    â”‚     user.setActive(!blocked)                                 â”‚
    â”‚                                                              â”‚
    â”‚  5. userRepository.save(user)                                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Luá»“ng NÃ¢ng Cáº¥p User â†’ Manager (CHá»ˆ ADMIN)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FLOW: NÃ‚NG Cáº¤P USER â†’ MANAGER                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Admin App   â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ PUT /api/manager/users/{userId}/promote
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    ManagerService                            â”‚
    â”‚                                                              â”‚
    â”‚  1. requireAdminRole() â†’ Kiá»ƒm tra current user lÃ  ADMIN      â”‚
    â”‚     â†’ Náº¿u khÃ´ng pháº£i ADMIN: throw BusinessException          â”‚
    â”‚                                                              â”‚
    â”‚  2. userRepository.findById(userId) â†’ Láº¥y target user        â”‚
    â”‚                                                              â”‚
    â”‚  3. KIá»‚M TRA:                                                â”‚
    â”‚     - Náº¿u Ä‘Ã£ lÃ  MANAGER â†’ throw "ÄÃ£ lÃ  Manager"              â”‚
    â”‚     - Náº¿u lÃ  ADMIN â†’ throw "KhÃ´ng thá»ƒ thay Ä‘á»•i role Admin"   â”‚
    â”‚     - Náº¿u bá»‹ khÃ³a â†’ throw "KhÃ´ng thá»ƒ nÃ¢ng cáº¥p tÃ i khoáº£n bá»‹   â”‚
    â”‚                            khÃ³a"                             â”‚
    â”‚                                                              â”‚
    â”‚  4. user.setRole(UserRole.MANAGER)                           â”‚
    â”‚                                                              â”‚
    â”‚  5. userRepository.save(user)                                â”‚
    â”‚                                                              â”‚
    â”‚  âš ï¸ LÆ¯U Ã: Sau khi nÃ¢ng cáº¥p, Admin cáº§n GÃN STORE cho        â”‚
    â”‚     Manager má»›i Ä‘á»ƒ há» cÃ³ thá»ƒ quáº£n lÃ½ Ä‘Æ¡n hÃ ng                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```-
--

## 5. QUáº¢N LÃ Cá»¬A HÃ€NG

### 5.1 Má»‘i Quan Há»‡ Manager - Store
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    QUAN Há»† MANAGER - STORE                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                         ADMIN                                   â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ Quáº£n lÃ½ Táº¤T Cáº¢ stores (khÃ´ng cáº§n gÃ¡n)                   â”‚   â”‚
    â”‚  â”‚ getManagedStoreIds() â†’ return null (xem táº¥t cáº£)         â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                        MANAGER A                                â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ managedStores = [Store 1, Store 2]                      â”‚   â”‚
    â”‚  â”‚ getManagedStoreIds() â†’ return [1, 2]                    â”‚   â”‚
    â”‚  â”‚                                                         â”‚   â”‚
    â”‚  â”‚ âœ… CÃ³ thá»ƒ xem/cáº­p nháº­t Ä‘Æ¡n hÃ ng cá»§a Store 1, Store 2    â”‚   â”‚
    â”‚  â”‚ âŒ KhÃ´ng thá»ƒ xem Ä‘Æ¡n hÃ ng cá»§a Store 3                   â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                        MANAGER B                                â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ managedStores = [] (chÆ°a Ä‘Æ°á»£c gÃ¡n)                      â”‚   â”‚
    â”‚  â”‚ getManagedStoreIds() â†’ return [] (empty list)           â”‚   â”‚
    â”‚  â”‚                                                         â”‚   â”‚
    â”‚  â”‚ âš ï¸ KhÃ´ng thá»ƒ xem báº¥t ká»³ Ä‘Æ¡n hÃ ng nÃ o                    â”‚   â”‚
    â”‚  â”‚ âš ï¸ Dashboard hiá»ƒn thá»‹ empty                             â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Má»‘i Quan Há»‡ Manager - Store

**Cáº¥u trÃºc quan há»‡ Many-to-Many:**
- Má»™t Manager cÃ³ thá»ƒ quáº£n lÃ½ nhiá»u Store
- Má»™t Store cÃ³ thá»ƒ cÃ³ nhiá»u Manager
- ADMIN cÃ³ quyá»n truy cáº­p táº¥t cáº£ Store (khÃ´ng cáº§n gÃ¡n)

---

## 6. QUáº¢N LÃ Sáº¢N PHáº¨M & DANH Má»¤C

### 6.1 Tá»•ng Quan Quáº£n LÃ½ Sáº£n Pháº©m
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    QUáº¢N LÃ Sáº¢N PHáº¨M (DRINK)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“‹ CHá»¨C NÄ‚NG CHÃNH:                                               â”‚
â”‚  â”œâ”€â”€ ThÃªm/Sá»­a/XÃ³a sáº£n pháº©m (Drink)                                â”‚
â”‚  â”œâ”€â”€ Quáº£n lÃ½ danh má»¥c (Category)                                   â”‚
â”‚  â”œâ”€â”€ Quáº£n lÃ½ topping                                               â”‚
â”‚  â”œâ”€â”€ Quáº£n lÃ½ size vÃ  giÃ¡                                           â”‚
â”‚  â”œâ”€â”€ Upload/Quáº£n lÃ½ hÃ¬nh áº£nh sáº£n pháº©m                              â”‚
â”‚  â””â”€â”€ KÃ­ch hoáº¡t/VÃ´ hiá»‡u hÃ³a sáº£n pháº©m                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 Cáº¥u TrÃºc Dá»¯ Liá»‡u Sáº£n Pháº©m

**Entities chÃ­nh:**
- **Category**: Danh má»¥c sáº£n pháº©m (TrÃ  sá»¯a, CÃ  phÃª, Sinh tá»‘...)
- **Drink**: Sáº£n pháº©m chÃ­nh vá»›i thÃ´ng tin cÆ¡ báº£n
- **DrinkSize**: Size vÃ  giÃ¡ cá»§a tá»«ng sáº£n pháº©m (S, M, L)
- **Topping**: Topping cÃ³ thá»ƒ thÃªm vÃ o
- **DrinkTopping**: Quan há»‡ drink-topping vá»›i giÃ¡

### 6.3 Luá»“ng Quáº£n LÃ½ Sáº£n Pháº©m
```
Manager/Admin â†’ DrinkController â†’ DrinkService â†’ Database
                      â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚         DrinkService Methods            â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚  â€¢ createDrink()                        â”‚
              â”‚  â€¢ updateDrink()                        â”‚
              â”‚  â€¢ deleteDrink()                        â”‚
              â”‚  â€¢ toggleAvailability()                 â”‚
              â”‚  â€¢ uploadDrinkImage()                   â”‚
              â”‚  â€¢ addTopping()                         â”‚
              â”‚  â€¢ removeTopping()                      â”‚
              â”‚  â€¢ updatePricing()                      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```-
--

## 7. QUáº¢N LÃ VOUCHER & KHUYáº¾N MÃƒI

### 7.1 Tá»•ng Quan Há»‡ Thá»‘ng Voucher
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Há»† THá»NG VOUCHER & KHUYáº¾N MÃƒI                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ« LOáº I VOUCHER:                                                  â”‚
â”‚  â”œâ”€â”€ Giáº£m giÃ¡ theo % (PERCENTAGE)                                  â”‚
â”‚  â”œâ”€â”€ Giáº£m giÃ¡ cá»‘ Ä‘á»‹nh (FIXED_AMOUNT)                              â”‚
â”‚  â”œâ”€â”€ Miá»…n phÃ­ ship (FREE_SHIPPING)                                â”‚
â”‚  â”œâ”€â”€ Mua 1 táº·ng 1 (BUY_ONE_GET_ONE)                              â”‚
â”‚  â””â”€â”€ Voucher sinh nháº­t (BIRTHDAY_SPECIAL)                         â”‚
â”‚                                                                     â”‚
â”‚  ğŸ¯ ÄIá»€U KIá»†N ÃP Dá»¤NG:                                            â”‚
â”‚  â”œâ”€â”€ GiÃ¡ trá»‹ Ä‘Æ¡n hÃ ng tá»‘i thiá»ƒu                                   â”‚
â”‚  â”œâ”€â”€ Sá»‘ lÆ°á»£ng sá»­ dá»¥ng giá»›i háº¡n                                    â”‚
â”‚  â”œâ”€â”€ Thá»i gian hiá»‡u lá»±c                                           â”‚
â”‚  â”œâ”€â”€ Ãp dá»¥ng cho user cá»¥ thá»ƒ                                      â”‚
â”‚  â””â”€â”€ Ãp dá»¥ng cho sáº£n pháº©m/danh má»¥c cá»¥ thá»ƒ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 Luá»“ng Táº¡o & Ãp Dá»¥ng Voucher
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Táº O VOUCHER                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Manager Input:                                                     â”‚
â”‚  â”œâ”€â”€ MÃ£ voucher (VD: SUMMER2024)                                   â”‚
â”‚  â”œâ”€â”€ Loáº¡i giáº£m giÃ¡                                                 â”‚
â”‚  â”œâ”€â”€ GiÃ¡ trá»‹ giáº£m                                                  â”‚
â”‚  â”œâ”€â”€ Äiá»u kiá»‡n Ã¡p dá»¥ng                                             â”‚
â”‚  â””â”€â”€ Thá»i gian hiá»‡u lá»±c                                            â”‚
â”‚                           â†“                                         â”‚
â”‚  PromotionService.createPromotion()                                 â”‚
â”‚  â”œâ”€â”€ Validate mÃ£ voucher unique                                    â”‚
â”‚  â”œâ”€â”€ Validate thá»i gian há»£p lá»‡                                     â”‚
â”‚  â”œâ”€â”€ Validate Ä‘iá»u kiá»‡n logic                                      â”‚
â”‚  â”œâ”€â”€ Check trÃ¹ng mÃ£ voucher                                        â”‚
â”‚  â”œâ”€â”€ LÆ°u vÃ o database                                              â”‚
â”‚  â””â”€â”€ Log activity cho monitoring                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 Luá»“ng Ãp Dá»¥ng Voucher Khi Äáº·t HÃ ng
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ÃP Dá»¤NG VOUCHER                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  User nháº­p mÃ£ voucher â†’ CartService.applyVoucher()                 â”‚
â”‚                           â†“                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 VALIDATION STEPS                            â”‚   â”‚
â”‚  â”‚  1. Kiá»ƒm tra voucher tá»“n táº¡i                               â”‚   â”‚
â”‚  â”‚  2. Kiá»ƒm tra cÃ²n hiá»‡u lá»±c (start_date, end_date)           â”‚   â”‚
â”‚  â”‚  3. Kiá»ƒm tra cÃ²n lÆ°á»£t sá»­ dá»¥ng (usage_limit)               â”‚   â”‚
â”‚  â”‚  4. Kiá»ƒm tra user Ä‘Ã£ dÃ¹ng chÆ°a (per_user_limit)           â”‚   â”‚
â”‚  â”‚  5. Kiá»ƒm tra giÃ¡ trá»‹ Ä‘Æ¡n hÃ ng tá»‘i thiá»ƒu                    â”‚   â”‚
â”‚  â”‚  6. Kiá»ƒm tra sáº£n pháº©m Ã¡p dá»¥ng (náº¿u cÃ³)                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                         â”‚
â”‚  âœ… TÃ­nh toÃ¡n giáº£m giÃ¡:                                            â”‚
â”‚  â”œâ”€â”€ PERCENTAGE: orderTotal * (discount_value / 100)               â”‚
â”‚  â”œâ”€â”€ FIXED_AMOUNT: discount_value                                  â”‚
â”‚  â”œâ”€â”€ FREE_SHIPPING: shipping_fee                                   â”‚
â”‚  â””â”€â”€ Ãp dá»¥ng max_discount_amount (náº¿u cÃ³)                          â”‚
â”‚                           â†“                                         â”‚
â”‚  ğŸ’¾ LÆ°u vÃ o promotion_usages khi order thÃ nh cÃ´ng                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. LIVE CHAT Há»– TRá»¢

### 8.1 Tá»•ng Quan Live Chat System
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      LIVE CHAT SYSTEM                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ’¬ CHá»¨C NÄ‚NG CHÃNH:                                               â”‚
â”‚  â”œâ”€â”€ Chat realtime giá»¯a Customer vÃ  Manager                        â”‚
â”‚  â”œâ”€â”€ Há»— trá»£ tÆ° váº¥n sáº£n pháº©m                                       â”‚
â”‚  â”œâ”€â”€ Xá»­ lÃ½ khiáº¿u náº¡i vÃ  há»— trá»£ ká»¹ thuáº­t                           â”‚
â”‚  â”œâ”€â”€ LÆ°u trá»¯ lá»‹ch sá»­ há»™i thoáº¡i                                     â”‚
â”‚  â”œâ”€â”€ Typing indicator (Ä‘ang gÃµ...)                                â”‚
â”‚  â”œâ”€â”€ File/Image sharing                                            â”‚
â”‚  â””â”€â”€ Auto-assign Manager theo store                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 Luá»“ng Chat Realtime
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    REALTIME CHAT FLOW                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Customer App â”‚                              â”‚ Manager App  â”‚
    â”‚              â”‚                              â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                             â”‚
           â”‚ 1. Táº¡o conversation                         â”‚
           â”‚ POST /api/chat/conversations                â”‚
           â–¼                                             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   ChatService                                â”‚
    â”‚  â€¢ Táº¡o conversation má»›i                                      â”‚
    â”‚  â€¢ Auto-assign Manager theo store gáº§n nháº¥t                   â”‚
    â”‚  â€¢ Gá»­i WebSocket notification cho Manager                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                             â”‚
           â”‚ 2. Gá»­i tin nháº¯n                            â”‚
           â”‚ POST /api/chat/messages                     â”‚
           â–¼                                             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 WebSocket Server                             â”‚
    â”‚  â€¢ LÆ°u message vÃ o database                                  â”‚
    â”‚  â€¢ Broadcast Ä‘áº¿n táº¥t cáº£ participants                         â”‚
    â”‚  â€¢ Update conversation last_message                          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                             â”‚
           â”‚ 3. Realtime message delivery                â”‚
           â–¼                                             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Customer     â”‚â—„â”€â”€â”€â”€â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Manager      â”‚
    â”‚ receives     â”‚        /topic/chat/{convId}  â”‚ receives     â”‚
    â”‚ message      â”‚                              â”‚ message      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```---

### 15.7 DrinkService - Quáº£n LÃ½ Sáº£n Pháº©m

#### getAllActiveDrinks() - Tá»‘i Æ¯u N+1 Query
```java
/**
 * FIX N+1 QUERY: Load táº¥t cáº£ drinks vá»›i sizes trong 1 query,
 * sau Ä‘Ã³ batch load toppings
 */
@Transactional(readOnly = true)
@Cacheable(value = DRINKS_CACHE, key = "'all-active'")
public List<DrinkDto> getAllActiveDrinks() {
    // Query 1: Load drinks vá»›i sizes vÃ  category (JOIN FETCH)
    List<Drink> drinks = drinkRepository.findByIsActiveTrueWithSizesAndCategory();
    
    if (drinks.isEmpty()) {
        return List.of();
    }
    
    // Query 2: Batch load toppings cho táº¥t cáº£ drinks
    List<Long> drinkIds = drinks.stream().map(Drink::getId).collect(Collectors.toList());
    Map<Long, List<DrinkTopping>> toppingsMap = loadToppingsForDrinks(drinkIds);
    
    // Query 3: Load global toppings (drink_id = NULL)
    List<DrinkTopping> globalToppings = drinkToppingRepository.findByDrinkIdIsNullAndIsActiveTrue();
    
    return drinks.stream()
        .map(drink -> mapToDtoOptimized(drink, toppingsMap.get(drink.getId()), globalToppings))
        .collect(Collectors.toList());
}
```

**Giáº£i thÃ­ch:**
- **@Cacheable**: Cache káº¿t quáº£ Ä‘á»ƒ trÃ¡nh query láº¡i
- **JOIN FETCH**: Load sizes vÃ  category trong 1 query
- **Batch Load**: Load toppings cho táº¥t cáº£ drinks cÃ¹ng lÃºc
- **Global Toppings**: Toppings Ã¡p dá»¥ng cho táº¥t cáº£ drinks (drink_id = NULL)

#### searchDrinks() - TÃ¬m Kiáº¿m An ToÃ n
```java
@Transactional(readOnly = true)
public List<DrinkDto> searchDrinks(String keyword) {
    // Input sanitization: validate and clean keyword
    if (keyword == null || keyword.trim().isEmpty()) {
        return List.of();
    }
    
    // Sanitize: remove special characters, keep Vietnamese characters
    String sanitized = keyword.replaceAll(
        "[^a-zA-Z0-9\\sÃ Ã¡áº¡áº£Ã£Ã¢áº§áº¥áº­áº©áº«Äƒáº±áº¯áº·áº³áºµÃ¨Ã©áº¹áº»áº½Ãªá»áº¿á»‡á»ƒá»…Ã¬Ã­á»‹á»‰Ä©Ã²Ã³á»á»ÃµÃ´á»“á»‘á»™á»•á»—Æ¡á»á»›á»£á»Ÿá»¡Ã¹Ãºá»¥á»§Å©Æ°á»«á»©á»±á»­á»¯á»³Ã½á»µá»·á»¹Ä‘Ã€Ãáº áº¢ÃƒÃ‚áº¦áº¤áº¬áº¨áºªÄ‚áº°áº®áº¶áº²áº´ÃˆÃ‰áº¸áººáº¼ÃŠá»€áº¾á»†á»‚á»„ÃŒÃá»Šá»ˆÄ¨Ã’Ã“á»Œá»Ã•Ã”á»’á»á»˜á»”á»–Æ á»œá»šá»¢á»á» Ã™Ãšá»¤á»¦Å¨Æ¯á»ªá»¨á»°á»¬á»®á»²Ãá»´á»¶á»¸Ä]", 
        "");
    
    // Giá»›i háº¡n Ä‘á»™ dÃ i Ä‘á»ƒ trÃ¡nh DoS
    if (sanitized.length() > 100) {
        sanitized = sanitized.substring(0, 100);
    }
    
    if (sanitized.trim().isEmpty()) {
        return List.of();
    }
    
    List<Drink> drinks = drinkRepository.searchByNameWithSizesAndCategory(sanitized);
    // ... batch load toppings vÃ  map to DTO
}
```

**Giáº£i thÃ­ch:**
- **Input Sanitization**: Loáº¡i bá» kÃ½ tá»± Ä‘áº·c biá»‡t Ä‘á»ƒ trÃ¡nh SQL injection
- **Vietnamese Support**: Giá»¯ láº¡i kÃ½ tá»± tiáº¿ng Viá»‡t
- **Length Limit**: Giá»›i háº¡n 100 kÃ½ tá»± Ä‘á»ƒ trÃ¡nh DoS attack

#### createDrink() - Táº¡o Sáº£n Pháº©m Má»›i
```java
@Transactional
@CacheEvict(value = DRINKS_CACHE, allEntries = true)
public DrinkDto createDrink(DrinkDto dto) {
    Drink drink = new Drink();
    drink.setName(dto.getName());
    drink.setDescription(dto.getDescription());
    drink.setImageUrl(dto.getImageUrl());
    drink.setBasePrice(dto.getBasePrice());
    drink.setIsActive(true);
    
    drink = drinkRepository.save(drink);
    return mapToDto(drink);
}
```

**Giáº£i thÃ­ch:**
- **@CacheEvict**: XÃ³a cache khi táº¡o má»›i Ä‘á»ƒ Ä‘áº£m báº£o data consistency
- **allEntries = true**: XÃ³a táº¥t cáº£ entries trong cache

---

### 15.8 PromotionService - Quáº£n LÃ½ Voucher

#### validatePromotion() - Core Validation Method
```java
/**
 * âœ… SECURITY: VALIDATE PROMOTION - CORE METHOD
 * Kiá»ƒm tra táº¥t cáº£ Ä‘iá»u kiá»‡n cá»§a voucher
 */
private void validatePromotion(Promotion promotion, BigDecimal orderAmount, Long userId) {
    LocalDateTime now = LocalDateTime.now();
    
    // 1. Check active
    if (!promotion.getIsActive()) {
        throw new BusinessException("MÃ£ voucher Ä‘Ã£ bá»‹ vÃ´ hiá»‡u hÃ³a");
    }
    
    // 2. Check thá»i gian báº¯t Ä‘áº§u
    if (now.isBefore(promotion.getStartDate())) {
        throw new BusinessException("MÃ£ voucher chÆ°a cÃ³ hiá»‡u lá»±c");
    }
    
    // 3. Check thá»i gian káº¿t thÃºc
    if (now.isAfter(promotion.getEndDate())) {
        throw new VoucherExpiredException(
            "MÃ£ voucher Ä‘Ã£ háº¿t háº¡n vÃ o " + promotion.getEndDate()
        );
    }
    
    // 4. Check usage limit (tá»•ng sá»‘ láº§n dÃ¹ng)
    if (promotion.getUsageLimit() != null && 
        promotion.getUsedCount() >= promotion.getUsageLimit()) {
        throw new BusinessException("MÃ£ voucher Ä‘Ã£ háº¿t lÆ°á»£t sá»­ dá»¥ng");
    }
    
    // 5. âœ… SECURITY: Check user Ä‘Ã£ dÃ¹ng voucher nÃ y chÆ°a
    if (userId != null) {
        boolean hasUsed = promotionUsageRepository.existsByPromotionIdAndUserId(
            promotion.getId(), userId
        );
        
        if (hasUsed) {
            throw new VoucherAlreadyUsedException(
                "Báº¡n Ä‘Ã£ sá»­ dá»¥ng mÃ£ voucher nÃ y rá»“i"
            );
        }
    }
    
    // 6. Check minimum order value
    if (orderAmount != null && orderAmount.compareTo(promotion.getMinOrderValue()) < 0) {
        throw new BusinessException(String.format(
            "GiÃ¡ trá»‹ Ä‘Æ¡n hÃ ng tá»‘i thiá»ƒu lÃ  %s VND cho mÃ£ voucher nÃ y", 
            promotion.getMinOrderValue()
        ));
    }
}
```

**Giáº£i thÃ­ch:**
- **6 bÆ°á»›c validation**: Kiá»ƒm tra Ä‘áº§y Ä‘á»§ táº¥t cáº£ Ä‘iá»u kiá»‡n
- **Custom Exceptions**: VoucherExpiredException, VoucherAlreadyUsedException
- **User-specific check**: Kiá»ƒm tra user Ä‘Ã£ dÃ¹ng voucher chÆ°a

#### createPromotion() - Táº¡o Voucher Má»›i
```java
@Transactional
@CacheEvict(value = PROMOTIONS_CACHE, allEntries = true)
public PromotionDto createPromotion(CreatePromotionRequest request) {
    log.info("Creating new promotion with code: {}", request.getCode());
    
    // Validate code uniqueness
    if (promotionRepository.findByCode(request.getCode()).isPresent()) {
        throw new BusinessException("MÃ£ voucher Ä‘Ã£ tá»“n táº¡i: " + request.getCode());
    }
    
    // Validate dates
    if (request.getEndDate().isBefore(request.getStartDate())) {
        throw new BusinessException("NgÃ y káº¿t thÃºc pháº£i sau ngÃ y báº¯t Ä‘áº§u");
    }
    
    // Validate discount value for PERCENT type
    if (request.getDiscountType() == DiscountType.PERCENT) {
        if (request.getDiscountValue().compareTo(BigDecimal.valueOf(100)) > 0) {
            throw new BusinessException("GiÃ¡ trá»‹ giáº£m giÃ¡ pháº§n trÄƒm khÃ´ng Ä‘Æ°á»£c vÆ°á»£t quÃ¡ 100%");
        }
    }
    
    Promotion promotion = Promotion.builder()
            .code(request.getCode().toUpperCase())
            .description(request.getDescription())
            .discountType(request.getDiscountType())
            .discountValue(request.getDiscountValue())
            .startDate(request.getStartDate())
            .endDate(request.getEndDate())
            .minOrderValue(request.getMinOrderValue())
            .maxDiscountAmount(request.getMaxDiscountAmount())
            .usageLimit(request.getUsageLimit())
            .usedCount(0)
            .isActive(request.getIsActive())
            .build();
    
    promotion = promotionRepository.save(promotion);
    
    // Gá»­i thÃ´ng bÃ¡o voucher má»›i cho táº¥t cáº£ user
    if (promotion.getIsActive()) {
        String title = "ğŸ‰ Voucher má»›i dÃ nh cho báº¡n!";
        String content = promotion.getDescription() + " - MÃ£: " + promotion.getCode();
        oneSignalService.sendToAll(title, content, NotificationType.PROMOTION, promotion.getId());
    }
    
    return promotionMapper.toDto(promotion);
}
```

**Giáº£i thÃ­ch:**
- **Code Uniqueness**: Kiá»ƒm tra mÃ£ voucher khÃ´ng trÃ¹ng
- **Date Validation**: NgÃ y káº¿t thÃºc pháº£i sau ngÃ y báº¯t Ä‘áº§u
- **Percent Validation**: Giáº£m giÃ¡ % khÃ´ng Ä‘Æ°á»£c > 100%
- **Push Notification**: Gá»­i thÃ´ng bÃ¡o cho táº¥t cáº£ user khi táº¡o voucher má»›i

---

### 15.9 OrderService - Xá»­ LÃ½ ÄÆ¡n HÃ ng

#### previewBill() - Xem TrÆ°á»›c HÃ³a ÄÆ¡n
```java
/**
 * Preview bill trÆ°á»›c khi thanh toÃ¡n
 * TÃ­nh toÃ¡n chi tiáº¿t Ä‘Æ¡n hÃ ng, giÃ¡ tiá»n, giáº£m giÃ¡ Ä‘á»ƒ user xem trÆ°á»›c
 */
@Transactional(readOnly = true)
public BillPreviewDto previewBill(String username, OrderRequest request) {
    log.info("Generating bill preview for user: {}", username);
    
    // Validate request
    validateOrderRequest(request);
    
    // Get user info
    User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new ResourceNotFoundException("User", "username", username));
    
    // Get store info
    Store store = storeRepository.findById(request.getStoreId())
            .orElseThrow(() -> new ResourceNotFoundException("Store", "id", request.getStoreId()));
    
    // Calculate items
    List<BillPreviewDto.BillItemDto> billItems = new ArrayList<>();
    BigDecimal subtotal = BigDecimal.ZERO;
    
    for (OrderItemRequest itemReq : request.getItems()) {
        Drink drink = drinkRepository.findById(itemReq.getDrinkId())
                .orElseThrow(() -> new ResourceNotFoundException("Drink", "id", itemReq.getDrinkId()));
        
        if (!drink.getIsActive()) {
            throw new BusinessException("Drink '" + drink.getName() + "' is not available");
        }
        
        BigDecimal unitPrice = drink.getBasePrice();
        
        // Add size price
        // Add toppings price
        // ... (tÃ­nh toÃ¡n chi tiáº¿t)
        
        BigDecimal itemTotal = unitPrice.multiply(BigDecimal.valueOf(itemReq.getQuantity()));
        subtotal = subtotal.add(itemTotal);
        
        billItems.add(BillPreviewDto.BillItemDto.builder()
                .drinkName(drink.getName())
                .sizeName(itemReq.getSizeName())
                .quantity(itemReq.getQuantity())
                .unitPrice(unitPrice)
                .totalPrice(itemTotal)
                .build());
    }
    
    // Calculate discount (voucher + tier)
    BigDecimal voucherDiscount = calculateVoucherDiscount(request, subtotal);
    BigDecimal tierDiscount = memberTierService.calculateTierDiscount(user.getMemberTier(), subtotal);
    
    // Calculate shipping fee
    BigDecimal shippingFee = calculateShippingFee(request, user, subtotal);
    
    // Final price
    BigDecimal totalDiscount = voucherDiscount.add(tierDiscount);
    BigDecimal finalPrice = subtotal.add(shippingFee).subtract(totalDiscount);
    
    return BillPreviewDto.builder()
            .items(billItems)
            .subtotal(subtotal)
            .shippingFee(shippingFee)
            .voucherDiscount(voucherDiscount)
            .tierDiscountAmount(tierDiscount)
            .totalDiscount(totalDiscount)
            .finalPrice(finalPrice)
            .build();
}
```

**Giáº£i thÃ­ch:**
- **Preview trÆ°á»›c khi Ä‘áº·t**: User xem trÆ°á»›c tá»•ng tiá»n trÆ°á»›c khi thanh toÃ¡n
- **TÃ­nh toÃ¡n Ä‘áº§y Ä‘á»§**: GiÃ¡ sáº£n pháº©m + size + topping + voucher + tier discount + shipping
- **Free Shipping**: Kiá»ƒm tra Ä‘iá»u kiá»‡n miá»…n phÃ­ ship theo háº¡ng thÃ nh viÃªn

#### createOrder() - Táº¡o ÄÆ¡n HÃ ng
```java
@Transactional
public OrderDto createOrder(String username, OrderRequest request) {
    log.info("Creating order for user: {}, store: {}", username, request.getStoreId());

    // âœ… SECURITY: VALIDATE REQUEST TRÆ¯á»šC KHI Xá»¬ LÃ
    validateOrderRequest(request);

    // Validate user
    User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new ResourceNotFoundException("User", "username", username));

    if (!user.getActive()) {
        throw new BusinessException("User account is inactive", HttpStatus.FORBIDDEN);
    }
    
    // âœ… SECURITY: Check rate limit (20 Ä‘Æ¡n/giá» per user)
    rateLimitService.checkOrderRateLimit(user.getId());

    // Validate store
    Store store = storeRepository.findById(request.getStoreId())
            .orElseThrow(() -> new ResourceNotFoundException("Store", "id", request.getStoreId()));

    Order order = new Order();
    order.setUser(user);
    order.setStore(store);
    order.setType(request.getType());
    order.setStatus(OrderStatus.PENDING);
    order.setPaymentMethod(request.getPaymentMethod());

    // TÃ­nh toÃ¡n items vÃ  giÃ¡
    BigDecimal totalPrice = calculateOrderItems(order, request);
    
    // Apply voucher vá»›i PESSIMISTIC_WRITE lock Ä‘á»ƒ trÃ¡nh race condition
    BigDecimal discount = applyVoucherWithLock(request, totalPrice, order);
    
    // Apply tier discount (cá»™ng dá»“n vá»›i voucher)
    BigDecimal tierDiscount = memberTierService.calculateTierDiscount(user.getMemberTier(), totalPrice);
    discount = discount.add(tierDiscount);
    
    order.setDiscount(discount);
    
    // Calculate shipping fee vá»›i free ship check
    BigDecimal shippingFee = calculateShippingWithFreeShipCheck(request, user, totalPrice);
    order.setShippingFee(shippingFee);
    
    // Final price = totalPrice + shippingFee - discount
    BigDecimal finalPrice = totalPrice.add(shippingFee).subtract(discount);
    if (finalPrice.compareTo(BigDecimal.ZERO) < 0) {
        finalPrice = BigDecimal.ZERO;
    }
    order.setFinalPrice(finalPrice);

    order = orderRepository.save(order);
    log.info("Order created successfully with id: {}", order.getId());

    // ğŸ›¡ï¸ Log activity - Táº¡o Ä‘Æ¡n hÃ ng (Monitoring)
    userMonitoringService.logOrderCreate(user.getId(), order.getId(), 
        order.getFinalPrice().doubleValue(), RequestContextUtil.getCurrentRequest());

    // Notifications
    orderWebSocketService.notifyNewOrder(orderDto);      // WebSocket
    emailService.sendOrderConfirmationEmail(order);       // Email
    sendNotificationToManagers(order);                    // Push to Manager

    return mapToDto(order);
}
```

**Giáº£i thÃ­ch:**
- **Rate Limiting**: Giá»›i háº¡n 20 Ä‘Æ¡n/giá» per user Ä‘á»ƒ trÃ¡nh spam
- **PESSIMISTIC_WRITE Lock**: TrÃ¡nh race condition khi dÃ¹ng voucher
- **Tier Discount**: Cá»™ng dá»“n vá»›i voucher discount
- **Free Shipping**: Kiá»ƒm tra Ä‘iá»u kiá»‡n miá»…n phÃ­ ship
- **Multi-channel Notifications**: WebSocket + Email + Push

#### updateOrderStatus() - Cáº­p Nháº­t Tráº¡ng ThÃ¡i
```java
@Transactional
public OrderDto updateOrderStatus(Long orderId, OrderStatus newStatus) {
    log.info("Updating order {} status to {}", orderId, newStatus);

    Order order = orderRepository.findById(orderId)
            .orElseThrow(() -> new ResourceNotFoundException("Order", "id", orderId));

    // Validate transition há»£p lá»‡
    validateStatusTransition(order.getStatus(), newStatus);

    Long userId = order.getUser() != null ? order.getUser().getId() : null;
    
    order.setStatus(newStatus);
    order = orderRepository.save(order);
    orderRepository.flush();

    OrderDto orderDto = mapToDto(order);
    
    // Xá»­ lÃ½ cÃ¡c tÃ¡c vá»¥ phá»¥ trong thread riÃªng
    final Order finalOrder = order;
    final Long finalUserId = userId;
    
    new Thread(() -> {
        processPostStatusUpdate(finalOrder, orderDto, newStatus, finalUserId, orderId);
    }).start();

    return orderDto;
}

/**
 * Validate transition há»£p lá»‡ giá»¯a cÃ¡c tráº¡ng thÃ¡i
 */
private void validateStatusTransition(OrderStatus current, OrderStatus newStatus) {
    // PENDING â†’ MAKING â†’ SHIPPING â†’ READY â†’ DONE
    // Báº¥t ká»³ â†’ CANCELED
    
    if (newStatus == OrderStatus.CANCELED) {
        return; // LuÃ´n cho phÃ©p há»§y
    }
    
    // Kiá»ƒm tra transition há»£p lá»‡
    Map<OrderStatus, List<OrderStatus>> validTransitions = Map.of(
        OrderStatus.PENDING, List.of(OrderStatus.MAKING, OrderStatus.CANCELED),
        OrderStatus.MAKING, List.of(OrderStatus.SHIPPING, OrderStatus.READY, OrderStatus.CANCELED),
        OrderStatus.SHIPPING, List.of(OrderStatus.READY, OrderStatus.DONE, OrderStatus.CANCELED),
        OrderStatus.READY, List.of(OrderStatus.DONE, OrderStatus.CANCELED)
    );
    
    if (!validTransitions.getOrDefault(current, List.of()).contains(newStatus)) {
        throw new BusinessException("Invalid status transition: " + current + " â†’ " + newStatus);
    }
}
```

**Giáº£i thÃ­ch:**
- **Status Transition Validation**: Chá»‰ cho phÃ©p chuyá»ƒn tráº¡ng thÃ¡i há»£p lá»‡
- **Async Post-processing**: Xá»­ lÃ½ notifications trong thread riÃªng
- **Monitoring**: Log activity khi há»§y Ä‘Æ¡n

---

### 15.10 AuthService - XÃ¡c Thá»±c & ÄÄƒng KÃ½

#### login() - ÄÄƒng Nháº­p
```java
@Transactional
public LoginResponse login(LoginRequest request) {
    log.debug("Login attempt for: {}", request.getUsernameOrPhone());

    // Láº¥y HttpServletRequest Ä‘á»ƒ ghi log monitoring
    HttpServletRequest httpRequest = getHttpServletRequest();

    try {
        // Authenticate vá»›i Spring Security
        authenticationManager.authenticate(
            new UsernamePasswordAuthenticationToken(
                request.getUsernameOrPhone(),
                request.getPassword()
            )
        );
    } catch (BadCredentialsException e) {
        // ğŸ›¡ï¸ Ghi log Ä‘Äƒng nháº­p tháº¥t báº¡i cho monitoring
        userMonitoringService.logLoginFailed(request.getUsernameOrPhone(), httpRequest);
        throw new BusinessException("Invalid credentials");
    }

    User user = userRepository.findByUsernameOrPhone(
        request.getUsernameOrPhone(),
        request.getUsernameOrPhone()
    ).orElseThrow(() -> new BusinessException("Invalid credentials"));

    // Kiá»ƒm tra tÃ i khoáº£n bá»‹ khÃ³a
    if (user.getIsBlocked()) {
        throw new BusinessException("Account is blocked");
    }

    if (!user.getActive()) {
        throw new BusinessException("Account is inactive");
    }

    // ğŸ›¡ï¸ Ghi log Ä‘Äƒng nháº­p thÃ nh cÃ´ng
    userMonitoringService.logLoginSuccess(user.getId(), httpRequest);
    
    // ğŸš¨ Check thiáº¿t bá»‹/IP má»›i
    checkNewDeviceLogin(user.getId(), httpRequest);

    // Generate tokens
    UserDetails userDetails = userDetailsService.loadUserByUsername(user.getUsername());
    String accessToken = jwtUtil.generateToken(userDetails, user.getRole().name());
    String refreshToken = jwtUtil.generateRefreshToken(userDetails);

    return mapToLoginResponse(user, accessToken, refreshToken);
}
```

**Giáº£i thÃ­ch:**
- **Spring Security Authentication**: Sá»­ dá»¥ng AuthenticationManager
- **Monitoring Integration**: Log cáº£ thÃ nh cÃ´ng vÃ  tháº¥t báº¡i
- **New Device Detection**: PhÃ¡t hiá»‡n Ä‘Äƒng nháº­p tá»« thiáº¿t bá»‹ má»›i
- **Dual Token**: Access token + Refresh token

#### registerWithOtp() - ÄÄƒng KÃ½ Vá»›i OTP
```java
@Transactional
public void registerWithOtp(RegisterRequest request) {
    // Validate uniqueness
    if (userRepository.existsByUsername(request.getUsername())) {
        throw new BusinessException("Username already exists");
    }
    if (userRepository.existsByEmail(request.getEmail())) {
        throw new BusinessException("Email already exists");
    }

    // Táº¡o user vá»›i tráº¡ng thÃ¡i inactive
    User user = new User();
    user.setUsername(request.getUsername());
    user.setEmail(request.getEmail());
    user.setPassword(passwordEncoder.encode(request.getPassword()));
    user.setRole(UserRole.USER);
    user.setMemberTier(MemberTier.BRONZE);
    user.setPoints(0);
    user.setActive(false);  // ChÆ°a active
    user.setIsBlocked(false);
    
    // Táº¡o OTP vÃ  gÃ¡n vÃ o user
    String otp = otpService.generateOtp();
    user.setOtp(otp);
    user.setOtpExpiry(LocalDateTime.now().plusMinutes(5)); // 5 phÃºt

    user = userRepository.save(user);

    // Gá»­i OTP qua email
    otpService.sendOtp(otp, request.getEmail());
}
```

**Giáº£i thÃ­ch:**
- **OTP Flow**: Táº¡o user inactive â†’ Gá»­i OTP â†’ Verify â†’ Active
- **Password Encoding**: BCrypt encryption
- **Default Tier**: BRONZE vá»›i 0 Ä‘iá»ƒm
- **OTP Expiry**: 5 phÃºt

---

### 15.11 CartService - Giá» HÃ ng

#### addToCart() - ThÃªm VÃ o Giá» HÃ ng
```java
@Transactional
public CartDto addToCart(Long userId, AddToCartRequest request) {
    // Láº¥y hoáº·c táº¡o cart cho user
    Cart cart = cartRepository.findByUserId(userId)
            .orElseGet(() -> {
                User user = userRepository.findById(userId)
                        .orElseThrow(() -> new ResourceNotFoundException("User not found"));
                Cart newCart = new Cart();
                newCart.setUser(user);
                newCart.setItems(new ArrayList<>());
                return cartRepository.save(newCart);
            });
    
    // Láº¥y thÃ´ng tin drink
    Drink drink = drinkRepository.findById(request.getDrinkId())
            .orElseThrow(() -> new ResourceNotFoundException("Drink not found"));
    
    // TÃ­nh giÃ¡: basePrice + sizePrice + toppingsPrice
    BigDecimal unitPrice = drink.getBasePrice();
    
    // Add size price
    if (request.getSizeId() != null) {
        DrinkSize size = drinkSizeRepository.findById(request.getSizeId())
                .orElseThrow(() -> new ResourceNotFoundException("Size not found"));
        unitPrice = unitPrice.add(size.getExtraPrice());
    }
    
    // Add toppings price
    List<DrinkTopping> toppings = new ArrayList<>();
    if (request.getToppingIds() != null && !request.getToppingIds().isEmpty()) {
        toppings = drinkToppingRepository.findAllById(request.getToppingIds());
        for (DrinkTopping topping : toppings) {
            unitPrice = unitPrice.add(topping.getPrice());
        }
    }
    
    BigDecimal totalPrice = unitPrice.multiply(BigDecimal.valueOf(request.getQuantity()));
    
    // Táº¡o cart item
    CartItem cartItem = new CartItem();
    cartItem.setCart(cart);
    cartItem.setDrink(drink);
    cartItem.setQuantity(request.getQuantity());
    cartItem.setUnitPrice(unitPrice.doubleValue());
    cartItem.setTotalPrice(totalPrice.doubleValue());
    cartItem.setToppings(toppings);
    
    cart.getItems().add(cartItem);
    cartItemRepository.save(cartItem);
    
    // ğŸ›¡ï¸ Log activity - ThÃªm vÃ o giá» hÃ ng
    userMonitoringService.logCartAddItem(userId, drink.getName(), request.getQuantity(), 
        RequestContextUtil.getCurrentRequest());
    
    return getCart(userId);
}
```

#### reorderFromHistory() - Äáº·t Láº¡i ÄÆ¡n HÃ ng
```java
@Transactional
public ReorderResponse reorderFromHistory(Long userId, Long orderId) {
    // Láº¥y Ä‘Æ¡n hÃ ng cÅ©
    Order order = orderRepository.findByIdWithItems(orderId)
            .orElseThrow(() -> new ResourceNotFoundException("Order", "id", orderId));
    
    // Verify user owns this order
    if (!order.getUser().getId().equals(userId)) {
        throw new IllegalArgumentException("Báº¡n khÃ´ng cÃ³ quyá»n Ä‘áº·t láº¡i Ä‘Æ¡n hÃ ng nÃ y");
    }
    
    List<ReorderResponse.ReorderItemStatus> itemStatuses = new ArrayList<>();
    boolean hasUnavailableItems = false;
    int addedCount = 0;
    
    for (OrderItem orderItem : order.getItems()) {
        // Kiá»ƒm tra drink cÃ²n bÃ¡n khÃ´ng
        Drink drink = orderItem.getDrink();
        if (drink == null || !drink.getIsActive()) {
            // TÃ¬m gá»£i Ã½ thay tháº¿
            List<SuggestionDto> suggestions = findSimilarDrinks(drink, orderItem.getDrinkNameSnapshot());
            itemStatuses.add(ReorderItemStatus.builder()
                    .drinkName(orderItem.getDrinkNameSnapshot())
                    .drinkAvailable(false)
                    .addedToCart(false)
                    .suggestions(suggestions)
                    .build());
            hasUnavailableItems = true;
            continue;
        }
        
        // Kiá»ƒm tra size vÃ  toppings cÃ²n khÃ´ng
        // ThÃªm vÃ o giá» hÃ ng vá»›i cÃ¡c item cÃ²n available
        // ...
        addedCount++;
    }
    
    return ReorderResponse.builder()
            .cart(getCart(userId))
            .itemStatuses(itemStatuses)
            .hasUnavailableItems(hasUnavailableItems)
            .message(hasUnavailableItems ? 
                "Má»™t sá»‘ mÃ³n khÃ´ng cÃ²n bÃ¡n" : "ÄÃ£ thÃªm táº¥t cáº£ mÃ³n vÃ o giá» hÃ ng")
            .build();
}
```

**Giáº£i thÃ­ch:**
- **Smart Reorder**: Kiá»ƒm tra mÃ³n cÃ²n bÃ¡n khÃ´ng, gá»£i Ã½ thay tháº¿
- **Partial Success**: ThÃªm Ä‘Æ°á»£c mÃ³n nÃ o thÃ¬ thÃªm, bÃ¡o lá»—i mÃ³n khÃ´ng cÃ³
- **Suggestions**: TÃ¬m mÃ³n tÆ°Æ¡ng tá»± trong cÃ¹ng category

---

### 15.12 LiveChatService - Chat Realtime

#### startConversation() - Báº¯t Äáº§u Há»™i Thoáº¡i
```java
@Transactional
public ConversationDto startConversation(String username, StartConversationRequest request) {
    User user = userRepository.findByUsername(username)
        .orElseThrow(() -> new ResourceNotFoundException("User", "username", username));

    // Validate storeId - báº¯t buá»™c pháº£i chá»n chi nhÃ¡nh
    if (request.getStoreId() == null) {
        throw new BusinessException("Vui lÃ²ng chá»n chi nhÃ¡nh Ä‘á»ƒ Ä‘Æ°á»£c tÆ° váº¥n");
    }
    
    Store store = storeRepository.findById(request.getStoreId())
        .orElseThrow(() -> new ResourceNotFoundException("Store", "id", request.getStoreId()));

    // Kiá»ƒm tra conversation Ä‘ang active vá»›i store nÃ y
    var existingConversation = conversationRepository.findActiveByUserIdAndStoreId(user.getId(), store.getId());
    if (existingConversation.isPresent()) {
        // Tiáº¿p tá»¥c conversation cÅ©
        ChatConversation conversation = existingConversation.get();
        
        if (request.getInitialMessage() != null) {
            // ThÃªm tin nháº¯n má»›i
            LiveChatMessage message = new LiveChatMessage();
            message.setConversation(conversation);
            message.setSender(user);
            message.setContent(request.getInitialMessage());
            message.setSenderType(SenderType.USER);
            messageRepository.save(message);
            
            // Notify qua WebSocket
            webSocketService.notifyNewMessage(conversation.getId(), mapMessageToDto(message));
            
            // Push notification cho Manager
            sendPushToManagersAndAdmin(store, user, "ğŸ’¬ Tin nháº¯n tÆ° váº¥n má»›i", 
                    user.getFullName() + ": " + truncateMessage(request.getInitialMessage()), 
                    conversation.getId());
        }
        
        return mapToDto(conversation);
    }

    // Táº¡o conversation má»›i
    ChatConversation conversation = new ChatConversation();
    conversation.setUser(user);
    conversation.setStore(store);
    conversation.setStatus(ConversationStatus.WAITING);
    conversation.setSubject(request.getSubject());
    conversation = conversationRepository.save(conversation);

    // Notify managers vá» conversation má»›i
    webSocketService.notifyNewConversation(mapToDto(conversation));
    sendPushToManagersAndAdmin(store, user, "ğŸ’¬ YÃªu cáº§u tÆ° váº¥n má»›i", 
            user.getFullName() + " cáº§n tÆ° váº¥n táº¡i " + store.getStoreName(), 
            conversation.getId());

    return mapToDto(conversation);
}
```

#### sendMessage() - Gá»­i Tin Nháº¯n
```java
@Transactional
public MessageDto sendMessage(String username, SendMessageRequest request) {
    User sender = userRepository.findByUsername(username)
        .orElseThrow(() -> new ResourceNotFoundException("User", "username", username));

    ChatConversation conversation = conversationRepository.findById(request.getConversationId())
        .orElseThrow(() -> new ResourceNotFoundException("Conversation", "id", request.getConversationId()));

    // Kiá»ƒm tra conversation Ä‘Ã£ Ä‘Ã³ng chÆ°a
    if (conversation.getStatus() == ConversationStatus.CLOSED) {
        throw new BusinessException("Cuá»™c há»™i thoáº¡i Ä‘Ã£ Ä‘Ã³ng");
    }

    // Validate quyá»n gá»­i tin nháº¯n
    boolean isUser = conversation.getUser().getId().equals(sender.getId());
    boolean isAdmin = sender.getRole() == UserRole.ADMIN;
    boolean isManager = sender.getRole() == UserRole.MANAGER;
    
    // Manager pháº£i quáº£n lÃ½ store cá»§a conversation nÃ y
    if (isManager && !isAdmin && !canManagerAccessConversation(sender, conversation)) {
        throw new BusinessException("Báº¡n khÃ´ng cÃ³ quyá»n tÆ° váº¥n cho chi nhÃ¡nh nÃ y");
    }

    // Táº¡o tin nháº¯n
    LiveChatMessage message = new LiveChatMessage();
    message.setConversation(conversation);
    message.setSender(sender);
    message.setContent(request.getContent());
    message.setSenderType((isManager || isAdmin) ? SenderType.MANAGER : SenderType.USER);
    message = messageRepository.save(message);

    // Cáº­p nháº­t unread count
    if (isUser) {
        conversation.setUnreadManager(conversation.getUnreadManager() + 1);
    } else {
        conversation.setUnreadUser(conversation.getUnreadUser() + 1);
        // Manager tiáº¿p nháº­n conversation
        if (conversation.getStatus() == ConversationStatus.WAITING) {
            conversation.setStatus(ConversationStatus.ACTIVE);
            conversation.setManager(sender);
        }
    }
    conversationRepository.save(conversation);

    // Notify qua WebSocket
    MessageDto dto = mapMessageToDto(message);
    webSocketService.notifyNewMessage(conversation.getId(), dto);

    // Push notification
    if (isUser) {
        sendPushToManagersAndAdmin(conversation.getStore(), sender, "ğŸ’¬ Tin nháº¯n má»›i", ...);
    } else {
        sendPushToUser(conversation.getUser(), "ğŸ’¬ Pháº£n há»“i tá»« nhÃ¢n viÃªn", ...);
    }

    return dto;
}
```

**Giáº£i thÃ­ch:**
- **Store-based Routing**: Conversation gáº¯n vá»›i store cá»¥ thá»ƒ
- **Manager Access Control**: Manager chá»‰ xem conversation cá»§a stores Ä‘Æ°á»£c gÃ¡n
- **Conversation Status**: WAITING â†’ ACTIVE â†’ CLOSED
- **Dual Notification**: WebSocket realtime + Push notification

---

### 15.13 ForecastService - Dá»± BÃ¡o Doanh Thu

#### calculateRevenueForecast() - Dá»± BÃ¡o Doanh Thu
```java
@Transactional(readOnly = true)
public RevenueForecast calculateRevenueForecast() {
    RevenueForecast forecast = new RevenueForecast();
    
    // Láº¥y dá»¯ liá»‡u lá»‹ch sá»­ theo ngÃ y trong tuáº§n (cÃ³ trá»ng sá»‘)
    // Tuáº§n gáº§n nháº¥t cÃ³ trá»ng sá»‘ cao hÆ¡n (RECENT_WEIGHT = 3, OLDER_WEIGHT = 1)
    Map<DayOfWeek, BigDecimal> weightedAvgRevenue = getWeightedAvgRevenueByDayOfWeek();
    
    // Dá»± bÃ¡o hÃ´m nay
    LocalDate today = LocalDate.now();
    BigDecimal todayForecast = weightedAvgRevenue.getOrDefault(today.getDayOfWeek(), BigDecimal.ZERO);
    
    // Ãp dá»¥ng há»‡ sá»‘ mÃ¹a (thÃ¡ng 6-7 nÃ³ng â†’ +20%)
    todayForecast = applySeasonalFactor(todayForecast, today);
    
    // Ãp dá»¥ng há»‡ sá»‘ ngÃ y Ä‘áº·c biá»‡t (Valentine, GiÃ¡ng sinh â†’ +30%)
    todayForecast = applySpecialDateFactor(todayForecast, today);
    
    // Äiá»u chá»‰nh theo tiáº¿n Ä‘á»™ trong ngÃ y (real-time adjustment)
    int currentHour = LocalDateTime.now().getHour();
    if (currentHour >= 8 && currentHour < 22) {
        BigDecimal todayActual = getTodayRevenue();
        double progressRatio = (currentHour - 8) / 14.0; // 8h-22h = 14 tiáº¿ng
        
        if (progressRatio > 0.2 && todayActual.compareTo(BigDecimal.ZERO) > 0) {
            // Blend giá»¯a dá»± bÃ¡o vÃ  thá»±c táº¿
            BigDecimal projectedFromActual = todayActual.divide(BigDecimal.valueOf(progressRatio), 2, RoundingMode.HALF_UP);
            
            double actualWeight = Math.min(progressRatio * 1.5, 0.8); // Max 80%
            todayForecast = projectedFromActual.multiply(BigDecimal.valueOf(actualWeight))
                .add(todayForecast.multiply(BigDecimal.valueOf(1 - actualWeight)));
        }
    }
    
    forecast.setTodayForecast(todayForecast);
    // ... tÃ­nh toÃ¡n tÆ°Æ¡ng tá»± cho tomorrow, week, month
    
    return forecast;
}
```

**Giáº£i thÃ­ch:**
- **Weighted Moving Average**: Tuáº§n gáº§n nháº¥t cÃ³ trá»ng sá»‘ cao hÆ¡n
- **Seasonal Factors**: Äiá»u chá»‰nh theo mÃ¹a (hÃ¨ nÃ³ng â†’ bÃ¡n nhiá»u hÆ¡n)
- **Special Dates**: NgÃ y lá»… tÄƒng 30%
- **Real-time Adjustment**: Blend dá»± bÃ¡o vá»›i thá»±c táº¿ trong ngÃ y

---

### 15.14 MemberTierService - Háº¡ng ThÃ nh ViÃªn

#### calculateTierDiscount() - TÃ­nh Giáº£m GiÃ¡ Theo Háº¡ng
```java
public BigDecimal calculateTierDiscount(MemberTier tier, BigDecimal orderTotal) {
    TierBenefits benefits = tierConfig.getBenefits(tier);
    if (benefits.getDiscountPercent().compareTo(BigDecimal.ZERO) > 0) {
        return orderTotal.multiply(benefits.getDiscountPercent())
                .divide(BigDecimal.valueOf(100), 2, RoundingMode.HALF_UP);
    }
    return BigDecimal.ZERO;
}
```

#### isEligibleForFreeShipping() - Kiá»ƒm Tra Miá»…n PhÃ­ Ship
```java
public boolean isEligibleForFreeShipping(MemberTier tier, BigDecimal orderTotal) {
    TierBenefits benefits = tierConfig.getBenefits(tier);
    if (!benefits.isFreeShipping()) {
        return false;
    }
    return orderTotal.compareTo(benefits.getFreeShippingMinOrder()) >= 0;
}
```

#### checkAndUpgradeTier() - Kiá»ƒm Tra & NÃ¢ng Háº¡ng
```java
@Transactional
public MemberTier checkAndUpgradeTier(String username) {
    User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new ResourceNotFoundException("User not found"));
    
    MemberTier newTier = tierConfig.getTierByPoints(user.getPoints());
    
    if (newTier != user.getMemberTier()) {
        MemberTier oldTier = user.getMemberTier();
        user.setMemberTier(newTier);
        userRepository.save(user);
        
        // ğŸ–ï¸ Gá»­i thÃ´ng bÃ¡o khi lÃªn cáº¥p
        sendTierUpgradeNotification(user, oldTier, newTier);
    }
    
    return user.getMemberTier();
}
```

**Giáº£i thÃ­ch:**
- **4 Tiers**: BRONZE â†’ SILVER â†’ GOLD â†’ PLATINUM
- **Points-based**: Tá»± Ä‘á»™ng nÃ¢ng háº¡ng khi Ä‘á»§ Ä‘iá»ƒm
- **Benefits**: Discount %, free shipping, birthday voucher, priority support
- **Notification**: Push notification khi lÃªn háº¡ng

---

### 15.15 ReviewService - ÄÃ¡nh GiÃ¡ Sáº£n Pháº©m

#### createReview() - Táº¡o ÄÃ¡nh GiÃ¡
```java
@Transactional
public ReviewDto createReview(String username, CreateReviewRequest request) {
    User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new ResourceNotFoundException("User not found"));
    
    // Validate order belongs to user and is DONE
    Order order = orderRepository.findById(request.getOrderId())
            .orElseThrow(() -> new ResourceNotFoundException("Order not found"));
    
    if (!order.getUser().getId().equals(user.getId())) {
        throw new BadRequestException("Order does not belong to this user");
    }
    
    if (order.getStatus() != OrderStatus.DONE) {
        throw new BadRequestException("Can only review completed orders");
    }
    
    // Check if already reviewed
    if (reviewRepository.existsByUserIdAndOrderItemId(user.getId(), request.getOrderItemId())) {
        throw new BadRequestException("You have already reviewed this item");
    }
    
    // Create review
    Review review = new Review();
    review.setUser(user);
    review.setDrink(orderItem.getDrink());
    review.setOrder(order);
    review.setOrderItem(orderItem);
    review.setRating(request.getRating());
    review.setComment(request.getComment());
    review.setIsAnonymous(request.getIsAnonymous());
    
    review = reviewRepository.save(review);
    
    // ğŸ Cá»™ng 1 Ä‘iá»ƒm vÃ²ng quay khi Ä‘Ã¡nh giÃ¡
    userRepository.addPoints(user.getId(), 1);
    
    return toDto(review);
}
```

#### backupUserReviews() - Backup Reviews Khi XÃ³a User
```java
@Transactional
public void backupUserReviews(User user) {
    List<Review> reviews = reviewRepository.findByUserId(user.getId());
    
    for (Review review : reviews) {
        DeletedUserReviewBackup backup = DeletedUserReviewBackup.builder()
                .deletedUserId(user.getId())
                .deletedUsername(user.getUsername())
                .deletedUserFullname(user.getFullName())
                .originalReviewId(review.getId())
                .drinkId(review.getDrink().getId())
                .drinkName(review.getDrink().getName())
                .rating(review.getRating())
                .comment(review.getComment())
                .reviewCreatedAt(review.getCreatedAt())
                .build();
        
        deletedUserReviewBackupRepository.save(backup);
    }
}
```

**Giáº£i thÃ­ch:**
- **Order Validation**: Chá»‰ review Ä‘Æ°á»£c Ä‘Æ¡n hÃ ng DONE cá»§a mÃ¬nh
- **One Review Per Item**: KhÃ´ng cho review trÃ¹ng
- **Anonymous Option**: CÃ³ thá»ƒ Ä‘Ã¡nh giÃ¡ áº©n danh
- **Reward Points**: Cá»™ng Ä‘iá»ƒm khi Ä‘Ã¡nh giÃ¡
- **Backup on Delete**: Giá»¯ láº¡i reviews khi user xÃ³a tÃ i khoáº£n

---

## 16. API REFERENCE

### 9.1 Manager Dashboard Overview
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MANAGER DASHBOARD                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“Š METRICS CHÃNH:                                                 â”‚
â”‚  â”œâ”€â”€ ğŸ’° Doanh thu hÃ´m nay/tuáº§n/thÃ¡ng                               â”‚
â”‚  â”œâ”€â”€ ğŸ“¦ Sá»‘ Ä‘Æ¡n hÃ ng má»›i/Ä‘ang xá»­ lÃ½/hoÃ n thÃ nh                      â”‚
â”‚  â”œâ”€â”€ ğŸ‘¥ Sá»‘ khÃ¡ch hÃ ng má»›i/khÃ¡ch hÃ ng quay láº¡i                      â”‚
â”‚  â”œâ”€â”€ ğŸµ Top sáº£n pháº©m bÃ¡n cháº¡y                                      â”‚
â”‚  â”œâ”€â”€ â­ ÄÃ¡nh giÃ¡ trung bÃ¬nh                                        â”‚
â”‚  â”œâ”€â”€ ğŸ’¬ Sá»‘ tin nháº¯n chat chÆ°a Ä‘á»c                                  â”‚
â”‚  â”œâ”€â”€ ğŸ« Voucher Ä‘Æ°á»£c sá»­ dá»¥ng nhiá»u nháº¥t                           â”‚
â”‚  â””â”€â”€ ğŸ“ˆ Biá»ƒu Ä‘á»“ xu hÆ°á»›ng doanh thu                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 Luá»“ng Láº¥y Dashboard Data
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DASHBOARD DATA FLOW                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Manager App  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ GET /api/manager/dashboard?period=TODAY
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   ManagerController                          â”‚
    â”‚  @GetMapping("/dashboard")                                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    ManagerService                            â”‚
    â”‚                                                              â”‚
    â”‚  1. getCurrentManager() â†’ Láº¥y manager hiá»‡n táº¡i               â”‚
    â”‚  2. getManagedStoreIds() â†’ Láº¥y danh sÃ¡ch stores              â”‚
    â”‚  3. Parallel queries:                                        â”‚
    â”‚     â”œâ”€â”€ getTotalRevenue(storeIds, period)                    â”‚
    â”‚     â”œâ”€â”€ getOrderCounts(storeIds, period)                     â”‚
    â”‚     â”œâ”€â”€ getCustomerStats(storeIds, period)                   â”‚
    â”‚     â”œâ”€â”€ getTopProducts(storeIds, period)                     â”‚
    â”‚     â”œâ”€â”€ getAverageRating(storeIds, period)                   â”‚
    â”‚     â”œâ”€â”€ getUnreadChatCount(storeIds)                         â”‚
    â”‚     â”œâ”€â”€ getVoucherUsage(storeIds, period)                    â”‚
    â”‚     â””â”€â”€ getRevenueChart(storeIds, period)                    â”‚
    â”‚                                                              â”‚
    â”‚  4. Aggregate vÃ  format data                                 â”‚
    â”‚  5. Return DashboardSummaryDto                               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. Dá»° BÃO & PHÃ‚N TÃCH

### 10.1 Revenue Forecasting
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Dá»° BÃO DOANH THU                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ¯ Má»¤C TIÃŠU:                                                      â”‚
â”‚  â”œâ”€â”€ Dá»± bÃ¡o doanh thu 7 ngÃ y tá»›i                                   â”‚
â”‚  â”œâ”€â”€ Dá»± bÃ¡o doanh thu thÃ¡ng tá»›i                                    â”‚
â”‚  â”œâ”€â”€ PhÃ¢n tÃ­ch xu hÆ°á»›ng theo mÃ¹a                                   â”‚
â”‚  â”œâ”€â”€ Dá»± bÃ¡o nhu cáº§u sáº£n pháº©m                                       â”‚
â”‚  â””â”€â”€ Khuyáº¿n nghá»‹ chiáº¿n lÆ°á»£c kinh doanh                             â”‚
â”‚                                                                     â”‚
â”‚  ğŸ§® THUáº¬T TOÃN:                                                    â”‚
â”‚  â”œâ”€â”€ Linear Regression cho xu hÆ°á»›ng cÆ¡ báº£n                         â”‚
â”‚  â”œâ”€â”€ Moving Average cho lÃ m mÆ°á»£t dá»¯ liá»‡u                           â”‚
â”‚  â”œâ”€â”€ Seasonal Adjustment cho yáº¿u tá»‘ mÃ¹a vá»¥                         â”‚
â”‚  â”œâ”€â”€ Weighted Average (gáº§n Ä‘Ã¢y cÃ³ trá»ng sá»‘ cao hÆ¡n)               â”‚
â”‚  â””â”€â”€ External Factors (ngÃ y lá»…, sá»± kiá»‡n, thá»i tiáº¿t)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 Peak Hours Analysis
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PHÃ‚N TÃCH GIá»œ CAO ÄIá»‚M                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“Š PHÃ‚N TÃCH THEO GIá»œ:                                            â”‚
â”‚  â”œâ”€â”€ 06:00-09:00: Giá» sÃ¡ng (cÃ  phÃª, bÃ¡nh mÃ¬)                      â”‚
â”‚  â”œâ”€â”€ 11:00-14:00: Giá» trÆ°a (trÃ  sá»¯a, sinh tá»‘)                     â”‚
â”‚  â”œâ”€â”€ 15:00-17:00: Giá» chiá»u (Ä‘á»“ uá»‘ng giáº£i khÃ¡t)                   â”‚
â”‚  â”œâ”€â”€ 19:00-21:00: Giá» tá»‘i (Ä‘á»“ uá»‘ng thÆ° giÃ£n)                      â”‚
â”‚  â””â”€â”€ 21:00-23:00: Giá» khuya (trÃ  sá»¯a, dessert)                    â”‚
â”‚                                                                     â”‚
â”‚  ğŸ¯ KHUYáº¾N NGHá»Š:                                                   â”‚
â”‚  â”œâ”€â”€ TÄƒng nhÃ¢n sá»± trong giá» cao Ä‘iá»ƒm                               â”‚
â”‚  â”œâ”€â”€ Chuáº©n bá»‹ nguyÃªn liá»‡u trÆ°á»›c giá» rush                          â”‚
â”‚  â”œâ”€â”€ Táº¡o voucher giá» tháº¥p Ä‘iá»ƒm Ä‘á»ƒ kÃ­ch thÃ­ch                      â”‚
â”‚  â””â”€â”€ Optimize menu theo tá»«ng khung giá»                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 11. WHITELIST IP - Báº¢O Máº¬T NÃ‚NG CAO

### 11.1 Tá»•ng Quan Whitelist IP
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      WHITELIST IP SYSTEM                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ›¡ï¸ Má»¤C ÄÃCH:                                                     â”‚
â”‚  â”œâ”€â”€ Chá»‰ cho phÃ©p IP tin cáº­y truy cáº­p chá»©c nÄƒng Manager/Admin      â”‚
â”‚  â”œâ”€â”€ Báº£o vá»‡ khá»i cÃ¡c cuá»™c táº¥n cÃ´ng tá»« IP láº¡                       â”‚
â”‚  â”œâ”€â”€ Kiá»ƒm soÃ¡t truy cáº­p tá»« cÃ¡c Ä‘á»‹a Ä‘iá»ƒm cá»¥ thá»ƒ                     â”‚
â”‚  â”œâ”€â”€ Audit trail cho táº¥t cáº£ hoáº¡t Ä‘á»™ng quáº£n trá»‹                     â”‚
â”‚  â””â”€â”€ Compliance vá»›i cÃ¡c yÃªu cáº§u báº£o máº­t doanh nghiá»‡p               â”‚
â”‚                                                                     â”‚
â”‚  âš™ï¸ Cáº¤U HÃŒNH:                                                      â”‚
â”‚  â”œâ”€â”€ Báº­t/táº¯t tÃ­nh nÄƒng whitelist                                   â”‚
â”‚  â”œâ”€â”€ Ãp dá»¥ng cho ADMIN only hoáº·c cáº£ MANAGER                        â”‚
â”‚  â”œâ”€â”€ Whitelist theo IP cá»¥ thá»ƒ hoáº·c IP range                        â”‚
â”‚  â”œâ”€â”€ Thá»i gian hiá»‡u lá»±c cá»§a tá»«ng IP                               â”‚
â”‚  â””â”€â”€ Ghi chÃº mÃ´ táº£ cho tá»«ng IP entry                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```### 11.2 L
uá»“ng Kiá»ƒm Tra Whitelist
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WHITELIST CHECK FLOW                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Manager/Adminâ”‚
    â”‚ Request      â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ API Request vá»›i IP = 192.168.1.100
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 WhitelistIPFilter                            â”‚
    â”‚                                                              â”‚
    â”‚  1. Extract IP tá»« request                                    â”‚
    â”‚     - X-Forwarded-For header (náº¿u cÃ³ proxy)                 â”‚
    â”‚     - X-Real-IP header                                       â”‚
    â”‚     - request.getRemoteAddr()                                â”‚
    â”‚                                                              â”‚
    â”‚  2. Kiá»ƒm tra user role tá»« JWT                                â”‚
    â”‚     - Náº¿u USER: bá» qua whitelist check                      â”‚
    â”‚     - Náº¿u MANAGER/ADMIN: tiáº¿p tá»¥c check                      â”‚
    â”‚                                                              â”‚
    â”‚  3. Kiá»ƒm tra tÃ­nh nÄƒng cÃ³ báº­t khÃ´ng                          â”‚
    â”‚     - Náº¿u táº¯t: cho phÃ©p táº¥t cáº£                              â”‚
    â”‚     - Náº¿u báº­t: tiáº¿p tá»¥c validate                            â”‚
    â”‚                                                              â”‚
    â”‚  4. whitelistedIPService.isIPWhitelisted(ip)                 â”‚
    â”‚     - Query database tÃ¬m IP                                  â”‚
    â”‚     - Kiá»ƒm tra thá»i gian hiá»‡u lá»±c                           â”‚
    â”‚     - Kiá»ƒm tra IP range (náº¿u cÃ³)                            â”‚
    â”‚                                                              â”‚
    â”‚  5. Káº¿t quáº£:                                                 â”‚
    â”‚     âœ… IP trong whitelist â†’ Cho phÃ©p tiáº¿p tá»¥c               â”‚
    â”‚     âŒ IP khÃ´ng trong whitelist â†’ HTTP 403 Forbidden        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 12. BLOCKED IP - CHáº¶N IP Äá»˜C Háº I

### 12.1 Tá»•ng Quan Blocked IP System
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BLOCKED IP SYSTEM                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸš« Má»¤C ÄÃCH:                                                      â”‚
â”‚  â”œâ”€â”€ Tá»± Ä‘á»™ng cháº·n IP cÃ³ hÃ nh vi báº¥t thÆ°á»ng                         â”‚
â”‚  â”œâ”€â”€ Cháº·n thá»§ cÃ´ng IP Ä‘á»™c háº¡i Ä‘Æ°á»£c bÃ¡o cÃ¡o                         â”‚
â”‚  â”œâ”€â”€ NgÄƒn cháº·n brute force attacks                                 â”‚
â”‚  â”œâ”€â”€ Báº£o vá»‡ khá»i DDoS vÃ  spam requests                            â”‚
â”‚  â””â”€â”€ Blacklist IP tá»« cÃ¡c threat intelligence feeds                 â”‚
â”‚                                                                     â”‚
â”‚  ğŸ¤– Tá»° Äá»˜NG CHáº¶N KHI:                                             â”‚
â”‚  â”œâ”€â”€ 5+ láº§n Ä‘Äƒng nháº­p tháº¥t báº¡i trong 10 phÃºt                      â”‚
â”‚  â”œâ”€â”€ 10+ requests trong 1 phÃºt (rate limiting)                     â”‚
â”‚  â”œâ”€â”€ Cá»‘ gáº¯ng truy cáº­p endpoint khÃ´ng tá»“n táº¡i                       â”‚
â”‚  â”œâ”€â”€ Gá»­i payload Ä‘á»™c háº¡i (SQL injection, XSS)                     â”‚
â”‚  â””â”€â”€ HÃ nh vi bot Ä‘Æ°á»£c phÃ¡t hiá»‡n                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.2 Luá»“ng Auto-Block IP
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AUTO-BLOCK IP FLOW                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Suspicious   â”‚
    â”‚ Activity     â”‚
    â”‚ Detected     â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ VD: 5 láº§n login failed tá»« IP 192.168.1.200
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                           â†“                                  â”‚
    â”‚  Trong quÃ¡ trÃ¬nh xá»­ lÃ½ request:                              â”‚
    â”‚  â”œâ”€â”€ UserMonitoringService phÃ¡t hiá»‡n hÃ nh vi báº¥t thÆ°á»ng     â”‚
    â”‚  â”œâ”€â”€ VD: 5+ login failed, spam requests, brute force        â”‚
    â”‚  â””â”€â”€ Gá»i BlockedIPService.autoBlockIP()                     â”‚
    â”‚                           â†“                                  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚  â”‚              BlockedIPService                       â”‚    â”‚
    â”‚  â”‚                                                     â”‚    â”‚
    â”‚  â”‚  1. Kiá»ƒm tra IP Ä‘Ã£ bá»‹ block chÆ°a                    â”‚    â”‚
    â”‚  â”‚  2. Táº¡o BlockedIP entity:                           â”‚    â”‚
    â”‚  â”‚     - ip_address = "192.168.1.200"                  â”‚    â”‚
    â”‚  â”‚     - reason = "Multiple failed login attempts"     â”‚    â”‚
    â”‚  â”‚     - block_type = "AUTO"                           â”‚    â”‚
    â”‚  â”‚     - blocked_until = now + 24 hours                â”‚    â”‚
    â”‚  â”‚                                                     â”‚    â”‚
    â”‚  â”‚  3. LÆ°u vÃ o database                                â”‚    â”‚
    â”‚  â”‚  4. Gá»­i alert cho Admin                             â”‚    â”‚
    â”‚  â”‚  5. Log security event                              â”‚    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 13. Há»† THá»NG GIÃM SÃT (MONITORING)

### 13.1 Tá»•ng Quan Há»‡ Thá»‘ng Monitoring
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USER MONITORING SYSTEM                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ¯ Má»¤C ÄÃCH:                                                      â”‚
â”‚  â”œâ”€â”€ Theo dÃµi hÃ nh vi ngÆ°á»i dÃ¹ng realtime                          â”‚
â”‚  â”œâ”€â”€ PhÃ¡t hiá»‡n hoáº¡t Ä‘á»™ng báº¥t thÆ°á»ng vÃ  rá»§i ro                      â”‚
â”‚  â”œâ”€â”€ Táº¡o cáº£nh bÃ¡o tá»± Ä‘á»™ng cho Admin                               â”‚
â”‚  â”œâ”€â”€ Audit trail cho compliance                                    â”‚
â”‚  â””â”€â”€ PhÃ¢n tÃ­ch xu hÆ°á»›ng vÃ  pattern                                â”‚
â”‚                                                                     â”‚
â”‚  ğŸ“Š METRICS THEO DÃ•I:                                             â”‚
â”‚  â”œâ”€â”€ Login/Logout activities                                       â”‚
â”‚  â”œâ”€â”€ Order creation vÃ  payment                                     â”‚
â”‚  â”œâ”€â”€ Failed authentication attempts                                â”‚
â”‚  â”œâ”€â”€ API usage patterns                                            â”‚
â”‚  â”œâ”€â”€ Suspicious behaviors                                          â”‚
â”‚  â””â”€â”€ Risk score calculation                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 13.2 Risk Score Calculation
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      RISK SCORE ALGORITHM                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“ˆ TÃNH ÄIá»‚M Rá»¦I RO (0-100):                                     â”‚
â”‚                                                                     â”‚
â”‚  Base Score = 0                                                     â”‚
â”‚                                                                     â”‚
â”‚  â• TÄ‚NG ÄIá»‚M KHI:                                                 â”‚
â”‚  â”œâ”€â”€ Failed login: +10 points                                      â”‚
â”‚  â”œâ”€â”€ Multiple devices: +5 points                                   â”‚
â”‚  â”œâ”€â”€ Unusual hours: +3 points                                      â”‚
â”‚  â”œâ”€â”€ High order frequency: +5 points                               â”‚
â”‚  â”œâ”€â”€ Payment failures: +8 points                                   â”‚
â”‚  â”œâ”€â”€ Suspicious IP: +15 points                                     â”‚
â”‚  â””â”€â”€ Reported by other users: +20 points                           â”‚
â”‚                                                                     â”‚
â”‚  â– GIáº¢M ÄIá»‚M KHI:                                                 â”‚
â”‚  â”œâ”€â”€ Successful activities: -2 points/day                          â”‚
â”‚  â”œâ”€â”€ Long-term user: -5 points                                     â”‚
â”‚  â”œâ”€â”€ Verified account: -10 points                                  â”‚
â”‚  â””â”€â”€ Positive reviews: -3 points                                   â”‚
â”‚                                                                     â”‚
â”‚  ğŸš¨ Cáº¢NH BÃO LEVELS:                                              â”‚
â”‚  â”œâ”€â”€ 0-30: LOW (Xanh lÃ¡)                                          â”‚
â”‚  â”œâ”€â”€ 31-60: MEDIUM (VÃ ng)                                         â”‚
â”‚  â”œâ”€â”€ 61-80: HIGH (Cam)                                            â”‚
â”‚  â””â”€â”€ 81-100: CRITICAL (Äá») â†’ Auto-block                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```##
# 13.3 Monitoring Dashboard
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MONITORING DASHBOARD                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“Š Tá»”NG QUAN 24H:                                                â”‚
â”‚  â”œâ”€â”€ ğŸ‘¥ Total Users Active: 1,234                                 â”‚
â”‚  â”œâ”€â”€ ğŸš¨ New Alerts: 5 (3 Medium, 2 High)                         â”‚
â”‚  â”œâ”€â”€ ğŸ”’ Auto-blocked IPs: 12                                      â”‚
â”‚  â”œâ”€â”€ ğŸ“ˆ Risk Score Average: 23.5                                  â”‚
â”‚  â””â”€â”€ ğŸ¯ False Positive Rate: 2.1%                                 â”‚
â”‚                                                                     â”‚
â”‚  ğŸ”¥ REALTIME ALERTS:                                              â”‚
â”‚  â”œâ”€â”€ [HIGH] User #1234 - Multiple failed payments                 â”‚
â”‚  â”œâ”€â”€ [MED] IP 192.168.1.100 - Unusual activity pattern           â”‚
â”‚  â”œâ”€â”€ [HIGH] User #5678 - Risk score exceeded 75                   â”‚
â”‚  â””â”€â”€ [CRIT] IP 10.0.0.50 - Brute force detected                  â”‚
â”‚                                                                     â”‚
â”‚  ğŸ“‹ TOP RISK USERS:                                               â”‚
â”‚  â”œâ”€â”€ User #1111 (Score: 85) - Multiple violations                 â”‚
â”‚  â”œâ”€â”€ User #2222 (Score: 72) - Suspicious payment pattern         â”‚
â”‚  â”œâ”€â”€ User #3333 (Score: 68) - Unusual login times                â”‚
â”‚  â””â”€â”€ User #4444 (Score: 65) - High order frequency               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 14. LUá»’NG LOGIC CHI TIáº¾T

### 14.1 Sequence Diagram - Cáº­p Nháº­t Tráº¡ng ThÃ¡i ÄÆ¡n HÃ ng
```
Manager App    ManagerController    ManagerService    OrderService    Database
     â”‚                â”‚                   â”‚               â”‚            â”‚
     â”‚ PUT /orders/123/status?status=MAKING                â”‚            â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚               â”‚            â”‚
     â”‚                â”‚ @PreAuthorize     â”‚               â”‚            â”‚
     â”‚                â”‚ hasRole('MANAGER') â”‚               â”‚            â”‚
     â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚               â”‚            â”‚
     â”‚                â”‚                   â”‚ getCurrentManager()        â”‚
     â”‚                â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                â”‚                   â”‚               â”‚            â”‚
     â”‚                â”‚                   â”‚ getManagedStoreIds()       â”‚
     â”‚                â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                â”‚                   â”‚               â”‚            â”‚
     â”‚                â”‚                   â”‚ validateStoreAccess()      â”‚
     â”‚                â”‚                   â”‚               â”‚            â”‚
     â”‚                â”‚                   â”‚ updateOrderStatus()        â”‚
     â”‚                â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚            â”‚
     â”‚                â”‚                   â”‚               â”‚ save()     â”‚
     â”‚                â”‚                   â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                â”‚                   â”‚               â”‚            â”‚
     â”‚                â”‚                   â”‚               â”‚ notify()   â”‚
     â”‚                â”‚                   â”‚               â”‚ WebSocket  â”‚
     â”‚                â”‚                   â”‚               â”‚ Push       â”‚
     â”‚                â”‚                   â”‚               â”‚ Email      â”‚
     â”‚                â”‚ ResponseEntity    â”‚               â”‚            â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
     â”‚                â”‚                   â”‚               â”‚            â”‚
```

---

## 15. GIáº¢I THÃCH CODE

### 15.1 ManagerService - Core Business Logic

#### getCurrentManager()
```java
/**
 * Láº¥y thÃ´ng tin Manager hiá»‡n táº¡i tá»« SecurityContext
 * Sá»­ dá»¥ng findByUsernameWithManagedStores Ä‘á»ƒ eager load stores
 */
private User getCurrentManager() {
    String username = SecurityContextHolder.getContext().getAuthentication().getName();
    return userRepository.findByUsernameWithManagedStores(username)
        .orElseThrow(() -> new ResourceNotFoundException("Manager not found: " + username));
}
```

**Giáº£i thÃ­ch:**
- Láº¥y username tá»« JWT token Ä‘Ã£ Ä‘Æ°á»£c authenticate
- Sá»­ dá»¥ng custom query `findByUsernameWithManagedStores` Ä‘á»ƒ trÃ¡nh N+1 problem
- Eager load `managedStores` Ä‘á»ƒ kiá»ƒm tra quyá»n truy cáº­p store

#### getManagedStoreIds() - PhÃ¢n Quyá»n Store
```java
/**
 * Logic phÃ¢n quyá»n store quan trá»ng nháº¥t trong há»‡ thá»‘ng
 * ADMIN: return null (quáº£n lÃ½ táº¥t cáº£)
 * MANAGER cÃ³ stores: return list store IDs
 * MANAGER khÃ´ng cÃ³ stores: return empty list (khÃ´ng xem Ä‘Æ°á»£c gÃ¬)
 */
private List<Long> getManagedStoreIds(User manager) {
    // ADMIN luÃ´n quáº£n lÃ½ táº¥t cáº£
    if (manager.getRole() == UserRole.ADMIN) {
        return null; // null = xem táº¥t cáº£ stores
    }
    
    // MANAGER pháº£i cÃ³ stores Ä‘Æ°á»£c gÃ¡n
    Set<Store> managedStores = manager.getManagedStores();
    if (managedStores == null || managedStores.isEmpty()) {
        log.warn("Manager {} has no assigned stores", manager.getUsername());
        return new ArrayList<>(); // Empty list = khÃ´ng xem Ä‘Æ°á»£c gÃ¬
    }
    
    return managedStores.stream()
        .map(Store::getId)
        .collect(Collectors.toList());
}
```

**Giáº£i thÃ­ch:**
- **null**: ADMIN cÃ³ quyá»n xem táº¥t cáº£ stores
- **Empty List**: Manager chÆ°a Ä‘Æ°á»£c gÃ¡n store nÃ o â†’ Dashboard empty
- **List<Long>**: Manager chá»‰ xem Ä‘Æ°á»£c stores trong list nÃ y

#### validateStoreAccess() - Kiá»ƒm Tra Quyá»n Truy Cáº­p
```java
/**
 * Kiá»ƒm tra Manager cÃ³ quyá»n truy cáº­p store cá»¥ thá»ƒ khÃ´ng
 * ÄÆ°á»£c gá»i trÆ°á»›c má»i thao tÃ¡c liÃªn quan Ä‘áº¿n store
 */
private void validateStoreAccess(User manager, Long storeId) {
    // ADMIN cÃ³ quyá»n truy cáº­p táº¥t cáº£
    if (manager.getRole() == UserRole.ADMIN) {
        return;
    }
    
    // Sá»­ dá»¥ng method canManageStore() tá»« User entity
    if (!manager.canManageStore(storeId)) {
        log.error("Manager {} cannot access store {}. Managed stores: {}", 
            manager.getUsername(), storeId, 
            manager.getManagedStores().stream().map(Store::getId).collect(Collectors.toList()));
        throw new BusinessException("Báº¡n khÃ´ng cÃ³ quyá»n quáº£n lÃ½ Ä‘Æ¡n hÃ ng cá»§a chi nhÃ¡nh nÃ y");
    }
}
```

#### updateOrderStatus() - Cáº­p Nháº­t Tráº¡ng ThÃ¡i ÄÆ¡n HÃ ng
```java
@Transactional
public OrderDto updateOrderStatus(Long orderId, OrderStatus newStatus) {
    User manager = getCurrentManager();
    List<Long> storeIds = getManagedStoreIds(manager);
    
    log.info("=== UPDATE ORDER STATUS ===");
    log.info("Manager: {}, Role: {}", manager.getUsername(), manager.getRole());
    log.info("Order ID: {}, New Status: {}", orderId, newStatus);
    log.info("Managed Store IDs: {}", storeIds == null ? "ALL (ADMIN)" : storeIds);
    
    // Láº¥y order Ä‘á»ƒ kiá»ƒm tra quyá»n
    var order = orderRepository.findById(orderId)
        .orElseThrow(() -> new ResourceNotFoundException("Order not found: " + orderId));
    
    // Náº¿u Manager khÃ´ng cÃ³ store nÃ o â†’ khÃ´ng cÃ³ quyá»n
    if (storeIds != null && storeIds.isEmpty()) {
        throw new BusinessException("Báº¡n chÆ°a Ä‘Æ°á»£c gÃ¡n quáº£n lÃ½ chi nhÃ¡nh nÃ o");
    }
    
    // Kiá»ƒm tra quyá»n truy cáº­p store (ADMIN bá» qua)
    if (storeIds != null) {
        validateStoreAccess(manager, order.getStore().getId());
    }
    
    return orderService.updateOrderStatus(orderId, newStatus);
}
```

#### getDashboardSummary() - Dashboard Logic
```java
@Transactional(readOnly = true)
public DashboardSummaryDto getDashboardSummary() {
    User manager = getCurrentManager();
    List<Long> storeIds = getManagedStoreIds(manager);
    boolean isAdmin = manager.getRole() == UserRole.ADMIN;
    
    // Náº¿u Manager khÃ´ng cÃ³ store nÃ o â†’ tráº£ vá» empty dashboard
    if (storeIds != null && storeIds.isEmpty()) {
        log.warn("Manager {} has no assigned stores, returning empty dashboard", manager.getUsername());
        DashboardSummaryDto emptyDashboard = new DashboardSummaryDto();
        emptyDashboard.setTotalRevenue(BigDecimal.ZERO);
        // ... set all fields to 0/empty
        return emptyDashboard;
    }
    
    // Logic tÃ­nh toÃ¡n metrics khÃ¡c nhau cho ADMIN vs MANAGER
    if (storeIds == null) {
        // ADMIN - xem táº¥t cáº£ + backup revenue tá»« user Ä‘Ã£ xÃ³a
        totalRevenue = entityManager.createQuery(totalRevenueQuery, BigDecimal.class)
            .setParameter("status", OrderStatus.DONE)
            .getSingleResult();
        
        // ADMIN má»›i cá»™ng backup revenue
        BigDecimal backupRevenue = getBackupTotalRevenue();
        totalRevenue = totalRevenue.add(backupRevenue);
    } else {
        // Manager - chá»‰ xem stores Ä‘Æ°á»£c gÃ¡n (KHÃ”NG cá»™ng backup)
        totalRevenue = entityManager.createQuery(revenueQuery, BigDecimal.class)
            .setParameter("status", OrderStatus.DONE)
            .setParameter("storeIds", storeIds)
            .getSingleResult();
    }
    
    return summary;
}
```

**Key Points:**
- **ADMIN**: Xem táº¥t cáº£ + backup revenue tá»« user Ä‘Ã£ xÃ³a
- **MANAGER**: Chá»‰ xem stores Ä‘Æ°á»£c gÃ¡n, khÃ´ng cÃ³ backup
- **Empty Dashboard**: Manager chÆ°a Ä‘Æ°á»£c gÃ¡n store nÃ o

### 15.2 WhitelistIPFilter - Security Logic

#### doFilterInternal() - Main Filter Logic
```java
@Override
protected void doFilterInternal(HttpServletRequest request, 
                               HttpServletResponse response, 
                               FilterChain filterChain) throws ServletException, IOException {
    
    // 1. Kiá»ƒm tra tÃ­nh nÄƒng cÃ³ báº­t khÃ´ng
    if (!whitelistCheckEnabled) {
        filterChain.doFilter(request, response);
        return;
    }

    // 2. Láº¥y authentication tá»« SecurityContext (sau JwtAuthFilter)
    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();

    // 3. Chá»‰ Ã¡p dá»¥ng cho ADMIN/MANAGER, USER thoáº£i mÃ¡i
    if (authentication == null || !isAdminOrManager(authentication)) {
        filterChain.doFilter(request, response);
        return;
    }

    // 4. Extract IP tá»« headers
    String clientIP = getClientIP(request);
    String normalizedIP = normalizeIP(clientIP);

    // 5. Kiá»ƒm tra IP cÃ³ trong whitelist database
    if (!whitelistedIPService.isIPWhitelisted(normalizedIP)) {
        log.warn("ğŸš« WHITELIST CHECK FAILED | User: {} | Role: {} | IP: {} | Path: {}",
                authentication.getName(), getRole(authentication), clientIP, request.getRequestURI());

        response.setStatus(HttpStatus.FORBIDDEN.value());
        response.setContentType("application/json;charset=UTF-8");
        response.getWriter().write(
                "{\"success\":false,\"error\":\"IP_NOT_WHITELISTED\"," +
                "\"message\":\"IP cá»§a báº¡n chÆ°a Ä‘Æ°á»£c cáº¥p quyá»n truy cáº­p Admin/Manager\"," +
                "\"yourIP\":\"" + clientIP + "\"}"
        );
        return;
    }

    // 6. Cho phÃ©p tiáº¿p tá»¥c
    filterChain.doFilter(request, response);
}
```

#### getClientIP() - Extract Real IP
```java
/**
 * Láº¥y IP thá»±c cá»§a client, xá»­ lÃ½ proxy headers
 */
private String getClientIP(HttpServletRequest request) {
    String[] headers = {
        "X-Forwarded-For",    // Load balancer/proxy
        "X-Real-IP",          // Nginx proxy
        "Proxy-Client-IP",    // Apache proxy
        "WL-Proxy-Client-IP", // WebLogic
        "HTTP_X_FORWARDED_FOR",
        "HTTP_CLIENT_IP"
    };

    for (String header : headers) {
        String ip = request.getHeader(header);
        if (ip != null && !ip.isEmpty() && !"unknown".equalsIgnoreCase(ip)) {
            // X-Forwarded-For cÃ³ thá»ƒ chá»©a nhiá»u IP: "client, proxy1, proxy2"
            return ip.split(",")[0].trim(); // Láº¥y IP Ä‘áº§u tiÃªn (client)
        }
    }

    return request.getRemoteAddr(); // Fallback to direct connection IP
}
```

### 15.3 BlockedIPFilter - IP Blocking Logic

#### doFilterInternal() - Block Check
```java
@Override
protected void doFilterInternal(HttpServletRequest request,
                               HttpServletResponse response,
                               FilterChain filterChain) throws ServletException, IOException {

    String clientIP = getClientIP(request);
    String normalizedIP = normalizeIP(clientIP);
    
    // Check náº¿u IP bá»‹ block (kiá»ƒm tra cáº£ IP gá»‘c vÃ  normalized)
    boolean isBlocked = blockedIPService.checkAndIncrementIfBlocked(clientIP);
    
    // Náº¿u IP gá»‘c khÃ´ng bá»‹ block, kiá»ƒm tra IP normalized (IPv6 â†’ IPv4)
    if (!isBlocked && !clientIP.equals(normalizedIP)) {
        isBlocked = blockedIPService.checkAndIncrementIfBlocked(normalizedIP);
    }
    
    if (isBlocked) {
        log.warn("ğŸš« BLOCKED REQUEST | IP: {} | Path: {} | Method: {}", 
                clientIP, request.getRequestURI(), request.getMethod());

        response.setStatus(HttpStatus.FORBIDDEN.value());
        response.setContentType("application/json;charset=UTF-8");
        response.getWriter().write(
            "{\"success\":false,\"error\":\"IP_BLOCKED\"," +
            "\"message\":\"IP cá»§a báº¡n Ä‘Ã£ bá»‹ cháº·n do vi pháº¡m chÃ­nh sÃ¡ch sá»­ dá»¥ng\"," +
            "\"blockedIP\":\"" + clientIP + "\"}"
        );
        return;
    }
    
    filterChain.doFilter(request, response);
}
```

### 15.4 WhitelistedIPService - Database Operations

#### isIPWhitelisted() - Check Whitelist
```java
/**
 * Kiá»ƒm tra IP cÃ³ trong whitelist khÃ´ng
 * Sá»­ dá»¥ng custom query Ä‘á»ƒ check active whitelist
 */
public boolean isIPWhitelisted(String ipAddress) {
    if (ipAddress == null) return false;
    
    String normalizedIP = normalizeIP(ipAddress);
    return whitelistedIPRepository.isIPWhitelisted(normalizedIP);
}
```

#### addToWhitelist() - Add IP
```java
@Transactional
public WhitelistedIP addToWhitelist(String ipAddress, String description, Long addedById) {
    log.info("ğŸ”“ Adding IP to whitelist: {} by user: {}", ipAddress, addedById);

    String normalizedIP = normalizeIP(ipAddress.trim());

    // Kiá»ƒm tra Ä‘Ã£ tá»“n táº¡i chÆ°a
    if (whitelistedIPRepository.existsByIpAddress(normalizedIP)) {
        // Náº¿u inactive, kÃ­ch hoáº¡t láº¡i
        List<WhitelistedIP> all = whitelistedIPRepository.findAll();
        for (WhitelistedIP w : all) {
            if (w.getIpAddress().equals(normalizedIP)) {
                w.setIsActive(true);
                w.setDescription(description);
                w.setAddedById(addedById);
                return whitelistedIPRepository.save(w);
            }
        }
    }

    // Táº¡o má»›i
    WhitelistedIP whitelistedIP = WhitelistedIP.builder()
            .ipAddress(normalizedIP)
            .description(description)
            .addedById(addedById)
            .isActive(true)
            .build();

    return whitelistedIPRepository.save(whitelistedIP);
}
```

### 15.5 BlockedIPService - Auto Block Logic

#### blockIP() - Manual/Auto Block
```java
@Transactional
public BlockedIP blockIP(BlockIPRequest request, Long blockedById) {
    log.info("ğŸš« Blocking IP: {} by user: {} | Type: {} | Duration: {}h", 
        request.getIpAddress(), blockedById, request.getBlockType(), request.getDurationHours());
    
    String ipAddress = request.getIpAddress().trim();
    
    // Kiá»ƒm tra IP Ä‘Ã£ bá»‹ block chÆ°a
    Optional<BlockedIP> existing = blockedIPRepository.findActiveBlockedIP(ipAddress, Instant.now());
    if (existing.isPresent()) {
        throw new RuntimeException("IP nÃ y Ä‘Ã£ bá»‹ cháº·n");
    }
    
    // Validate block type vÃ  tÃ­nh thá»i gian háº¿t háº¡n
    BlockedIP.BlockType blockType = BlockedIP.BlockType.valueOf(request.getBlockType());
    
    Instant blockedUntil = null;
    if (blockType == BlockedIP.BlockType.TEMPORARY) {
        if (request.getDurationHours() <= 0) {
            throw new RuntimeException("Thá»i gian block táº¡m thá»i pháº£i lá»›n hÆ¡n 0");
        }
        blockedUntil = Instant.now().plus(request.getDurationHours(), ChronoUnit.HOURS);
    }
    
    BlockedIP blockedIP = BlockedIP.builder()
            .ipAddress(ipAddress)
            .blockType(blockType)
            .reason(request.getReason())
            .blockedById(blockedById)
            .blockedUntil(blockedUntil)
            .isActive(true)
            .relatedUserId(request.getRelatedUserId())
            .alertId(request.getAlertId())
            .blockedRequestsCount(0L)
            .build();
    
    return blockedIPRepository.save(blockedIP);
}
```

#### cleanupExpiredBlocks() - Auto Cleanup
```java
/**
 * Tá»± Ä‘á»™ng gá»¡ cháº·n cÃ¡c IP háº¿t háº¡n (cháº¡y má»—i phÃºt)
 */
@Scheduled(fixedRate = 60000)
@Transactional
public void cleanupExpiredBlocks() {
    List<BlockedIP> expired = blockedIPRepository.findExpiredBlocks(Instant.now());
    if (!expired.isEmpty()) {
        log.info("ğŸ”„ Auto-unblocking {} expired IPs", expired.size());
        expired.forEach(ip -> {
            ip.setIsActive(false);
            ip.setUnblockedAt(Instant.now());
            ip.setUnblockReason("Tá»± Ä‘á»™ng gá»¡ - Háº¿t háº¡n");
        });
        blockedIPRepository.saveAll(expired);
    }
}
```

### 15.6 Security Filter Chain Order

```java
// Thá»© tá»± cháº¡y filters (tá»« cao Ä‘áº¿n tháº¥p priority)
@Order(Ordered.HIGHEST_PRECEDENCE - 1)     // BlockedIPFilter (cháº¡y Ä‘áº§u tiÃªn)
@Order(Ordered.HIGHEST_PRECEDENCE)         // JwtAuthenticationFilter
@Order(Ordered.LOWEST_PRECEDENCE - 10)     // WhitelistIPFilter (cháº¡y cuá»‘i)
```

**Luá»“ng Security:**
1. **BlockedIPFilter**: Cháº·n IP bá»‹ block ngay láº­p tá»©c
2. **JwtAuthenticationFilter**: XÃ¡c thá»±c JWT vÃ  set SecurityContext
3. **WhitelistIPFilter**: Kiá»ƒm tra IP whitelist cho ADMIN/MANAGER

**Táº¡i sao thá»© tá»± nÃ y quan trá»ng:**
- BlockedIP pháº£i cháº¡y trÆ°á»›c Ä‘á»ƒ cháº·n IP Ä‘á»™c háº¡i
- JWT pháº£i cháº¡y trÆ°á»›c Whitelist Ä‘á»ƒ biáº¿t user role
- Whitelist cháº¡y cuá»‘i Ä‘á»ƒ kiá»ƒm tra quyá»n truy cáº­p Admin/Manager---

##
 16. API REFERENCE

### 16.1 Manager APIs

| Method | Endpoint | MÃ´ táº£ | Role |
|--------|----------|-------|------|
| GET | `/api/manager/dashboard` | Dashboard tá»•ng quan | MANAGER, ADMIN |
| GET | `/api/manager/orders` | Danh sÃ¡ch Ä‘Æ¡n hÃ ng | MANAGER, ADMIN |
| PUT | `/api/manager/orders/{id}/status` | Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng | MANAGER, ADMIN |
| GET | `/api/manager/users` | Danh sÃ¡ch ngÆ°á»i dÃ¹ng | MANAGER, ADMIN |
| PUT | `/api/manager/users/{id}/block` | KhÃ³a/má»Ÿ khÃ³a user | MANAGER, ADMIN |
| PUT | `/api/manager/users/{id}/promote` | NÃ¢ng cáº¥p User â†’ Manager | ADMIN |
| POST | `/api/manager/users/{id}/stores/{storeId}` | GÃ¡n store cho Manager | ADMIN |

### 16.2 Product Management APIs

| Method | Endpoint | MÃ´ táº£ | Role |
|--------|----------|-------|------|
| GET | `/api/drinks` | Danh sÃ¡ch sáº£n pháº©m | MANAGER, ADMIN |
| POST | `/api/drinks` | Táº¡o sáº£n pháº©m má»›i | MANAGER, ADMIN |
| PUT | `/api/drinks/{id}` | Cáº­p nháº­t sáº£n pháº©m | MANAGER, ADMIN |
| DELETE | `/api/drinks/{id}` | XÃ³a sáº£n pháº©m | MANAGER, ADMIN |
| POST | `/api/drinks/{id}/image` | Upload hÃ¬nh áº£nh | MANAGER, ADMIN |
| GET | `/api/categories` | Danh sÃ¡ch danh má»¥c | ALL |
| POST | `/api/categories` | Táº¡o danh má»¥c | ADMIN |

### 16.3 Voucher Management APIs

| Method | Endpoint | MÃ´ táº£ | Role |
|--------|----------|-------|------|
| GET | `/api/promotions` | Danh sÃ¡ch voucher | MANAGER, ADMIN |
| POST | `/api/promotions` | Táº¡o voucher má»›i | MANAGER, ADMIN |
| PUT | `/api/promotions/{id}` | Cáº­p nháº­t voucher | MANAGER, ADMIN |
| DELETE | `/api/promotions/{id}` | XÃ³a voucher | MANAGER, ADMIN |
| GET | `/api/promotions/{id}/usage` | Thá»‘ng kÃª sá»­ dá»¥ng voucher | MANAGER, ADMIN |
| POST | `/api/promotions/validate` | Validate mÃ£ voucher | USER |

### 16.4 Live Chat APIs

| Method | Endpoint | MÃ´ táº£ | Role |
|--------|----------|-------|------|
| GET | `/api/chat/conversations` | Danh sÃ¡ch cuá»™c há»™i thoáº¡i | MANAGER, ADMIN |
| POST | `/api/chat/conversations` | Táº¡o cuá»™c há»™i thoáº¡i má»›i | USER |
| GET | `/api/chat/conversations/{id}/messages` | Lá»‹ch sá»­ tin nháº¯n | ALL |
| POST | `/api/chat/messages` | Gá»­i tin nháº¯n | ALL |
| PUT | `/api/chat/conversations/{id}/close` | ÄÃ³ng cuá»™c há»™i thoáº¡i | MANAGER, ADMIN |

### 16.5 Security APIs

| Method | Endpoint | MÃ´ táº£ | Role |
|--------|----------|-------|------|
| GET | `/api/whitelist-ips` | Danh sÃ¡ch Whitelist IP | ADMIN |
| POST | `/api/whitelist-ips` | ThÃªm IP vÃ o whitelist | ADMIN |
| DELETE | `/api/whitelist-ips/{id}` | XÃ³a IP khá»i whitelist | ADMIN |
| GET | `/api/blocked-ips` | Danh sÃ¡ch Blocked IP | ADMIN |
| POST | `/api/blocked-ips` | Cháº·n IP thá»§ cÃ´ng | ADMIN |
| DELETE | `/api/blocked-ips/{id}` | Bá» cháº·n IP | ADMIN |

### 16.6 Monitoring APIs

| Method | Endpoint | MÃ´ táº£ | Role |
|--------|----------|-------|------|
| GET | `/api/monitoring/dashboard` | Dashboard giÃ¡m sÃ¡t | ADMIN |
| GET | `/api/monitoring/activities` | Log hoáº¡t Ä‘á»™ng | ADMIN |
| GET | `/api/monitoring/alerts` | Danh sÃ¡ch cáº£nh bÃ¡o | ADMIN |
| PUT | `/api/monitoring/alerts/{id}/handle` | Xá»­ lÃ½ cáº£nh bÃ¡o | ADMIN |
| GET | `/api/monitoring/risk-scores` | Äiá»ƒm rá»§i ro users | ADMIN |

---

## 17. CÃ‚U Há»I PHá»NG Váº¤N

### 17.1 CÃ¢u Há»i CÆ¡ Báº£n

**Q1: Giáº£i thÃ­ch luá»“ng cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng trong há»‡ thá»‘ng?**

**A1:** Luá»“ng bao gá»“m cÃ¡c bÆ°á»›c:
1. Manager gá»­i PUT request vá»›i JWT token
2. Security filters kiá»ƒm tra: BlockedIP â†’ JWT Auth â†’ WhitelistIP
3. ManagerController validate input vÃ  gá»i ManagerService
4. ManagerService kiá»ƒm tra quyá»n truy cáº­p store cá»§a Manager
5. OrderService validate transition vÃ  cáº­p nháº­t database
6. Gá»­i notifications qua WebSocket, Push, Email

**Q2: PhÃ¢n biá»‡t quyá»n háº¡n giá»¯a ADMIN vÃ  MANAGER?**

**A2:**
- **ADMIN**: Quáº£n lÃ½ toÃ n há»‡ thá»‘ng, táº¥t cáº£ stores, táº¡o/xÃ³a Manager, quáº£n lÃ½ IP security
- **MANAGER**: Chá»‰ quáº£n lÃ½ stores Ä‘Æ°á»£c gÃ¡n, khÃ´ng thá»ƒ khÃ³a Manager khÃ¡c, khÃ´ng cÃ³ quyá»n security

**Q3: Whitelist IP hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o?**

**A3:** 
- Filter kiá»ƒm tra role user tá»« JWT
- Chá»‰ Ã¡p dá»¥ng cho MANAGER/ADMIN
- Extract IP tá»« headers (X-Forwarded-For, X-Real-IP)
- Query database kiá»ƒm tra IP cÃ³ trong whitelist
- Tráº£ vá» 403 náº¿u IP khÃ´ng Ä‘Æ°á»£c phÃ©p

### 17.2 CÃ¢u Há»i NÃ¢ng Cao

**Q4: LÃ m tháº¿ nÃ o Ä‘á»ƒ tá»‘i Æ°u performance cho Dashboard API khi cÃ³ nhiá»u stores?**

**A4:**
- Sá»­ dá»¥ng parallel queries vá»›i CompletableFuture
- Cache káº¿t quáº£ vá»›i Redis (TTL 5-10 phÃºt)
- Database indexing trÃªn store_id, created_at
- Pagination cho large datasets
- Aggregate queries thay vÃ¬ multiple single queries

**Q5: Giáº£i thÃ­ch thuáº­t toÃ¡n Risk Score calculation?**

**A5:**
- Base score = 0, tÄƒng/giáº£m theo activities
- Failed login +10, successful activities -2/day
- Weighted recent activities (7 ngÃ y gáº§n Ä‘Ã¢y cÃ³ trá»ng sá»‘ cao)
- External factors: IP reputation, device fingerprint
- Auto-block khi score > 80, alert khi > 60

**Q6: Xá»­ lÃ½ race condition khi multiple Managers cáº­p nháº­t cÃ¹ng 1 Ä‘Æ¡n hÃ ng?**

**A6:**
- Database-level locking vá»›i SELECT FOR UPDATE
- Optimistic locking vá»›i version field
- Retry mechanism vá»›i exponential backoff
- Event sourcing Ä‘á»ƒ track all state changes
- WebSocket broadcast Ä‘á»ƒ sync realtime

**Q7: Scaling strategy cho Live Chat system?**

**A7:**
- WebSocket clustering vá»›i Redis pub/sub
- Message queue (RabbitMQ) cho reliable delivery
- Database sharding theo conversation_id
- CDN cho file/image sharing
- Auto-scaling based on concurrent connections